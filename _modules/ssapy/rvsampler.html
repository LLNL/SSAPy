

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ssapy.rvsampler &mdash; SSAPy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
    <link rel="shortcut icon" href="../../_static/ssapy_logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/ssapy_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">SSAPy by Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks.html">SSAPy Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">SSAPy Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API DOCS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SSAPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ssapy.rvsampler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ssapy.rvsampler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; This module provides functions and classes for orbital mechanics calculations, optimization techniques, sampling methods, and orbital parameter translations. &quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.orbit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Orbit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.propagator</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeplerianPropagator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.compute</span><span class="w"> </span><span class="kn">import</span> <span class="n">dircos</span><span class="p">,</span> <span class="n">radec</span><span class="p">,</span> <span class="n">radec</span><span class="p">,</span> <span class="n">radecRateObsToRV</span><span class="p">,</span> <span class="n">rvObsToRaDecRate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">normed</span><span class="p">,</span> <span class="n">normSq</span><span class="p">,</span> <span class="n">cluster_emcee_walkers</span><span class="p">,</span> <span class="n">unitAngle3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">RGEO</span><span class="p">,</span> <span class="n">VGEO</span><span class="p">,</span> <span class="n">WGS84_EARTH_MU</span>


<span class="c1"># Priors</span>
<div class="viewcode-block" id="RPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RPrior.html#ssapy.rvsampler.RPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">RPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on distance from origin |r|.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rmean : float</span>
<span class="sd">        Prior mean on |r| in meters.</span>
<span class="sd">    rsigma : float</span>
<span class="sd">        Prior standard deviation on |r| in meters.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rMean</span>
<span class="sd">    rSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmean</span><span class="p">,</span> <span class="n">rsigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmean</span> <span class="o">=</span> <span class="n">rmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsigma</span> <span class="o">=</span> <span class="n">rsigma</span>

<div class="viewcode-block" id="RPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RPrior.html#ssapy.rvsampler.RPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance: float, optional</span>
<span class="sd">            Distance between object and observer (m) [not used]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmean</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rsigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="VPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.VPrior.html#ssapy.rvsampler.VPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">VPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on velocity magnitude |v|.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vmean : float</span>
<span class="sd">        Prior mean on |v| in meters per second.</span>
<span class="sd">    vsigma : float</span>
<span class="sd">        Prior standard deviation on |v| in meters per second.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    vMean</span>
<span class="sd">    vSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vsigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmean</span> <span class="o">=</span> <span class="n">vmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsigma</span> <span class="o">=</span> <span class="n">vsigma</span>

<div class="viewcode-block" id="VPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.VPrior.html#ssapy.rvsampler.VPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance: float, optional</span>
<span class="sd">            Distance between object and observer (m) [not used]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmean</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vsigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="APrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.APrior.html#ssapy.rvsampler.APrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">APrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on orbit semimajor axis a.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    amean : float</span>
<span class="sd">        Prior mean on a in meters.</span>
<span class="sd">    asigma : float</span>
<span class="sd">        Prior standard deviation on a in meters.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    aMean</span>
<span class="sd">    aSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amean</span><span class="p">,</span> <span class="n">asigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amean</span> <span class="o">=</span> <span class="n">amean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asigma</span> <span class="o">=</span> <span class="n">asigma</span>

<div class="viewcode-block" id="APrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.APrior.html#ssapy.rvsampler.APrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance: float, optional</span>
<span class="sd">            Distance between object and observer (m) [not used]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">amean</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">asigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="EPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EPrior.html#ssapy.rvsampler.EPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on orbit eccentricity e.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    emean : float</span>
<span class="sd">        Prior mean on e.</span>
<span class="sd">    esigma : float</span>
<span class="sd">        Prior standard deviation on e.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    eMean</span>
<span class="sd">    eSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emean</span><span class="p">,</span> <span class="n">esigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emean</span> <span class="o">=</span> <span class="n">emean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esigma</span> <span class="o">=</span> <span class="n">esigma</span>

<div class="viewcode-block" id="EPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EPrior.html#ssapy.rvsampler.EPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance: float, optional</span>
<span class="sd">            Distance between object and observer (m) [not used]</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If true, return chi rather than ln(prob)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">emean</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">esigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="EquinoctialExEyPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EquinoctialExEyPrior.html#ssapy.rvsampler.EquinoctialExEyPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EquinoctialExEyPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on equinoctial ex and ey, favoring ex = ey = 0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma : float</span>
<span class="sd">        standard deviation on ex and ey</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

<div class="viewcode-block" id="EquinoctialExEyPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EquinoctialExEyPrior.html#ssapy.rvsampler.EquinoctialExEyPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance : float</span>
<span class="sd">            Distance between object and observer (m)</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">orbit</span><span class="o">.</span><span class="n">ex</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">ey</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="Log10AreaPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.Log10AreaPrior.html#ssapy.rvsampler.Log10AreaPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Log10AreaPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on log10(area) of object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : float</span>
<span class="sd">        mean of log10(area)</span>
<span class="sd">    sigma : float</span>
<span class="sd">        standard deviation of log10(area)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mean, sigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

<div class="viewcode-block" id="Log10AreaPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.Log10AreaPrior.html#ssapy.rvsampler.Log10AreaPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance : float</span>
<span class="sd">            Distance between object and observer (m)</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="AreaPrior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.AreaPrior.html#ssapy.rvsampler.AreaPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AreaPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on log10(area) of object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : float</span>
<span class="sd">        mean of log10(area)</span>
<span class="sd">    sigma : float</span>
<span class="sd">        standard deviation of log10(area)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mean, sigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

<div class="viewcode-block" id="AreaPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.AreaPrior.html#ssapy.rvsampler.AreaPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance : float</span>
<span class="sd">            Distance between object and observer (m)</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span> <span class="k">if</span> <span class="n">chi</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<span class="c1"># Stolen from emcee.utils  Was deprecated in emcee version 3, so</span>
<span class="c1"># reimplementing here.</span>
<div class="viewcode-block" id="sample_ball"><a class="viewcode-back" href="../../api/ssapy.rvsampler.sample_ball.html#ssapy.rvsampler.sample_ball">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">sample_ball</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">nSample</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a ball of walkers around an initial parameter value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p0 : array_like, (d,)</span>
<span class="sd">        Central parameter values.</span>
<span class="sd">    std : array_like, (d,)</span>
<span class="sd">        Axis-aligned standard deviations.</span>
<span class="sd">    nSample : int, optional</span>
<span class="sd">        The number of samples to produce.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    samples : array_like (nSample, d)</span>
<span class="sd">        The samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">std</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">p0</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nSample</span><span class="p">)])</span></div>


<div class="viewcode-block" id="GEOProjectionInitializer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.GEOProjectionInitializer.html#ssapy.rvsampler.GEOProjectionInitializer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GEOProjectionInitializer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize position and velocity samples by projecting an observed ra/dec</span>
<span class="sd">    into the equatorial plane and assuming a GEO statationary orbital velocity.</span>
<span class="sd">    Samples are dispersed from this given position and velocity using an</span>
<span class="sd">    isotropic Gaussian distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : QTable with columns for &#39;ra&#39;, &#39;dec&#39;, &#39;rStation_GCRF&#39;.</span>
<span class="sd">        The set of observations used to initialize samples.  Note, only the</span>
<span class="sd">        first row of the given QTable will be used.</span>
<span class="sd">    rSigma : float, optional</span>
<span class="sd">        Standard deviation of sample positions dispersion in meters.</span>
<span class="sd">    vSigma : float, optional</span>
<span class="sd">        Standard deviation of sample velocity dispersion in meters per second.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rSigma</span>
<span class="sd">    vSigma</span>
<span class="sd">    observation : QTable</span>
<span class="sd">        First row of input arc.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(nSample)</span>
<span class="sd">        Returns `nSample` initial samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="n">rSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">RGEO</span><span class="p">,</span> <span class="n">vSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">VGEO</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span> <span class="o">=</span> <span class="n">rSigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span> <span class="o">=</span> <span class="n">vSigma</span>

<div class="viewcode-block" id="GEOProjectionInitializer.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.GEOProjectionInitializer.html#ssapy.rvsampler.GEOProjectionInitializer.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nSample : int</span>
<span class="sd">            Number of samples to return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        samples : array_like, (nSample, 6)</span>
<span class="sd">            Generated samples.  Columns are [x, y, z, vx, vy, vz].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

        <span class="c1"># Only use the first observation</span>
        <span class="n">rStation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
        <span class="n">sdec</span><span class="p">,</span> <span class="n">cdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">sra</span><span class="p">,</span> <span class="n">cra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">lineOfSight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cdec</span><span class="o">*</span><span class="n">cra</span><span class="p">,</span> <span class="n">cdec</span><span class="o">*</span><span class="n">sra</span><span class="p">,</span> <span class="n">sdec</span><span class="p">])</span>

        <span class="nb">range</span> <span class="o">=</span> <span class="o">-</span><span class="n">rStation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">lineOfSight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rGuess</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">lineOfSight</span> <span class="o">*</span> <span class="nb">range</span>
        <span class="n">zhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
        <span class="n">vGuess</span> <span class="o">=</span> <span class="n">VGEO</span><span class="o">*</span><span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zhat</span><span class="p">,</span> <span class="n">rGuess</span><span class="p">))</span>

        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">rGuess</span><span class="p">,</span> <span class="n">vGuess</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_ball</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span><span class="p">],</span> <span class="n">nSample</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DistanceProjectionInitializer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.DistanceProjectionInitializer.html#ssapy.rvsampler.DistanceProjectionInitializer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">DistanceProjectionInitializer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize position and velocity from two closely spaced (in time)</span>
<span class="sd">    observations of ra/dec.  The position is initialized by projecting along the</span>
<span class="sd">    direction of the first observation a given slant range.  The velocity is</span>
<span class="sd">    then initialized assuming that the slant range derivative is zero, and that</span>
<span class="sd">    the motion in between observations is inertial.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : QTable with columns for &#39;ra&#39;, &#39;dec&#39;, &#39;rStation_GCRF&#39;.</span>
<span class="sd">        The set of observations used to initialize samples.  Note, only the</span>
<span class="sd">        first row of the given QTable will be used.</span>
<span class="sd">    rho : Distance in meters to project, measured from the position of the</span>
<span class="sd">        observer (not the center of the Earth).</span>
<span class="sd">    indices : list of indices indicating which two observations in `arc` to use</span>
<span class="sd">        for initialization.  Default: [0, 1]; i.e., use the first two</span>
<span class="sd">        observations.</span>
<span class="sd">    rSigma : float, optional</span>
<span class="sd">        Standard deviation of sample positions dispersion in meters.</span>
<span class="sd">    vSigma : float, optional</span>
<span class="sd">        Standard deviation of sample velocity dispersion in meters per second.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    observations : QTable</span>
<span class="sd">        Indicated two rows of the input arc.</span>
<span class="sd">    rho</span>
<span class="sd">    rSigma</span>
<span class="sd">    vSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(nSample)</span>
<span class="sd">        Returns `nSample` initial samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">RGEO</span><span class="p">,</span> <span class="n">vSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">VGEO</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span> <span class="o">=</span> <span class="n">rSigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span> <span class="o">=</span> <span class="n">vSigma</span>

<div class="viewcode-block" id="DistanceProjectionInitializer.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.DistanceProjectionInitializer.html#ssapy.rvsampler.DistanceProjectionInitializer.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSample</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

        <span class="n">rStation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
        <span class="n">sra</span><span class="p">,</span> <span class="n">cra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">sdec</span><span class="p">,</span> <span class="n">cdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">lineOfSight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cdec</span><span class="o">*</span><span class="n">cra</span><span class="p">,</span> <span class="n">cdec</span><span class="o">*</span><span class="n">sra</span><span class="p">,</span> <span class="n">sdec</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">rGuess</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">lineOfSight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vGuess</span> <span class="o">=</span> <span class="p">(</span><span class="n">rGuess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rGuess</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dt</span>

        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">rGuess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vGuess</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_ball</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span><span class="p">],</span> <span class="n">nSample</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="circular_guess"><a class="viewcode-back" href="../../api/ssapy.rvsampler.circular_guess.html#ssapy.rvsampler.circular_guess">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">circular_guess</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guess position and velocity from two closely spaced (in time)</span>
<span class="sd">    observations of ra/dec.</span>

<span class="sd">    The state is inferred by finding the circular orbit passing</span>
<span class="sd">    through the two points, assuming the motion in between the</span>
<span class="sd">    observations is inertial.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : QTable with columns for &#39;ra&#39;, &#39;dec&#39;, &#39;rStation_GCRF&#39;.</span>
<span class="sd">        The set of observations used to make the guess.  Note, only indices</span>
<span class="sd">        rows of the given QTable will be used.</span>
<span class="sd">    indices : list of indices indicating which two observations in `arc` to use</span>
<span class="sd">        for initialization.  Default: [0, 1]; i.e., use the first two</span>
<span class="sd">        observations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    state: array_like, (6,)</span>
<span class="sd">        state corresponding to orbit passing through points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

    <span class="n">usepm</span> <span class="o">=</span> <span class="s1">&#39;pmra&#39;</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">usepm</span><span class="p">:</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">arc</span>
    <span class="n">rStation</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
    <span class="n">sra</span><span class="p">,</span> <span class="n">cra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">sdec</span><span class="p">,</span> <span class="n">cdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">lineOfSighta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cdec</span><span class="o">*</span><span class="n">cra</span><span class="p">,</span> <span class="n">cdec</span><span class="o">*</span><span class="n">sra</span><span class="p">,</span> <span class="n">sdec</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">usepm</span><span class="p">:</span>
        <span class="n">lineOfSight</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">lineOfSighta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lineOfSighta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lineOfSight</span> <span class="o">=</span> <span class="n">lineOfSighta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">rAlpha</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zhat</span><span class="p">,</span> <span class="n">lineOfSight</span><span class="p">))</span>
    <span class="n">rDelta</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">lineOfSight</span><span class="p">,</span> <span class="n">rAlpha</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">usepm</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="c1"># something horribly wrong in this case;</span>
            <span class="c1"># okay to have really bad guess?</span>
        <span class="n">muAlpha</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                   <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">cdec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">dt</span>
        <span class="n">muDelta</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">dt</span>
        <span class="n">vGround</span> <span class="o">=</span> <span class="p">(</span><span class="n">rStation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rStation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">dt</span>
        <span class="n">rStation</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">rStation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rStation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">muAlpha</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">muDelta</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vGround</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rStation</span> <span class="o">=</span> <span class="n">rStation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vGroundSky</span> <span class="o">=</span> <span class="n">vGround</span><span class="o">-</span><span class="n">lineOfSight</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lineOfSight</span><span class="p">,</span> <span class="n">vGround</span><span class="p">)</span>

    <span class="c1"># gives the geocentric radial velocity as a function of range, assuming</span>
    <span class="c1"># a circular orbit, so v^2/R = GM/R^2</span>
    <span class="c1"># the zero of this is the distance at which the object would be on a</span>
    <span class="c1"># circular orbit.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vr2</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the radial velocity difference based on the provided position vector.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        r : numpy.ndarray</span>
<span class="sd">            A position vector representing the relative location along the line of sight.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The calculated radial velocity difference based on the Earth&#39;s gravitational constant,</span>
<span class="sd">            position, and velocity components.</span>

<span class="sd">        Example:</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; r = np.array([1.0, 2.0, 3.0])</span>
<span class="sd">        &gt;&gt;&gt; vr2(r)</span>
<span class="sd">        -12345.678  # Example output (depends on global variable values)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">lineOfSight</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pos</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">WGS84_EARTH_MU</span><span class="o">/</span><span class="n">R</span> <span class="o">-</span> <span class="n">normSq</span><span class="p">(</span><span class="n">muAlpha</span><span class="o">*</span><span class="n">rAlpha</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">muDelta</span><span class="o">*</span><span class="n">rDelta</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span>
                                         <span class="n">vGroundSky</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vR</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the radial velocity at a given position along the line of sight, </span>
<span class="sd">        with optional bounds and verbosity.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        r : float</span>
<span class="sd">            The position along the line of sight.</span>
<span class="sd">        ub : float, optional</span>
<span class="sd">            Upper bound for the position `r`. If `r` exceeds this bound, it is reflected </span>
<span class="sd">            back within the bounds. Default is `np.inf` (no bound).</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If `True`, additional information may be printed during execution. </span>
<span class="sd">            Default is `False`.</span>
<span class="sd">        square : bool, optional</span>
<span class="sd">            If `True`, the squared radial velocity (`vrsquared`) is returned instead </span>
<span class="sd">            of the computed radial velocity. Default is `False`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The computed radial velocity at the given position `r`. If `square=True`, </span>
<span class="sd">            the squared radial velocity is returned instead.</span>

<span class="sd">        Example:</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; r = 5.0</span>
<span class="sd">        &gt;&gt;&gt; vR(r, ub=10.0, verbose=True, square=False)</span>
<span class="sd">        123.456  # Example output (depends on global variable values)</span>

<span class="sd">        &gt;&gt;&gt; vR(r, ub=10.0, square=True)</span>
<span class="sd">        15234.789  # Example squared radial velocity output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">:</span>
            <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ub</span> <span class="o">-</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sgn</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">lineOfSight</span>
        <span class="n">vrsquared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">vr2</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normed</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">sgn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vrsquared</span><span class="p">)</span><span class="o">*</span><span class="n">lineOfSight</span> <span class="o">+</span>
                      <span class="n">muAlpha</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">rAlpha</span> <span class="o">+</span>
                      <span class="n">muDelta</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">rDelta</span> <span class="o">+</span> <span class="n">vGroundSky</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">root</span><span class="p">,</span> <span class="n">root_scalar</span><span class="p">,</span> <span class="n">leastsq</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

    <span class="n">vr2near</span> <span class="o">=</span> <span class="n">vr2</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vr2far</span> <span class="o">=</span> <span class="n">vr2</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">RGEO</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vr2near</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vr2far</span><span class="p">):</span>
        <span class="c1"># no circular solution.</span>
        <span class="c1"># must be space observer?</span>
        <span class="c1"># we should take a very close distance and return it as a best fit.</span>
        <span class="c1"># e.g., 200 km (?), v_los = 0?</span>
        <span class="n">rRange</span> <span class="o">=</span> <span class="mi">200000</span>
        <span class="n">rGuess</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">rRange</span><span class="o">*</span><span class="n">lineOfSight</span>
        <span class="n">vGuess</span> <span class="o">=</span> <span class="n">muAlpha</span><span class="o">*</span><span class="n">rRange</span><span class="o">*</span><span class="n">rAlpha</span> <span class="o">+</span> <span class="n">muDelta</span><span class="o">*</span><span class="n">rRange</span><span class="o">*</span><span class="n">rDelta</span> <span class="o">+</span> <span class="n">vGroundSky</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rGuess</span><span class="p">,</span> <span class="n">vGuess</span><span class="p">]),</span> <span class="n">epoch</span>
    <span class="n">resub</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span><span class="n">vr2</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">RGEO</span><span class="p">])</span>
    <span class="n">sol</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span>
        <span class="n">vR</span><span class="p">,</span> <span class="n">resub</span><span class="o">.</span><span class="n">root</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">resub</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sol</span> <span class="o">&gt;</span> <span class="n">resub</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">resub</span><span class="o">.</span><span class="n">root</span> <span class="o">-</span> <span class="n">sol</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">sol</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">:</span>
        <span class="n">rRange</span> <span class="o">=</span> <span class="mi">200000</span>
        <span class="n">rGuess</span> <span class="o">=</span> <span class="n">rStation</span> <span class="o">+</span> <span class="n">rRange</span><span class="o">*</span><span class="n">lineOfSight</span>
        <span class="n">vGuess</span> <span class="o">=</span> <span class="n">muAlpha</span><span class="o">*</span><span class="n">rRange</span><span class="o">*</span><span class="n">rAlpha</span> <span class="o">+</span> <span class="n">muDelta</span><span class="o">*</span><span class="n">rRange</span><span class="o">*</span><span class="n">rDelta</span> <span class="o">+</span> <span class="n">vGroundSky</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rGuess</span><span class="p">,</span> <span class="n">vGuess</span><span class="p">]),</span> <span class="n">epoch</span>
    <span class="n">rRange</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vlos</span> <span class="o">=</span> <span class="n">sgn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vr2</span><span class="p">(</span><span class="n">rRange</span><span class="p">))</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">ssapy.utils</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unit_to_lb</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lineOfSight</span><span class="p">]))</span>
    <span class="n">rGuess</span><span class="p">,</span> <span class="n">vGuess</span> <span class="o">=</span> <span class="n">radecRateObsToRV</span><span class="p">(</span>
        <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rRange</span><span class="p">,</span> <span class="n">muAlpha</span><span class="p">,</span> <span class="n">muDelta</span><span class="p">,</span> <span class="n">vlos</span><span class="p">,</span> <span class="n">rStation</span><span class="p">,</span> <span class="n">vGroundSky</span><span class="p">)</span>
    <span class="c1"># ignores light-time correction, etc.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rGuess</span><span class="o">+</span><span class="n">vGuess</span><span class="p">)):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rGuess</span><span class="p">,</span> <span class="n">vGuess</span><span class="p">]),</span> <span class="n">epoch</span></div>


<div class="viewcode-block" id="GaussianRVInitializer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.GaussianRVInitializer.html#ssapy.rvsampler.GaussianRVInitializer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GaussianRVInitializer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate position and velocity samples as an isotropic Gaussian</span>
<span class="sd">    distribution around an asserted position and velocity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rMean : array_like (3,)</span>
<span class="sd">        Mean of sample positions in meters.</span>
<span class="sd">    vMean : array_like (3,)</span>
<span class="sd">        Mean of sample velocities in meters per second.</span>
<span class="sd">    rSigma : float, optional</span>
<span class="sd">        Standard deviation of sample positions dispersion in meters.</span>
<span class="sd">    vSigma : float, optional</span>
<span class="sd">        Standard deviation of sample velocity dispersion in meters per second.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rMean</span>
<span class="sd">    vMean</span>
<span class="sd">    rSigma</span>
<span class="sd">    vSigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(nSample)</span>
<span class="sd">        Returns `nSample` initial samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rMean</span><span class="p">,</span> <span class="n">vMean</span><span class="p">,</span> <span class="n">rSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">RGEO</span><span class="p">,</span> <span class="n">vSigma</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">VGEO</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rMean</span> <span class="o">=</span> <span class="n">rMean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span> <span class="o">=</span> <span class="n">rSigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vMean</span> <span class="o">=</span> <span class="n">vMean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span> <span class="o">=</span> <span class="n">vSigma</span>

<div class="viewcode-block" id="GaussianRVInitializer.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.GaussianRVInitializer.html#ssapy.rvsampler.GaussianRVInitializer.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate initial samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nSample : int</span>
<span class="sd">            Number of samples to return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        samples : array_like, (nSample, 6)</span>
<span class="sd">            Generated samples.  Columns are [x, y, z, vx, vy, vz].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rMean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vMean</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_ball</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rSigma</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vSigma</span><span class="p">],</span> <span class="n">nSample</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DirectInitializer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.DirectInitializer.html#ssapy.rvsampler.DirectInitializer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">DirectInitializer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Directly specify initial position and velocity samples.  This can be</span>
<span class="sd">    useful if restarting sampling after some previous sampling step has</span>
<span class="sd">    completed, for instance, if adding new observations to a previously sampled</span>
<span class="sd">    arc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    samples : array_like (nSample, 6)</span>
<span class="sd">        Samples in position (in meters) and velocity (in meters per second).</span>
<span class="sd">        Columns are [x, y, z, vx, vy, vz].</span>
<span class="sd">    replace : bool, optional</span>
<span class="sd">        Whether to sample with or without replacement.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    samples</span>
<span class="sd">    replace</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(nSample)</span>
<span class="sd">        Returns `nSample` initial samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace</span>

<div class="viewcode-block" id="DirectInitializer.__call__"><a class="viewcode-back" href="../../api/ssapy.rvsampler.DirectInitializer.html#ssapy.rvsampler.DirectInitializer.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSample</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nSample : int</span>
<span class="sd">            Number of samples to return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        samples : array_like, (nSample, 6)</span>
<span class="sd">            Generated samples.  Columns are [x, y, z, vx, vy, vz].</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If self.replace=False and nSample is greater than the number of input</span>
<span class="sd">        samples, then some samples will be duplicated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span> <span class="ow">and</span> <span class="n">nSample</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span><span class="p">:</span>
            <span class="n">nTile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nSample</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span><span class="p">)</span>
            <span class="n">nDone</span> <span class="o">=</span> <span class="n">nTile</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">nTile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nSample</span> <span class="o">&gt;</span> <span class="n">nDone</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nSample</span><span class="o">-</span><span class="n">nDone</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">more</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">out</span><span class="p">,</span> <span class="n">more</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nAvailable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nSample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replace</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">w</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="RVProbability"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVProbability.html#ssapy.rvsampler.RVProbability">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">RVProbability</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to manage MCMC sampling of orbits (parameterized by position and</span>
<span class="sd">    velocity at a given epoch) given some angular observations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : QTable with one row per observation and columns:</span>
<span class="sd">            &#39;ra&#39;, &#39;dec&#39; : Angle</span>
<span class="sd">                Observed angular position in ICRS (topocentric).</span>
<span class="sd">            &#39;rStation_GCRF&#39; : Quantity</span>
<span class="sd">                Position of observer in GCRF.</span>
<span class="sd">            &#39;sigma&#39; : Quantity</span>
<span class="sd">                Isotropic uncertainty in observed angular position.</span>
<span class="sd">            &#39;time&#39; : float or astropy.time.Time</span>
<span class="sd">                Time of observation.  If float, then should correspond to GPS</span>
<span class="sd">                seconds; i.e., seconds since 1980-01-06 00:00:00 UTC</span>
<span class="sd">        The arc is a linked set of observations assumed to be of the same</span>
<span class="sd">        object.</span>
<span class="sd">    epoch : float or astropy.time.Time</span>
<span class="sd">        The time at which the model parameters (position and velocity) are</span>
<span class="sd">        specified.  It probably makes sense to make this the same as one of the</span>
<span class="sd">        observation times, but it&#39;s not required to be.  If float, then should</span>
<span class="sd">        correspond to GPS seconds; i.e., seconds since 1980-01-06 00:00:00 UTC</span>
<span class="sd">    priors : list of priors, optional</span>
<span class="sd">        A list of class instances similar to RPrior() or APrior() to apply</span>
<span class="sd">        jointly to the posterior probability.</span>
<span class="sd">    propagator : class, optional</span>
<span class="sd">        The propagator class to use.</span>
<span class="sd">    meanpm : bool</span>
<span class="sd">        fit model to mean positions and proper motions rather than to</span>
<span class="sd">        individual epochs along each streak.</span>
<span class="sd">    damp : float</span>
<span class="sd">        damp chi residuals with pseudo-Huber loss function.  Default -1: do</span>
<span class="sd">        not damp.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    arc</span>
<span class="sd">    epoch</span>
<span class="sd">    priors</span>
<span class="sd">    propagator</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    lnlike(orbit)</span>
<span class="sd">        Calculate log likelihood of observations given orbit.</span>
<span class="sd">    lnprob(p)</span>
<span class="sd">        Calculate log posterior probability of orbit parameters p given</span>
<span class="sd">        observations (up to a constant).  Parameters p are [x, y, z, vx, vy, vz]</span>
<span class="sd">        at epoch.</span>
<span class="sd">    __call__(p)</span>
<span class="sd">        Alias for lnprob(p)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span>
                 <span class="n">priors</span><span class="o">=</span><span class="p">[</span><span class="n">RPrior</span><span class="p">(</span><span class="n">RGEO</span><span class="p">,</span> <span class="n">RGEO</span><span class="o">*</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">APrior</span><span class="p">(</span><span class="n">RGEO</span><span class="p">,</span> <span class="n">RGEO</span><span class="o">*</span><span class="mf">0.2</span><span class="p">)],</span>
                 <span class="n">propagator</span><span class="o">=</span><span class="n">KeplerianPropagator</span><span class="p">(),</span>
                 <span class="n">meanpm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">damp</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">Time</span><span class="p">):</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">gps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="n">arc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="o">=</span> <span class="n">propagator</span>

        <span class="c1"># Convert Quantities to plain arrays now so conversions don&#39;t slow us</span>
        <span class="c1"># down during sampling.</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sdec</span><span class="p">,</span> <span class="n">cdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sra</span><span class="p">,</span> <span class="n">cra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># line-of-sight calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_los</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">cdec</span><span class="o">*</span><span class="n">cra</span><span class="p">,</span> <span class="n">cdec</span><span class="o">*</span><span class="n">sra</span><span class="p">,</span> <span class="n">sdec</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rStation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vStation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanpm</span> <span class="o">=</span> <span class="n">meanpm</span>
        <span class="k">if</span> <span class="n">meanpm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pmra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pmdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pmraSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pmdecSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;dra&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_decSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_decSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Time</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damp</span> <span class="o">=</span> <span class="n">damp</span>

<div class="viewcode-block" id="RVProbability.chi"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVProbability.html#ssapy.rvsampler.RVProbability.chi">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">chi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate chi residuals for use with lmfit.</span>

<span class="sd">        This is essentially the input to a chi^2 statistic, just without the</span>
<span class="sd">        squaring and without the summing over observations.  I.e., it&#39;s</span>

<span class="sd">        [(data_i - model_i)/err_i for i in 0..nobs]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            Orbit in question.  The model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chilike : array_like (nobs,)</span>
<span class="sd">            chi residual array for likelihoods</span>
<span class="sd">        chiprior : array_like (nprior,)</span>
<span class="sd">            chi residual array for priors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hitbadorbit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WGS84_EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="o">*</span><span class="mf">0.999</span><span class="p">:</span>
            <span class="n">newv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">vmax</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span>
            <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">newv</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">)</span>
            <span class="n">hitbadorbit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">)</span>
            <span class="n">hitbadorbit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanpm</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">slant</span><span class="p">,</span> <span class="n">pmra</span><span class="p">,</span> <span class="n">pmdec</span><span class="p">,</span> <span class="n">slantrate</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">radec</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="n">obsPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rStation</span><span class="p">,</span>
                      <span class="n">obsVel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vStation</span><span class="p">,</span>
                      <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">drarate</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmra</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmra</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmraSigma</span>
            <span class="n">ddecrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmdec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmdec</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmdecSigma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">slant</span> <span class="o">=</span> <span class="n">radec</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="n">obsPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rStation</span><span class="p">,</span>
                                   <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span>
        <span class="n">dra</span> <span class="o">=</span> <span class="p">((</span><span class="n">ra</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">dra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">dra</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_raSigma</span>
        <span class="n">ddec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_decSigma</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanpm</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dra</span><span class="p">,</span> <span class="n">drarate</span><span class="p">,</span> <span class="n">ddec</span><span class="p">,</span> <span class="n">ddecrate</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dra</span><span class="p">,</span> <span class="n">ddec</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">damp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">damper</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">damp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chiprior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">prior</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">slant</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">prior</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chiprior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hitbadorbit</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="mf">1e5</span>
        <span class="k">return</span> <span class="n">chi</span><span class="p">,</span> <span class="n">chiprior</span></div>

<div class="viewcode-block" id="RVProbability.lnlike"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVProbability.html#ssapy.rvsampler.RVProbability.lnlike">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">lnlike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the log likelihood of the observations given an orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            Orbit in question.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lnlike : float</span>
<span class="sd">            Log likelihood.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="n">orbit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="RVProbability.lnprob"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVProbability.html#ssapy.rvsampler.RVProbability.lnprob">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">lnprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the log posterior probability of parameters p given</span>
<span class="sd">        observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p : array (6,)</span>
<span class="sd">            Sampling parameters.  [x, y, z, vx, vy, vz] in meters and meters per</span>
<span class="sd">            second.  Understood to be the parameters at epoch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lnprob : float</span>
<span class="sd">            Log posterior probability.</span>
<span class="sd">        lnprior : float</span>
<span class="sd">            Log prior probability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">chilike</span><span class="p">,</span> <span class="n">chiprior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="n">lnprior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chiprior</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chilike</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">lnprior</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">lnprior</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">lnprior</span></div>

<div class="viewcode-block" id="RVProbability.lnprior"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVProbability.html#ssapy.rvsampler.RVProbability.lnprior">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">lnprior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the log prior probability of the observations given an</span>
<span class="sd">        orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            Orbit in question.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lnprior : float</span>
<span class="sd">            Log prior probability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="n">orbit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">lnprob</span></div>


<div class="viewcode-block" id="EmceeSampler"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EmceeSampler.html#ssapy.rvsampler.EmceeSampler">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EmceeSampler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A sampler built on the emcee package.</span>

<span class="sd">    The emcee packages implements the Goodman and Weare (2010) affine-invariant</span>
<span class="sd">    sampler.  This is often an efficient sampler to use when selecting a</span>
<span class="sd">    proposal distribution is not simple.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : Callable</span>
<span class="sd">        Callable that accepts sampling parameters p and returns posterior</span>
<span class="sd">        probability.</span>
<span class="sd">    initializer : Callable</span>
<span class="sd">        Callable that accepts number of desired initial samples and returns</span>
<span class="sd">        samples.  Note, the initial samples should be (at least mostly) unique.</span>
<span class="sd">    nWalker : int</span>
<span class="sd">        Number of &#39;walkers&#39; to use in the Goodman &amp; Weare algorithm.  This</span>
<span class="sd">        should generally be at least 12 for the 6-dimensional problem.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn</span>
<span class="sd">    initializer</span>
<span class="sd">    nWalker</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    sample(nBurn, nStep)</span>
<span class="sd">        Generate samples, first discarding nBurn steps, and then keeping nStep</span>
<span class="sd">        steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">nWalker</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="c1"># Don&#39;t need emcee right here, but better to catch version</span>
        <span class="c1"># incompatibility in ctor than down below.</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">emcee</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">distutils.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">LooseVersion</span>
        <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">emcee</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="s2">&quot;3.0&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;emcee version at least 3.0rc2 required&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span> <span class="o">=</span> <span class="n">initializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nWalker</span> <span class="o">=</span> <span class="n">nWalker</span>

<div class="viewcode-block" id="EmceeSampler.sample"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EmceeSampler.html#ssapy.rvsampler.EmceeSampler.sample">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nBurn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">nStep</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nBurn : int</span>
<span class="sd">            Number of initial steps to take but discard.</span>
<span class="sd">        nStep : int</span>
<span class="sd">            Number of subsequent steps to keep and return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chain : array (nStep, nWalker, 6)</span>
<span class="sd">            Generated samples.  Columns are [x, y, z, vx, vy, vz].</span>
<span class="sd">        lnprob : array (nStep, nWalker)</span>
<span class="sd">            The log posterior probabilities of the samples.</span>
<span class="sd">        lnprior : array(nStep, nWalker)</span>
<span class="sd">            The log prior values for each step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">emcee</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">distutils.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">LooseVersion</span>
        <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">emcee</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="s2">&quot;3.0&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;emcee version at least 3.0rc2 required&quot;</span><span class="p">)</span>
        <span class="c1"># Type for emcee &#39;blobs&#39; metadata</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;lnprior&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)]</span>
        <span class="n">walkers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nWalker</span><span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nWalker</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="p">,</span> <span class="n">blobs_dtype</span><span class="o">=</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">nBurn</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="c1"># Could add a trim step here to cut out any huge outliers.</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">nStep</span><span class="p">)</span>

        <span class="n">blobs</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_blobs</span><span class="p">()</span>
        <span class="n">lnprior</span> <span class="o">=</span> <span class="n">blobs</span><span class="p">[</span><span class="s1">&#39;lnprior&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(),</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">(),</span> <span class="n">lnprior</span></div></div>


<div class="viewcode-block" id="MVNormalProposal"><a class="viewcode-back" href="../../api/ssapy.rvsampler.MVNormalProposal.html#ssapy.rvsampler.MVNormalProposal">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MVNormalProposal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A multivariate normal proposal distribution.</span>

<span class="sd">    Params</span>
<span class="sd">    ------</span>
<span class="sd">    cov : array_like(6, 6)</span>
<span class="sd">        Covariance of multivariate normal distribution from which to sample.</span>
<span class="sd">        The order of variables is [x, y, z, vx, vy, vz] in meters and meters per</span>
<span class="sd">        second.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cov</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    propose(p)</span>
<span class="sd">        Generate a new proposal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span>

<div class="viewcode-block" id="MVNormalProposal.propose"><a class="viewcode-back" href="../../api/ssapy.rvsampler.MVNormalProposal.html#ssapy.rvsampler.MVNormalProposal.propose">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">propose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a proposal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p : array (6,)</span>
<span class="sd">            Mean around which to generate a proposal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        newp : array (6,)</span>
<span class="sd">            Generated proposal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RVSigmaProposal"><a class="viewcode-back" href="../../api/ssapy.rvsampler.RVSigmaProposal.html#ssapy.rvsampler.RVSigmaProposal">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">RVSigmaProposal</span><span class="p">(</span><span class="n">MVNormalProposal</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Isotropic multivariate normal proposal distribution.</span>

<span class="sd">    Params</span>
<span class="sd">    ------</span>
<span class="sd">    rSigma : float</span>
<span class="sd">        Isotropic standard deviation in position to use.</span>
<span class="sd">    vSigma : float</span>
<span class="sd">        Isotropic standard deviation in velocity to use.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cov</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    propose(p)</span>
<span class="sd">        Generate a new proposal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rSigma</span><span class="p">,</span> <span class="n">vSigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">rSigma</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="p">[</span><span class="n">vSigma</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="MHSampler"><a class="viewcode-back" href="../../api/ssapy.rvsampler.MHSampler.html#ssapy.rvsampler.MHSampler">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MHSampler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate MCMC samples using a Metropolis-Hastings sampler.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : Callable</span>
<span class="sd">        Callable that accepts sampling parameters p and returns posterior</span>
<span class="sd">        probability.</span>
<span class="sd">    initializer : Callable</span>
<span class="sd">        Callable that accepts number of desired initial samples and returns</span>
<span class="sd">        samples.  Note, the initial samples should be (at least mostly) unique.</span>
<span class="sd">    proposer : Callable</span>
<span class="sd">        Callable that accepts a &quot;current&quot; sample and returns a &quot;proposed&quot; sample</span>
<span class="sd">        to either accept or reject at each step.</span>
<span class="sd">    nChain : int</span>
<span class="sd">        Number of independent chains to use.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn</span>
<span class="sd">    initializer</span>
<span class="sd">    proposer</span>
<span class="sd">    nChain</span>
<span class="sd">    chain : array_like (nStep, nChain, 6)</span>
<span class="sd">        MCMC sample chain.</span>
<span class="sd">    lnprob : array_like (nStep, nChain)</span>
<span class="sd">        Log posterior probability of sample chain.</span>
<span class="sd">    nAccept : int</span>
<span class="sd">        Total number of accepted proposals.</span>
<span class="sd">    nStep : int</span>
<span class="sd">        Total number of proposal steps.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    reset()</span>
<span class="sd">        Reset chains.</span>
<span class="sd">    sample(nBurn, nStep)</span>
<span class="sd">        Generate samples, first discarding nBurn steps, and then keeping nStep</span>
<span class="sd">        steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initializer</span><span class="p">,</span> <span class="n">proposer</span><span class="p">,</span> <span class="n">nChain</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proposer</span> <span class="o">=</span> <span class="n">proposer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nChain</span> <span class="o">=</span> <span class="n">nChain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">initializer</span><span class="p">(</span><span class="n">nChain</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<div class="viewcode-block" id="MHSampler.reset"><a class="viewcode-back" href="../../api/ssapy.rvsampler.MHSampler.html#ssapy.rvsampler.MHSampler.reset">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset chain, including `chain`, `lnprob`, `nAccept`, and `nStep`</span>
<span class="sd">        attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprior</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nAccept</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nStep</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nChain</span><span class="p">):</span>
            <span class="n">curr</span><span class="p">,</span> <span class="n">currPost</span><span class="p">,</span> <span class="n">currPrior</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposer</span><span class="o">.</span><span class="n">propose</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="n">propPost</span><span class="p">,</span> <span class="n">propPrior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">propPost</span> <span class="o">&gt;=</span> <span class="n">currPost</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">propPost</span><span class="o">-</span><span class="n">currPost</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nAccept</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">currPost</span> <span class="o">=</span> <span class="n">propPost</span>
                <span class="n">currPrior</span> <span class="o">=</span> <span class="n">propPrior</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">prop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">curr</span><span class="p">,</span> <span class="n">currPost</span><span class="p">,</span> <span class="n">currPrior</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nStep</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nChain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnprob</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnprior</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">acceptanceRatio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ratio of accepted to proposed steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nAccept</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nStep</span>

<div class="viewcode-block" id="MHSampler.sample"><a class="viewcode-back" href="../../api/ssapy.rvsampler.MHSampler.html#ssapy.rvsampler.MHSampler.sample">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nBurn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">nStep</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nBurn : int</span>
<span class="sd">            Number of initial steps to take but discard.</span>
<span class="sd">        nStep : int</span>
<span class="sd">            Number of subsequent steps to keep and return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chain : array (nStep, nChain, 6)</span>
<span class="sd">            Generated samples.  Columns are [x, y, z, vx, vy, vz].</span>
<span class="sd">        lnprob : array (nStep, nChain)</span>
<span class="sd">            The log posterior probabilities of the samples.</span>
<span class="sd">        lnprior : array (nStep, nChain)</span>
<span class="sd">            The log prior probabilities of the samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nBurn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nStep</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnprior</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="LeastSquaresOptimizer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LeastSquaresOptimizer.html#ssapy.rvsampler.LeastSquaresOptimizer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">LeastSquaresOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for LeastSquaresOptimizers&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initparam</span><span class="p">,</span> <span class="n">translatorcls</span><span class="p">,</span>
                 <span class="n">absstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fracstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initparam</span> <span class="o">=</span> <span class="n">initparam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">translatorcls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initparam</span><span class="p">,</span> <span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span> <span class="o">=</span> <span class="n">absstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span> <span class="o">=</span> <span class="n">fracstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>

<div class="viewcode-block" id="LeastSquaresOptimizer.resid"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LeastSquaresOptimizer.html#ssapy.rvsampler.LeastSquaresOptimizer.resid">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">param_to_orbit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">chi</span></div>

<div class="viewcode-block" id="LeastSquaresOptimizer.optimize"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LeastSquaresOptimizer.html#ssapy.rvsampler.LeastSquaresOptimizer.optimize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the optimizer and return the resulting fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit : (6,) array_like</span>
<span class="sd">            Least-squares fit as [x, y, z, vx, vy, vz] in meters, and</span>
<span class="sd">            meters/second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.optimize</span>
        <span class="n">par0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">input_param_translation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initparam</span><span class="p">)</span>
        <span class="n">par0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">optimizeparam</span><span class="p">(</span><span class="n">par0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;maxfev&#39;</span> <span class="ow">in</span> <span class="n">fit_kws</span><span class="p">:</span>
            <span class="n">nmax</span> <span class="o">=</span> <span class="n">fit_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;maxfev&#39;</span><span class="p">)</span>
            <span class="n">fit_kws</span><span class="p">[</span><span class="s1">&#39;max_nfev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">par0</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WGS84_EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="o">*</span><span class="mf">0.999</span><span class="p">:</span>
            <span class="n">orbit</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">vmax</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hithyperbolicorbit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">jac</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">output_covar_translation</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">fitp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">orbit_to_param</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fitp</span></div></div>


<div class="viewcode-block" id="ParamOrbitTranslator"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ParamOrbitTranslator</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for making parameters into Orbits and vice-versa.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initparam</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initParam</span> <span class="o">=</span> <span class="n">initparam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="o">=</span> <span class="n">orbitattr</span> <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>

<div class="viewcode-block" id="ParamOrbitTranslator.fullparam"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.fullparam">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fullparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initparam</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.optimizeparam"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.optimizeparam">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimizeparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.param_to_orbit"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.param_to_orbit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.orbit_to_param"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.orbit_to_param">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">orbit_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.get_propkw_from_fullparam"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.get_propkw_from_fullparam">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_propkw_from_fullparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullparam</span><span class="p">):</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">,</span> <span class="n">fullparam</span><span class="p">[</span><span class="mi">6</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log10&#39;</span><span class="p">):</span>
                <span class="n">newname</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">newval</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newname</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">newval</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">propkw</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
        <span class="k">return</span> <span class="n">propkw</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.get_propkw_from_orbit"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.get_propkw_from_orbit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_propkw_from_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log10&#39;</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">propkw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">propkw</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.input_param_translation"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.input_param_translation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">input_param_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ParamOrbitTranslator.output_covar_translation"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitTranslator.html#ssapy.rvsampler.ParamOrbitTranslator.output_covar_translation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output_covar_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">covar</span></div></div>


<div class="viewcode-block" id="ParamOrbitRV"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitRV.html#ssapy.rvsampler.ParamOrbitRV">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ParamOrbitRV</span><span class="p">(</span><span class="n">ParamOrbitTranslator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for translating orbital parameters in position-velocity (RV) form, </span>
<span class="sd">    including conversions between parameters and orbit objects.</span>

<span class="sd">    Inherits:</span>
<span class="sd">    ---------</span>
<span class="sd">    ParamOrbitTranslator : Base class providing foundational functionality </span>
<span class="sd">    for orbital parameter translation.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    __init__(*args, **kwargs):</span>
<span class="sd">        Initialize the `ParamOrbitRV` object, inheriting behavior from the </span>
<span class="sd">        `ParamOrbitTranslator` base class.</span>

<span class="sd">    param_to_orbit(p):</span>
<span class="sd">        Convert position-velocity (RV) parameters to an `Orbit` object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        p : array-like</span>
<span class="sd">            Orbital parameters in position-velocity form. The first three </span>
<span class="sd">            elements represent the position vector (`r`), and the next three </span>
<span class="sd">            elements represent the velocity vector (`v`).</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Orbit</span>
<span class="sd">            An `Orbit` object created from the position (`r`) and velocity (`v`) </span>
<span class="sd">            vectors, along with propagation keywords.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - Additional propagation keywords are extracted from the full parameter set.</span>
<span class="sd">        - The `Orbit` class is expected to support initialization with `r` and `v`.</span>

<span class="sd">    orbit_to_param(orbit):</span>
<span class="sd">        Convert an `Orbit` object to a list of position-velocity (RV) parameters </span>
<span class="sd">        and associated propagation keywords.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            An `Orbit` object containing position (`r`) and velocity (`v`) vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            A concatenated array of position (`r`), velocity (`v`), and propagation </span>
<span class="sd">            keywords extracted from the orbit.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - This class assumes orbital parameters are represented in position-velocity form.</span>
<span class="sd">    - The `Orbit` class is expected to provide attributes `r` and `v` for position </span>
<span class="sd">      and velocity vectors, respectively.</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; translator = ParamOrbitRV()</span>
<span class="sd">    &gt;&gt;&gt; params = [7000, 0, 0, 0, 7.5, 0]  # Example position-velocity parameters</span>
<span class="sd">    &gt;&gt;&gt; orbit = translator.param_to_orbit(params)</span>
<span class="sd">    &gt;&gt;&gt; new_params = translator.orbit_to_param(orbit)</span>
<span class="sd">    &gt;&gt;&gt; print(new_params)</span>
<span class="sd">    [7000, 0, 0, 0, 7.5, 0]  # Example output matching input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParamOrbitRV</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ParamOrbitRV.param_to_orbit"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitRV.html#ssapy.rvsampler.ParamOrbitRV.param_to_orbit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">fullparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbit</span></div>

<div class="viewcode-block" id="ParamOrbitRV.orbit_to_param"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitRV.html#ssapy.rvsampler.ParamOrbitRV.orbit_to_param">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">orbit_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">r</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_orbit</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">propkw</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="ParamOrbitEquinoctial"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitEquinoctial.html#ssapy.rvsampler.ParamOrbitEquinoctial">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ParamOrbitEquinoctial</span><span class="p">(</span><span class="n">ParamOrbitTranslator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for translating orbital parameters in equinoctial form, </span>
<span class="sd">    including input/output transformations and conversions between </span>
<span class="sd">    parameters and orbit objects.</span>

<span class="sd">    Inherits:</span>
<span class="sd">    ---------</span>
<span class="sd">    ParamOrbitTranslator : Base class providing foundational functionality </span>
<span class="sd">    for orbital parameter translation.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    __init__(*args, **kwargs):</span>
<span class="sd">        Initialize the `ParamOrbitEquinoctial` object, inheriting behavior </span>
<span class="sd">        from the `ParamOrbitTranslator` base class.</span>

<span class="sd">    input_param_translation(p):</span>
<span class="sd">        Transform input orbital parameters by scaling the first parameter </span>
<span class="sd">        (typically semi-major axis) for internal use.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        p : array-like</span>
<span class="sd">            Input orbital parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Transformed orbital parameters with the first element scaled.</span>

<span class="sd">    output_covar_translation(covar):</span>
<span class="sd">        Transform covariance matrix for output by scaling the first row </span>
<span class="sd">        and column (typically related to semi-major axis).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        covar : array-like</span>
<span class="sd">            Input covariance matrix.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Transformed covariance matrix with scaled elements.</span>

<span class="sd">    param_to_orbit(p):</span>
<span class="sd">        Convert equinoctial orbital parameters to an `Orbit` object, </span>
<span class="sd">        ensuring constraints on eccentricity and semi-major axis.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        p : array-like</span>
<span class="sd">            Equinoctial orbital parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Orbit</span>
<span class="sd">            An `Orbit` object created from the equinoctial parameters.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - The semi-major axis (`p[0]`) is scaled and clipped to a minimum value of 1.</span>
<span class="sd">        - The eccentricity vector (`p[3]`, `p[4]`) is normalized if its magnitude exceeds 0.999.</span>
<span class="sd">        - Additional propagation keywords are extracted from the full parameter set.</span>

<span class="sd">    orbit_to_param(orbit):</span>
<span class="sd">        Convert an `Orbit` object to a list of equinoctial orbital parameters </span>
<span class="sd">        and associated propagation keywords.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            An `Orbit` object containing equinoctial elements.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        list</span>
<span class="sd">            A list of equinoctial orbital parameters and propagation keywords.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - This class assumes equinoctial orbital elements are used for parameterization.</span>
<span class="sd">    - The `Orbit` class is expected to provide methods for handling equinoctial elements.</span>
<span class="sd">    - Scaling factors (e.g., 1e7 for semi-major axis) are applied for numerical stability.</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; translator = ParamOrbitEquinoctial()</span>
<span class="sd">    &gt;&gt;&gt; params = [7000000, 0, 0, 0.01, 0.01, 0]  # Example equinoctial parameters</span>
<span class="sd">    &gt;&gt;&gt; orbit = translator.param_to_orbit(params)</span>
<span class="sd">    &gt;&gt;&gt; new_params = translator.orbit_to_param(orbit)</span>
<span class="sd">    &gt;&gt;&gt; print(new_params)</span>
<span class="sd">    [7000000, 0, 0, 0.01, 0.01, 0]  # Example output matching input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParamOrbitEquinoctial</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ParamOrbitEquinoctial.input_param_translation"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitEquinoctial.html#ssapy.rvsampler.ParamOrbitEquinoctial.input_param_translation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">input_param_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e7</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ParamOrbitEquinoctial.output_covar_translation"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitEquinoctial.html#ssapy.rvsampler.ParamOrbitEquinoctial.output_covar_translation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output_covar_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covar</span><span class="p">):</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">covar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="n">covar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="k">return</span> <span class="n">covar</span></div>

<div class="viewcode-block" id="ParamOrbitEquinoctial.param_to_orbit"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitEquinoctial.html#ssapy.rvsampler.ParamOrbitEquinoctial.param_to_orbit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">fullparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">e2</span> <span class="o">&gt;=</span> <span class="mf">0.999</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.999</span> <span class="o">/</span> <span class="n">e2</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">norm</span>
            <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">norm</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="o">.</span><span class="n">fromEquinoctialElements</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                                              <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbit</span></div>

<div class="viewcode-block" id="ParamOrbitEquinoctial.orbit_to_param"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitEquinoctial.html#ssapy.rvsampler.ParamOrbitEquinoctial.orbit_to_param">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">orbit_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
        <span class="n">fullparam</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">equinoctialElements</span><span class="p">)</span>
        <span class="n">fullparam</span> <span class="o">=</span> <span class="n">fullparam</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_orbit</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fullparam</span></div></div>


<div class="viewcode-block" id="ParamOrbitAngle"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitAngle.html#ssapy.rvsampler.ParamOrbitAngle">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ParamOrbitAngle</span><span class="p">(</span><span class="n">ParamOrbitTranslator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for translating orbital parameters in angle-based form, </span>
<span class="sd">    including conversions between angular parameters and orbit objects.</span>

<span class="sd">    Inherits:</span>
<span class="sd">    ---------</span>
<span class="sd">    ParamOrbitTranslator : Base class providing foundational functionality </span>
<span class="sd">    for orbital parameter translation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    -----------</span>
<span class="sd">    initObsPos : array-like</span>
<span class="sd">        Initial observer position vector used for angle-based calculations.</span>
<span class="sd">    initObsVel : array-like</span>
<span class="sd">        Initial observer velocity vector used for angle-based calculations.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    __init__(initparam, epoch, initObsPos, initObsVel, **kwargs):</span>
<span class="sd">        Initialize the `ParamOrbitAngle` object with initial parameters, </span>
<span class="sd">        epoch, observer position, and observer velocity.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        initparam : array-like</span>
<span class="sd">            Initial orbital parameters.</span>
<span class="sd">        epoch : float</span>
<span class="sd">            Epoch time for the orbit.</span>
<span class="sd">        initObsPos : array-like</span>
<span class="sd">            Initial observer position vector.</span>
<span class="sd">        initObsVel : array-like</span>
<span class="sd">            Initial observer velocity vector.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to the parent class.</span>

<span class="sd">    param_to_orbit(p):</span>
<span class="sd">        Convert angle-based orbital parameters to an `Orbit` object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        p : array-like</span>
<span class="sd">            Orbital parameters in angle-based form. The first six elements </span>
<span class="sd">            represent angular parameters (e.g., right ascension, declination, </span>
<span class="sd">            and rates).</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Orbit</span>
<span class="sd">            An `Orbit` object created from the angular parameters, along with </span>
<span class="sd">            propagation keywords.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - The method `radecRateObsToRV` is used to convert angular parameters </span>
<span class="sd">          to position (`r`) and velocity (`v`) vectors.</span>
<span class="sd">        - Additional propagation keywords are extracted from the full parameter set.</span>

<span class="sd">    orbit_to_param(orbit):</span>
<span class="sd">        Convert an `Orbit` object to a list of angle-based orbital parameters </span>
<span class="sd">        and associated propagation keywords.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            An `Orbit` object containing position (`r`) and velocity (`v`) vectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        list</span>
<span class="sd">            A list of angle-based orbital parameters (e.g., right ascension, </span>
<span class="sd">            declination, and rates) and propagation keywords.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - The method `rvObsToRaDecRate` is used to convert position (`r`) and </span>
<span class="sd">          velocity (`v`) vectors to angular parameters.</span>
<span class="sd">        - Observer position and velocity are used in the conversion process.</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; initObsPos = [0, 0, 0]  # Example observer position</span>
<span class="sd">    &gt;&gt;&gt; initObsVel = [0, 0, 0]  # Example observer velocity</span>
<span class="sd">    &gt;&gt;&gt; translator = ParamOrbitAngle(initparam=[1, 2, 3, 4, 5, 6], epoch=2451545.0, </span>
<span class="sd">    ...                              initObsPos=initObsPos, initObsVel=initObsVel)</span>
<span class="sd">    &gt;&gt;&gt; params = [1, 2, 3, 4, 5, 6]  # Example angle-based parameters</span>
<span class="sd">    &gt;&gt;&gt; orbit = translator.param_to_orbit(params)</span>
<span class="sd">    &gt;&gt;&gt; new_params = translator.orbit_to_param(orbit)</span>
<span class="sd">    &gt;&gt;&gt; print(new_params)</span>
<span class="sd">    [1, 2, 3, 4, 5, 6]  # Example output matching input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initparam</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">initObsPos</span><span class="p">,</span> <span class="n">initObsVel</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParamOrbitAngle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">initparam</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span> <span class="o">=</span> <span class="n">initObsPos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span> <span class="o">=</span> <span class="n">initObsVel</span>

<div class="viewcode-block" id="ParamOrbitAngle.param_to_orbit"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitAngle.html#ssapy.rvsampler.ParamOrbitAngle.param_to_orbit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">fullparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">radecRateObsToRV</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span><span class="p">)</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_fullparam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbit</span></div>

<div class="viewcode-block" id="ParamOrbitAngle.orbit_to_param"><a class="viewcode-back" href="../../api/ssapy.rvsampler.ParamOrbitAngle.html#ssapy.rvsampler.ParamOrbitAngle.orbit_to_param">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">orbit_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">rvObsToRaDecRate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span><span class="p">)</span>
        <span class="n">propkw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_propkw_from_orbit</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="n">propkw</span></div></div>


<div class="viewcode-block" id="LMOptimizerAngular"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LMOptimizerAngular.html#ssapy.rvsampler.LMOptimizerAngular">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">LMOptimizerAngular</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizer that employs Levenberg-Marquardt least-squares fitting.</span>
<span class="sd">    Instead of rv, works in angle/proper motion/range/range rate of initial obs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : RVProbability</span>
<span class="sd">        The RVProbability object that has both an epoch attribute to use for</span>
<span class="sd">        the orbit fitting model, and a chi method to use for the fit</span>
<span class="sd">        evaluation.</span>
<span class="sd">    initGuess : array_like (6,)</span>
<span class="sd">        Initial guess.  (ra, dec, range, pmra, pmdec, rangerate).</span>
<span class="sd">        (rad, rad, m, rad/s, rad/s, m/s)</span>
<span class="sd">    initObsPos : array_like (3,)</span>
<span class="sd">        Position of observer at probfn.epoch.</span>
<span class="sd">    initObsVel : array_like (3,)</span>
<span class="sd">        Position of observer at probfn.epoch.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    result : lmfit.MinimizerResult</span>
<span class="sd">        Most recently run result object.  Could be useful for inspecting</span>
<span class="sd">        error estimates or success/failure conditions.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    optimize()</span>
<span class="sd">        Return the optimized parameters list [r, v]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initGuess</span><span class="p">,</span> <span class="n">initObsPos</span><span class="p">,</span> <span class="n">initObsVel</span><span class="p">,</span>
                 <span class="n">fracstep</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-7</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span>
                 <span class="n">absstep</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="mf">0.01</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                          <span class="mf">1e-2</span><span class="p">],</span>
                 <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This class is deprecated; use &quot;</span>
                      <span class="s2">&quot;ssapy.rvsampler.LeastSquaresOptimizer&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pmra&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pmdec&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rangerate&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initGuess</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span> <span class="o">=</span> <span class="n">absstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span> <span class="o">=</span> <span class="n">fracstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span> <span class="o">=</span> <span class="n">initObsPos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span> <span class="o">=</span> <span class="n">initObsVel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initGuess</span> <span class="o">=</span> <span class="n">initGuess</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">vd</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
            <span class="n">pmra</span><span class="p">,</span> <span class="n">pmdec</span> <span class="o">=</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span>
            <span class="nb">range</span><span class="p">,</span> <span class="n">rangerate</span> <span class="o">=</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;rangerate&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">pmra</span><span class="p">,</span> <span class="n">pmdec</span><span class="p">,</span> <span class="n">rangerate</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">radecRateObsToRV</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">pmra</span><span class="p">,</span> <span class="n">pmdec</span><span class="p">,</span> <span class="n">rangerate</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">chi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dx</span><span class="p">):</span>
            <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">di</span>
            <span class="n">res</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">-</span><span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">di</span>
            <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="LMOptimizerAngular.optimize"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LMOptimizerAngular.html#ssapy.rvsampler.LMOptimizerAngular.optimize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usejac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the optimizer and return the resulting fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit : (6,) array_like</span>
<span class="sd">            Least-squares fit as [ra, dec, slant, raRate, decRate,</span>
<span class="sd">            slantRate] in rad, rad, m, rad/s, rad/s, m/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="n">Dfun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jac</span> <span class="k">if</span> <span class="n">usejac</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">Dfun</span><span class="o">=</span><span class="n">Dfun</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WGS84_EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="o">*</span><span class="mf">0.999</span><span class="p">:</span>
            <span class="n">orbit</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">vmax</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hithyperbolicorbit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">usejac</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span>
        <span class="k">return</span> <span class="n">radec</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">obsPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initObsPos</span><span class="p">,</span>
                     <span class="n">obsVel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initObsVel</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LMOptimizer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LMOptimizer.html#ssapy.rvsampler.LMOptimizer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">LMOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizer that employs Levenberg-Marquardt least-squares fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : RVProbability</span>
<span class="sd">        The RVProbability object that has both an epoch attribute to use for</span>
<span class="sd">        the orbit fitting model, and a chi method to use for the fit</span>
<span class="sd">        evaluation.</span>
<span class="sd">    initRV : array_like (6,)</span>
<span class="sd">        Initial position and velocity.  Essentially a single output from one</span>
<span class="sd">        of the initializers above.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    result : lmfit.MinimizerResult</span>
<span class="sd">        Most recently run result object.  Could be useful for inspecting</span>
<span class="sd">        error estimates or success/failure conditions.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    optimize()</span>
<span class="sd">        Return the optimized parameters list [r, v]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initRV</span><span class="p">,</span>
                 <span class="n">fracstep</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">],</span>
                 <span class="n">absstep</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">],</span>
                 <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>


        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This class is deprecated; use &quot;</span>
                      <span class="s2">&quot;ssapy.rvsampler.LeastSquaresOptimizer&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initRV</span> <span class="o">=</span> <span class="n">initRV</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;vz&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initRV</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span> <span class="o">=</span> <span class="n">absstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span> <span class="o">=</span> <span class="n">fracstep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">vd</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">vd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">vd</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">],</span> <span class="n">vd</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]]</span>
            <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orbit</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orbit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">chi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dx</span><span class="p">):</span>
            <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">di</span>
            <span class="n">res</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">-</span><span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">di</span>
            <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="LMOptimizer.optimize"><a class="viewcode-back" href="../../api/ssapy.rvsampler.LMOptimizer.html#ssapy.rvsampler.LMOptimizer.optimize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usejac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the optimizer and return the resulting fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit : (6,) array_like</span>
<span class="sd">            Least-squares fit as [x, y, z, vx, vy, vz] in meters, and</span>
<span class="sd">            meters/second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="n">Dfun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jac</span> <span class="k">if</span> <span class="n">usejac</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">Dfun</span><span class="o">=</span><span class="n">Dfun</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">WGS84_EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="o">*</span><span class="mf">0.999</span><span class="p">:</span>
            <span class="n">orbit</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">vmax</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hithyperbolicorbit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">usejac</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="eq2kep"><a class="viewcode-back" href="../../api/ssapy.rvsampler.eq2kep.html#ssapy.rvsampler.eq2kep">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">eq2kep</span><span class="p">(</span><span class="n">eq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert equinoctial orbital elements to classical Keplerian orbital elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    eq : array-like</span>
<span class="sd">        A list or array of equinoctial orbital elements. The elements are:</span>
<span class="sd">        - eq[0]: Semi-major axis (a)</span>
<span class="sd">        - eq[1]: Equinoctial parameter h (related to inclination and RAAN)</span>
<span class="sd">        - eq[2]: Equinoctial parameter k (related to inclination and RAAN)</span>
<span class="sd">        - eq[3]: Equinoctial parameter p (related to eccentricity and argument of periapsis)</span>
<span class="sd">        - eq[4]: Equinoctial parameter q (related to eccentricity and argument of periapsis)</span>
<span class="sd">        - eq[5]: Mean longitude (L)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    kep : list</span>
<span class="sd">        A list of classical Keplerian orbital elements:</span>
<span class="sd">        - kep[0]: Semi-major axis (a)</span>
<span class="sd">        - kep[1]: Eccentricity (e)</span>
<span class="sd">        - kep[2]: Inclination (i) [in radians]</span>
<span class="sd">        - kep[3]: Argument of periapsis (ω) [in radians]</span>
<span class="sd">        - kep[4]: Right ascension of the ascending node (Ω) [in radians]</span>
<span class="sd">        - kep[5]: Mean anomaly (M) [in radians]</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; eq = [7000, 0.1, 0.2, 0.01, 0.02, 1.5]</span>
<span class="sd">    &gt;&gt;&gt; kep = eq2kep(eq)</span>
<span class="sd">    &gt;&gt;&gt; print(kep)</span>
<span class="sd">    [7000, 0.022360679774997897, 0.40489178628508343, -0.4636476090008061, 1.1071487177940904, 1.9634954084936207]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tanio2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">eq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">raan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-</span><span class="n">raan</span>
    <span class="n">kep</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">tanio2</span><span class="p">),</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">aux</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kep</span></div>


<div class="viewcode-block" id="SGP4LMOptimizer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.SGP4LMOptimizer.html#ssapy.rvsampler.SGP4LMOptimizer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">SGP4LMOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizer that employs Levenberg-Marquardt least-squares fitting</span>
<span class="sd">    and fits in Kozai mean Keplerian element space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : RVProbability</span>
<span class="sd">        The RVProbability object that has both an epoch attribute to use for the</span>
<span class="sd">        orbit fitting model, and a chi method to use for the fit evaluation.</span>
<span class="sd">    initel : array_like (6,)</span>
<span class="sd">        Initial Kozai mean Keplerian elements.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    result : lmfit.MinimizerResult</span>
<span class="sd">        Most recently run result object.  Could be useful for inspecting error</span>
<span class="sd">        estimates or success/failure conditions.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    optimize()</span>
<span class="sd">        Return the optimized parameters list [r, v]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initel</span><span class="p">,</span>
                 <span class="n">fracstep</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-8</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span>
                 <span class="n">absstep</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">]):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initel</span> <span class="o">=</span> <span class="n">initel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;hx&#39;</span><span class="p">,</span> <span class="s1">&#39;hy&#39;</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">,</span> <span class="s1">&#39;ey&#39;</span><span class="p">,</span> <span class="s1">&#39;lv&#39;</span><span class="p">]</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ex&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ey&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">0.7</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initel</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span> <span class="o">=</span> <span class="n">absstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span> <span class="o">=</span> <span class="n">fracstep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">paramkepler</span> <span class="o">=</span> <span class="n">eq2kep</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Orbit</span><span class="o">.</span><span class="n">fromKozaiMeanKeplerianElements</span><span class="p">(</span><span class="o">*</span><span class="n">paramkepler</span><span class="p">,</span>
                                                    <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">chi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i4&#39;</span><span class="p">)</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p0</span><span class="o">+</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">di</span><span class="p">)</span>
              <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dx</span><span class="p">)]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">x</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">hi</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">dx</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="SGP4LMOptimizer.optimize"><a class="viewcode-back" href="../../api/ssapy.rvsampler.SGP4LMOptimizer.html#ssapy.rvsampler.SGP4LMOptimizer.optimize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the optimizer and return the resulting fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit : (6,) array_like</span>
<span class="sd">            Least-squares fit as [a, e, i, pa, raan, trueAnomaly]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                                     <span class="n">Dfun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="EquinoctialLMOptimizer"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EquinoctialLMOptimizer.html#ssapy.rvsampler.EquinoctialLMOptimizer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EquinoctialLMOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimizer that employs Levenberg-Marquardt least-squares fitting</span>
<span class="sd">    and fits in Kozai mean Keplerian element space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    probfn : RVProbability</span>
<span class="sd">        The RVProbability object that has both an epoch attribute to use for the</span>
<span class="sd">        orbit fitting model, and a chi method to use for the fit evaluation.</span>
<span class="sd">    initel : array_like (6,)</span>
<span class="sd">        Initial Kozai mean Keplerian elements.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    result : lmfit.MinimizerResult</span>
<span class="sd">        Most recently run result object.  Could be useful for inspecting error</span>
<span class="sd">        estimates or success/failure conditions.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    optimize()</span>
<span class="sd">        Return the optimized parameters list [r, v]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probfn</span><span class="p">,</span> <span class="n">initel</span><span class="p">,</span>
                 <span class="n">fracstep</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-7</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">],</span>
                 <span class="n">absstep</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-7</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">],</span>
                 <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This class is deprecated; use &quot;</span>
                      <span class="s2">&quot;ssapy.rvsampler.LeastSquaresOptimizer&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probfn</span> <span class="o">=</span> <span class="n">probfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initel</span> <span class="o">=</span> <span class="n">initel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aem7&#39;</span><span class="p">,</span> <span class="s1">&#39;hx&#39;</span><span class="p">,</span> <span class="s1">&#39;hy&#39;</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">,</span> <span class="s1">&#39;ey&#39;</span><span class="p">,</span> <span class="s1">&#39;lv&#39;</span><span class="p">]</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ex&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ey&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">0.99</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;aem7&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">1e7</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">6.3e6</span><span class="o">/</span><span class="mf">1e7</span><span class="p">)</span>  <span class="c1"># ~radius of earth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initel</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span> <span class="o">=</span> <span class="n">absstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span> <span class="o">=</span> <span class="n">fracstep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_getOrbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">e2</span> <span class="o">&gt;=</span> <span class="mf">0.999</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.999</span><span class="o">/</span><span class="n">e2</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">norm</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">norm</span>
        <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="k">return</span> <span class="n">Orbit</span><span class="o">.</span><span class="n">fromEquinoctialElements</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">,</span>
                                             <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probfn</span><span class="o">.</span><span class="n">chi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getOrbit</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">chi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_jac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fracstep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">absstep</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i4&#39;</span><span class="p">)</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">(</span><span class="n">p0</span><span class="o">+</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">di</span><span class="p">)</span>
              <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dx</span><span class="p">)]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">x</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">hi</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">dx</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="EquinoctialLMOptimizer.optimize"><a class="viewcode-back" href="../../api/ssapy.rvsampler.EquinoctialLMOptimizer.html#ssapy.rvsampler.EquinoctialLMOptimizer.optimize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the optimizer and return the resulting fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit : (6,) array_like</span>
<span class="sd">            Least-squares fit as [a, e, i, pa, raan, trueAnomaly]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                                     <span class="n">Dfun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kws</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">])</span>
        <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">1e7</span>
        <span class="k">return</span> <span class="n">param</span></div></div>


<div class="viewcode-block" id="damper"><a class="viewcode-back" href="../../api/ssapy.rvsampler.damper.html#ssapy.rvsampler.damper">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">damper</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">damp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pseudo-Huber loss function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">damp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">/</span><span class="n">damp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
    <span class="c1"># return chi/np.sqrt(1+np.abs(chi)/damp)</span>


<div class="viewcode-block" id="damper_deriv"><a class="viewcode-back" href="../../api/ssapy.rvsampler.damper_deriv.html#ssapy.rvsampler.damper_deriv">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">damper_deriv</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">damp</span><span class="p">,</span> <span class="n">derivnum</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Derivative of the pseudo-Huber loss function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">derivnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">/</span><span class="n">damp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">derivnum</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">/</span><span class="n">damp</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">/</span><span class="n">damp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Lawrence Livermore National Security, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>