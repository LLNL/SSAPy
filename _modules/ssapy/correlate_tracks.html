

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ssapy.correlate_tracks &mdash; SSAPy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
    <link rel="shortcut icon" href="../../_static/ssapy_logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/ssapy_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">SSAPy by Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks.html">SSAPy Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">SSAPy Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API DOCS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SSAPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ssapy.correlate_tracks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ssapy.correlate_tracks</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides classes and functions for orbital tracking, hypothesis testing, angle wrapping, </span>
<span class="sd">and fitting satellite observations to orbital models.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ssapy.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EARTH_MU</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ssapy.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">normSq</span><span class="p">,</span> <span class="n">normed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ssapy</span><span class="w"> </span><span class="kn">import</span> <span class="n">rvsampler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssapy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">RGEO</span>

<span class="n">keppropagator</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">KeplerianPropagator</span><span class="p">()</span>

<span class="n">priorvolume</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rv</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">40</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">7000</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="c1"># rough guess of total volume of prior for satellite</span>
                   <span class="c1"># parameter space (2*RGEO)**3*(2*v_LEO)**3 / m^3 / (m/s)^3</span>

                   <span class="n">equinoctial</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mi">40</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                   <span class="c1"># equivalent rough guess in equinoctial space</span>
                   <span class="c1"># out to 2*RGEO in semimajor axis, 4pi for the</span>
                   <span class="c1"># plane of the orbit, pi for ex and ey, 2*pi for lambda.</span>

                   <span class="n">angle</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">0.01</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">40</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="o">*</span><span class="mi">7000</span><span class="p">,</span>
                   <span class="c1"># very rough guess for angular space</span>
                   <span class="c1"># 4 pi for the position, 0.01 rad/s for the proper motions</span>
                   <span class="c1"># 2*RGEO for the distance, 7000 km/s for the range in</span>
                   <span class="c1"># allowed los velocities.  Vaguely the right ballpark?</span>

                   <span class="p">)</span>

<span class="c1"># dead tracks: want to prune hypotheses that differ only by dead tracks.</span>
<span class="c1"># every time a track dies, do the N^2 search for equality among all of the</span>
<span class="c1"># hypotheses it includes?</span>

<div class="viewcode-block" id="CircVelocityPrior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.CircVelocityPrior.html#ssapy.correlate_tracks.CircVelocityPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CircVelocityPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior that log(GM/r/v^2) = 0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Prior standard deviation on log(GM/r/v^2), dimensionless.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">3.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

<div class="viewcode-block" id="CircVelocityPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.CircVelocityPrior.html#ssapy.correlate_tracks.CircVelocityPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loggmorv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">normSq</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="n">loggmorv2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">if</span> <span class="n">chi</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ZeroRadialVelocityPrior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.ZeroRadialVelocityPrior.html#ssapy.correlate_tracks.ZeroRadialVelocityPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ZeroRadialVelocityPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior that v_R = 0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma : float</span>
<span class="sd">        Prior standard deviation on np.dot(v, r)/|v|/|r|, dimensionless.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>

<div class="viewcode-block" id="ZeroRadialVelocityPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.ZeroRadialVelocityPrior.html#ssapy.correlate_tracks.ZeroRadialVelocityPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vdotr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normed</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="n">normed</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="n">vdotr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">if</span> <span class="n">chi</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="GaussPrior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.GaussPrior.html#ssapy.correlate_tracks.GaussPrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GaussPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian prior on parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu : array_like (6)</span>
<span class="sd">        Mean of prior</span>
<span class="sd">    cinvcholfac : array_like (6, 6)</span>
<span class="sd">        Inverse Cholesky factor for covariance matrix,</span>
<span class="sd">        chi = cinvcholfac*(param-mu)</span>
<span class="sd">    translator : function(orbit) -&gt; param</span>
<span class="sd">        function that translates from orbits to parameters</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mu, cinvcholfac, tranlator</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cinvcholfac</span><span class="p">,</span> <span class="n">translator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cinvcholfac</span> <span class="o">=</span> <span class="n">cinvcholfac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">translator</span>

<div class="viewcode-block" id="GaussPrior.__call__"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.GaussPrior.html#ssapy.correlate_tracks.GaussPrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="p">(</span><span class="n">orbit</span><span class="p">)</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cinvcholfac</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">param</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chi</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">chi0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="VolumeDistancePrior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.VolumeDistancePrior.html#ssapy.correlate_tracks.VolumeDistancePrior">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">VolumeDistancePrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prior on range like r^2*exp(-r/scale), preferring larger distances where</span>
<span class="sd">    there is more volume.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__(orbit)</span>
<span class="sd">        Returns log prior probability of given orbit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">RGEO</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">RGEO</span>

<div class="viewcode-block" id="VolumeDistancePrior.__call__"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.VolumeDistancePrior.html#ssapy.correlate_tracks.VolumeDistancePrior.__call__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">chi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return log prior probability of given orbit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orbit : Orbit</span>
<span class="sd">            The given orbit.</span>
<span class="sd">        distance : float</span>
<span class="sd">            Distance between object and observer (m)</span>
<span class="sd">        chi : bool</span>
<span class="sd">            If True, return chi corresponding to log probability, rather than</span>
<span class="sd">            log probability.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logprior : float</span>
<span class="sd">            The log of the prior probability for given orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">lnp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">-</span> <span class="n">distance</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="c1"># - np.log(2*self.scale) --- true normalization factor.</span>
        <span class="c1"># 2*np.log(2) - 2 --- fake normalization factor that takes</span>
        <span class="c1"># max(lnp) = 0, so more chi^2 like.</span>
        <span class="k">if</span> <span class="n">chi</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">lnp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">lnp</span>
        <span class="k">return</span> <span class="n">res</span></div></div>



<div class="viewcode-block" id="make_param_guess"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.make_param_guess.html#ssapy.correlate_tracks.make_param_guess">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">make_param_guess</span><span class="p">(</span><span class="n">rvguess</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an initial parameter guess for orbital estimation based on the provided mode, observation arc, and optional orbital attributes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    rvguess : list or array-like</span>
<span class="sd">        Initial guess for the state vector (position and velocity). </span>
<span class="sd">        Typically contains six elements: `[x, y, z, vx, vy, vz]`.</span>
<span class="sd">    arc : structured array</span>
<span class="sd">        Observation arc containing time and station data. Must include:</span>
<span class="sd">        - `&#39;time&#39;`: Observation times (assumed to have a `.gps` attribute).</span>
<span class="sd">        - `&#39;rStation_GCRF&#39;` and `&#39;vStation_GCRF&#39;`: Position and velocity of the station in the GCRF frame.</span>
<span class="sd">        - `&#39;pmra&#39;` (optional): Proper motion in right ascension (used to determine if proper motion data is available).</span>
<span class="sd">    mode : str, optional</span>
<span class="sd">        The mode for parameter generation. Must be one of:</span>
<span class="sd">        - `&#39;rv&#39;`: Radial velocity mode (default).</span>
<span class="sd">        - `&#39;equinoctial&#39;`: Equinoctial orbital elements mode.</span>
<span class="sd">        - `&#39;angle&#39;`: Angular observation mode.</span>
<span class="sd">    orbitattr : list of str, optional</span>
<span class="sd">        Additional orbital attributes to include in the parameter guess. Supported attributes include:</span>
<span class="sd">        - `&#39;mass&#39;`: Mass of the object.</span>
<span class="sd">        - `&#39;area&#39;`: Cross-sectional area.</span>
<span class="sd">        - `&#39;cr&#39;`: Radiation pressure coefficient.</span>
<span class="sd">        - `&#39;cd&#39;`: Drag coefficient.</span>
<span class="sd">        - `&#39;log10area&#39;`: Logarithm of the cross-sectional area.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    list</span>
<span class="sd">        A list of guessed parameters based on the specified mode:</span>
<span class="sd">        - For `&#39;rv&#39;`: `[rvguess, extraparam, epoch]`.</span>
<span class="sd">        - For `&#39;equinoctial&#39;`: `[equinoctialElements, extraparam, epoch]`.</span>
<span class="sd">        - For `&#39;angle&#39;`: `[radecrate, extraparam, epoch, initObsPos, initObsVel]`.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If an unrecognized mode is provided.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - The `epoch` is determined based on the observation times in the `arc`. If proper motion data (`&#39;pmra&#39;`) is available, the epoch is set to the first observation time. Otherwise, it is calculated as the midpoint between the first two observation times.</span>
<span class="sd">    - For `&#39;equinoctial&#39;` mode, the initial state vector (`rvguess`) is converted into equinoctial orbital elements using the `Orbit` class from `ssapy`.</span>
<span class="sd">    - For `&#39;angle&#39;` mode, the initial observation position and velocity are computed based on the station&#39;s GCRF data. If proper motion data is available, only the first observation is used; otherwise, the average of the first two observations is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
      
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">usepm</span> <span class="o">=</span> <span class="s1">&#39;pmra&#39;</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="k">if</span> <span class="n">usepm</span><span class="p">:</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">gps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">gps</span>

    <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">orbitpropguessdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log10area</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">extraparam</span> <span class="o">=</span> <span class="p">[</span><span class="n">orbitpropguessdict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">orbitattr</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extraparam</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">rvguess</span><span class="p">)</span> <span class="o">+</span> <span class="n">extraparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;equinoctial&#39;</span><span class="p">:</span>
        <span class="n">orbInit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">orbit</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rvguess</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">rvguess</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">orbInit</span><span class="o">.</span><span class="n">equinoctialElements</span><span class="p">)</span> <span class="o">+</span> <span class="n">extraparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">epoch</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
        <span class="n">obs0</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">usepm</span><span class="p">:</span>
            <span class="n">obs1</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">initObsPos</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">obs0</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span>
                              <span class="n">obs1</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">initObsVel</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">obs0</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span>
                              <span class="n">obs1</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initObsPos</span> <span class="o">=</span> <span class="n">obs0</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">initObsVel</span> <span class="o">=</span> <span class="n">obs0</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">radecrate</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">rvObsToRaDecRate</span><span class="p">(</span><span class="n">rvguess</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">rvguess</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span>
                                                 <span class="n">initObsPos</span><span class="p">,</span> <span class="n">initObsVel</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">radecrate</span><span class="p">)</span> <span class="o">+</span> <span class="n">extraparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">+</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">initObsPos</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">initObsVel</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unrecognized mode&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="make_optimizer"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.make_optimizer.html#ssapy.correlate_tracks.make_optimizer">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">make_optimizer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">lsq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and returns an optimizer object or function for orbital parameter estimation based on the specified mode and configuration.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    mode : str</span>
<span class="sd">        The optimization mode to use. Must be one of:</span>
<span class="sd">        - `&#39;rv&#39;`: Radial velocity-based optimization.</span>
<span class="sd">        - `&#39;angle&#39;`: Angular-based optimization.</span>
<span class="sd">        - `&#39;equinoctial&#39;`: Equinoctial orbital parameter optimization.</span>
<span class="sd">    param : list or array-like</span>
<span class="sd">        Initial parameters for the optimizer. </span>
<span class="sd">        - For `&#39;angle&#39;` mode, the last six elements are expected to represent the initial position (last 6 to -3) and velocity (last 3).</span>
<span class="sd">    lsq : bool, optional</span>
<span class="sd">        If `True`, the optimizer will use a least-squares approach. Default is `False`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    out : callable</span>
<span class="sd">        A callable optimizer object or function configured for the specified mode and parameters.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If an unknown mode is provided.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - When `lsq` is `True`, the function wraps the optimizer in a least-squares optimizer (`LeastSquaresOptimizer`) and uses the appropriate translator class based on the mode.</span>
<span class="sd">    - For `&#39;angle&#39;` mode, the function extracts the initial position and velocity from the `param` argument and passes them to the optimizer.</span>
<span class="sd">    - The function relies on the `rvsampler` module for optimizer classes and partial function creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">lsq</span><span class="p">:</span>
        <span class="n">tdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rv</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">ParamOrbitRV</span><span class="p">,</span>
                     <span class="n">angle</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">ParamOrbitAngle</span><span class="p">,</span>
                     <span class="n">equinoctial</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">ParamOrbitEquinoctial</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rv</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">LMOptimizer</span><span class="p">,</span>
                     <span class="n">angle</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">LMOptimizerAngular</span><span class="p">,</span>
                     <span class="n">equinoctial</span><span class="o">=</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">EquinoctialLMOptimizer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tdict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown mode </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tdict</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
        <span class="n">initObsPos</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">initObsVel</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">initObsPos</span><span class="o">=</span><span class="n">initObsPos</span><span class="p">,</span> <span class="n">initObsVel</span><span class="o">=</span><span class="n">initObsVel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lsq</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">LeastSquaresOptimizer</span><span class="p">,</span> <span class="n">translatorcls</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="fit_arc_blind"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.fit_arc_blind.html#ssapy.correlate_tracks.fit_arc_blind">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">fit_arc_blind</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">damp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizerkw</span><span class="o">=</span><span class="p">{},</span> <span class="n">lsq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit an orbit to an arc.</span>

<span class="sd">    The arc can be arbitrarily long.  Orbits are initially fit to the initial</span>
<span class="sd">    two observations and extended using a geomtrically increasing time baseline.</span>
<span class="sd">    If no new observations are inside of a given baseline, the next obs is added.</span>
<span class="sd">    The fit is least-squares, Levenberg-Marquardt, given specified priors and</span>
<span class="sd">    propagator. If the factor is set to 1, the orbit is built out iteratively</span>
<span class="sd">    by satID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : array_like (n)</span>
<span class="sd">        numpy ndarray containing several fields necessary for describing</span>
<span class="sd">        observations.  rStation_GCRF (m), vStation_GCRF (m),</span>
<span class="sd">        time (astropy.time.Time or gps seconds), ra, dec,</span>
<span class="sd">        pmra, pmdec are all required fields.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        True for more verbose output</span>
<span class="sd">    mode : str</span>
<span class="sd">        Mode for fitting, must be one of &#39;rv&#39;, &#39;equinoctial&#39;, or &#39;angle&#39;.</span>
<span class="sd">        In the</span>
<span class="sd">        first case, the parameters defining the orbit are taken to be</span>
<span class="sd">        the position and velocity of the object.  In the second case,</span>
<span class="sd">        the parameters are taken to be the equinoctial elements.  In the</span>
<span class="sd">        third case, the parameters are taken to be the angular position</span>
<span class="sd">        and proper motion of the object, together with its line-of-sight</span>
<span class="sd">        range and velocity.</span>
<span class="sd">    priors : list of objects implementing ssa Prior interface</span>
<span class="sd">        any priors to be applied in fitting</span>
<span class="sd">    propagator : ssapy.propagator.Propagator instance</span>
<span class="sd">        propagator to use in fitting</span>
<span class="sd">    damp : float</span>
<span class="sd">        damp chi residuals according to pseudo-Huber loss function.  Default</span>
<span class="sd">        of -1 means do not damp</span>
<span class="sd">    orbitattr : list(str)</span>
<span class="sd">        names of additional orbit propagation keywords to guess</span>
<span class="sd">    optimizerkw : dict</span>
<span class="sd">        any extra keywords to pass to the optimizer</span>
<span class="sd">    factor : float</span>
<span class="sd">        factor for geometrically increasing time baseline (default 2)</span>
<span class="sd">    **kw : dict</span>
<span class="sd">        any extra keywords to pass to optimizer.optimize()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">factor</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Geometric factor must be greater than or equal to 1&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(arc) must be &gt; 0&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">priors</span> <span class="o">=</span> <span class="p">[</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">EquinoctialExEyPrior</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)]</span>
    <span class="n">satids_ordered</span><span class="p">,</span> <span class="n">times_ordered</span> <span class="o">=</span> <span class="n">time_ordered_satIDs</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">with_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">paramInit</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">rvsampler</span><span class="o">.</span><span class="n">circular_guess</span><span class="p">(</span>
        <span class="n">arc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">],</span> <span class="n">satids_ordered</span><span class="p">[:</span><span class="mi">2</span><span class="p">])])</span>
    <span class="n">meanpm</span> <span class="o">=</span> <span class="s1">&#39;pmra&#39;</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="n">paramInit</span> <span class="o">=</span> <span class="n">make_param_guess</span><span class="p">(</span><span class="n">paramInit</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span>  <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                                 <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
    <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch</span><span class="o">.</span><span class="n">gps</span> <span class="o">!=</span> <span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;inconsistent epoch and guess?&#39;</span><span class="p">)</span>

    <span class="n">optimizerclass</span> <span class="o">=</span> <span class="n">make_optimizer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">,</span> <span class="n">lsq</span><span class="o">=</span><span class="n">lsq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">propagator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">propagator</span> <span class="o">=</span> <span class="n">keppropagator</span>

    <span class="n">groupind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_ordered</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">times_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">times_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newgroupind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
                <span class="n">times_ordered</span> <span class="o">&lt;=</span> <span class="n">times_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newgroupind</span> <span class="o">&lt;=</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">newgroupind</span> <span class="o">=</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">groupind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgroupind</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">groupind</span><span class="p">:</span>
        <span class="n">arc0</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">],</span> <span class="n">satids_ordered</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">rvsampler</span><span class="o">.</span><span class="n">RVProbability</span><span class="p">(</span>
            <span class="n">arc0</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span>
            <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">,</span> <span class="n">meanpm</span><span class="o">=</span><span class="n">meanpm</span><span class="p">,</span> <span class="n">damp</span><span class="o">=</span><span class="n">damp</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizerclass</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[:</span><span class="n">nparam</span><span class="p">],</span>
                                   <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizerkw</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">paramInit</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">state</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">:]]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hithyperbolicorbit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hyperbolic orbit in blind&#39;</span><span class="p">)</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hithyperbolicorbit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hyperbolic orbit&#39;</span><span class="p">)</span>
        <span class="n">chi2</span> <span class="o">+=</span> <span class="mf">1e9</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">:]]),</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_arc"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.fit_arc.html#ssapy.correlate_tracks.fit_arc">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">fit_arc</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">keppropagator</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">damp</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimizerkw</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">lsq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit an orbit to an arc.</span>

<span class="sd">    See documentation for fit_arc_blind.  fit_arc implements the same</span>
<span class="sd">    interface, but takes a additional guess &amp; epoch arguments.  These specify</span>
<span class="sd">    the initial guess in appropriate units given the chosen mode.  epoch</span>
<span class="sd">    specifies the time at which this initial guess applies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : array_like (n)</span>
<span class="sd">        numpy ndarray containing several fields necessary for describing</span>
<span class="sd">        observations.  rStation_GCRF (m), vStation_GCRF (m),</span>
<span class="sd">        time (astropy.time.Time or gps seconds), ra, dec,</span>
<span class="sd">        pmra, pmdec are all required fields.</span>
<span class="sd">    guess : array_like (n_par)</span>
<span class="sd">        parameters for initial guess</span>
<span class="sd">        guess[nparam] should be the epoch in GPS</span>
<span class="sd">        guess[nparam:] should be extra parameters not optimized over</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        True for more verbose output</span>
<span class="sd">    propagator : ssapy.propagator.Propagator instance</span>
<span class="sd">        propagator to use in fitting</span>
<span class="sd">    mode : str</span>
<span class="sd">        Mode for fitting, must be one of &#39;rv&#39;, &#39;equinoctial&#39;, or &#39;angle&#39;.</span>
<span class="sd">        In the</span>
<span class="sd">        first case, the parameters defining the orbit are taken to be</span>
<span class="sd">        the position and velocity of the object.  In the second case,</span>
<span class="sd">        the parameters are taken to be the equinoctial elements.  In the</span>
<span class="sd">        third case, the parameters are taken to be the angular position</span>
<span class="sd">        and proper motion of the object, together with its line-of-sight</span>
<span class="sd">        range and velocity.</span>
<span class="sd">    priors : list of objects implementing ssa Prior interface</span>
<span class="sd">        any priors to be applied in fitting</span>
<span class="sd">    damp : float</span>
<span class="sd">        Damping used in pseudo-Huber loss function.  Default of -1 means no</span>
<span class="sd">        damping.</span>
<span class="sd">    orbitattr : list(str)</span>
<span class="sd">        Names of orbit attributes used for propagation (mass, area, ...)</span>
<span class="sd">    optimizerkw : dict</span>
<span class="sd">        any extra keywords to pass to the optimizer</span>
<span class="sd">    **kw : dict</span>
<span class="sd">        any extra keywords to pass to optimizer.optimize()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">priors</span> <span class="o">=</span> <span class="p">[</span><span class="n">rvsampler</span><span class="o">.</span><span class="n">EquinoctialExEyPrior</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)]</span>
    <span class="n">paramInit</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="n">meanpm</span> <span class="o">=</span> <span class="s1">&#39;pmra&#39;</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">))</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">rvsampler</span><span class="o">.</span><span class="n">RVProbability</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span>
                                   <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">,</span> <span class="n">meanpm</span><span class="o">=</span><span class="n">meanpm</span><span class="p">,</span>
                                   <span class="n">damp</span><span class="o">=</span><span class="n">damp</span><span class="p">)</span>
    <span class="n">optimizerclass</span> <span class="o">=</span> <span class="n">make_optimizer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">,</span> <span class="n">lsq</span><span class="o">=</span><span class="n">lsq</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizerclass</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[:</span><span class="n">nparam</span><span class="p">],</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">optimizerkw</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hithyperbolicorbit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">chi2</span> <span class="o">+=</span> <span class="mf">1e9</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">:]]),</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_arc_with_gaussian_prior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.fit_arc_with_gaussian_prior.html#ssapy.correlate_tracks.fit_arc_with_gaussian_prior">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">fit_arc_with_gaussian_prior</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cinvcholfac</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">propagator</span><span class="o">=</span><span class="n">keppropagator</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span>
                                <span class="n">lsq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">optimizerkw</span><span class="o">=</span><span class="p">{},</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit an orbit to an arc.</span>

<span class="sd">    See documentation for fit_arc_blind.  fit_arc_with_gaussian_prior</span>
<span class="sd">    implements the same interface, but takes an additional mu, cinvcholfac,</span>
<span class="sd">    and epoch arguments.  These specify a gaussian prior on the parameters.</span>
<span class="sd">    The mean and covariance of the Gaussian are given by mu and cinvcholfac,</span>
<span class="sd">    the inverse Cholesky matrix corresponding to the covariance matrix.  The</span>
<span class="sd">    initial guess is taken to be the mean of the Gaussian prior.  Presently,</span>
<span class="sd">    any other priors are assumed to have been folded into the Gaussian.</span>
<span class="sd">    epoch specifies the time at which Gaussian prior parameters are</span>
<span class="sd">    applicable.  For greatest speed, the arc should contain a single</span>
<span class="sd">    observation and the epoch should be equal to the time of that</span>
<span class="sd">    observation; then no propagations are needed in this function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : array_like (n)</span>
<span class="sd">        numpy ndarray containing several fields necessary for describing</span>
<span class="sd">        observations.  rStation_GCRF (m), vStation_GCRF (m),</span>
<span class="sd">        time (astropy.time.Time or gps seconds), ra, dec,</span>
<span class="sd">        pmra, pmdec are all required fields.</span>
<span class="sd">    mu : array_like (n_par)</span>
<span class="sd">        parameters for initial guess</span>
<span class="sd">    cinvcholfac : array_like (n_par, n_par)</span>
<span class="sd">        inverse cholesky matrix for covariance matrix</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        True for more verbose output</span>
<span class="sd">    propagator : ssapy.propagator.Propagator instance</span>
<span class="sd">        propagator to use in fitting</span>
<span class="sd">    mode : str</span>
<span class="sd">        Mode for fitting, must be one of &#39;rv&#39;, &#39;equinoctial&#39;, or &#39;angle&#39;.</span>
<span class="sd">        In the</span>
<span class="sd">        first case, the parameters defining the orbit are taken to be</span>
<span class="sd">        the position and velocity of the object.  In the second case,</span>
<span class="sd">        the parameters are taken to be the equinoctial elements.  In the</span>
<span class="sd">        third case, the parameters are taken to be the angular position</span>
<span class="sd">        and proper motion of the object, together with its line-of-sight</span>
<span class="sd">        range and velocity.</span>
<span class="sd">    orbitattr : list(str)</span>
<span class="sd">        list of strings of names of additional propagation attributes to</span>
<span class="sd">        fit (mass, area, cr, cd, ...)</span>
<span class="sd">    optimizerkw : dict</span>
<span class="sd">        any extra keywords to pass to the optimizer</span>
<span class="sd">    **kw : dict</span>
<span class="sd">        any extra keywords to pass to optimizer.optimize()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">))</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">orbit_to_param</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">,</span> <span class="n">fitonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">translator</span><span class="p">,</span> <span class="n">rStation</span><span class="o">=</span><span class="n">mu</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">vStation</span><span class="o">=</span><span class="n">mu</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">priors</span> <span class="o">=</span> <span class="p">[</span><span class="n">GaussPrior</span><span class="p">(</span><span class="n">mu</span><span class="p">[:</span><span class="n">nparam</span><span class="p">],</span> <span class="n">cinvcholfac</span><span class="p">,</span> <span class="n">translator</span><span class="o">=</span><span class="n">translator</span><span class="p">)]</span>

    <span class="n">paramInit</span> <span class="o">=</span> <span class="n">mu</span>
    <span class="n">meanpm</span> <span class="o">=</span> <span class="s1">&#39;pmra&#39;</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">rvsampler</span><span class="o">.</span><span class="n">RVProbability</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span>
                                   <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">,</span> <span class="n">meanpm</span><span class="o">=</span><span class="n">meanpm</span><span class="p">)</span>
    <span class="n">optimizerclass</span> <span class="o">=</span> <span class="n">make_optimizer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">,</span> <span class="n">lsq</span><span class="o">=</span><span class="n">lsq</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizerclass</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[:</span><span class="n">nparam</span><span class="p">],</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">optimizerkw</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hithyperbolicorbit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">chi2</span> <span class="o">+=</span> <span class="mf">1e9</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">paramInit</span><span class="p">[</span><span class="n">nparam</span><span class="p">:]]),</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="data_for_satellite"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.data_for_satellite.html#ssapy.correlate_tracks.data_for_satellite">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">data_for_satellite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">satIDList</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract data for specific satID.</span>

<span class="sd">    This helper routine takes a set of observations containing a column</span>
<span class="sd">    &#39;satID&#39;, and returns the subset of those observations for which</span>
<span class="sd">    &#39;satID&#39; is in the list satIDList.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array_like (n), including column &#39;satID&#39;</span>
<span class="sd">        data from which to select matching rows</span>
<span class="sd">    satIDList : list</span>
<span class="sd">        list of satIDs to select from data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">satID</span> <span class="ow">in</span> <span class="n">satIDList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">satID</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">satID</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;satID </span><span class="si">%d</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">satID</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="n">m0</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span></div>


<div class="viewcode-block" id="wrap_angle_difference"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.wrap_angle_difference.html#ssapy.correlate_tracks.wrap_angle_difference">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">wrap_angle_difference</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps an angle difference to a specified range.</span>

<span class="sd">    This function adjusts a given angle difference (`dl`) to lie within a range defined by `wrap` and centered around `center * wrap`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    dl : float or array-like</span>
<span class="sd">        The angle difference to be wrapped.</span>
<span class="sd">    wrap : float</span>
<span class="sd">        The wrap range. Typically represents the full range of the angle (e.g., `2 * pi` for radians or `360` for degrees).</span>
<span class="sd">    center : float, optional</span>
<span class="sd">        The center of the wrapping range, expressed as a fraction of `wrap`. Default is `0.5` (centered around `wrap / 2`).</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float or array-like</span>
<span class="sd">        The wrapped angle difference, adjusted to lie within the range `[center * wrap - wrap, center * wrap]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">((</span><span class="n">dl</span> <span class="o">+</span> <span class="n">center</span><span class="o">*</span><span class="n">wrap</span><span class="p">)</span> <span class="o">%</span> <span class="n">wrap</span><span class="p">)</span><span class="o">-</span><span class="n">center</span><span class="o">*</span><span class="n">wrap</span></div>


<div class="viewcode-block" id="radeczn"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.radeczn.html#ssapy.correlate_tracks.radeczn">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">radeczn</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes right ascension, declination, range, proper motions, range rate, and mean anomaly wrap for a given orbit and observation arc.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    orbit : object or list of objects</span>
<span class="sd">        Orbital object(s) containing orbital parameters. Must include:</span>
<span class="sd">        - `meanMotion`: Mean motion of the orbit (scalar or array-like).</span>
<span class="sd">        - `t`: Epoch time of the orbit.</span>
<span class="sd">        - `r` (optional): Orbital position vector (used to determine scalar or array-like orbit).</span>
<span class="sd">    arc : structured array</span>
<span class="sd">        Observation arc containing time and station data. Must include:</span>
<span class="sd">        - `&#39;time&#39;`: Observation times (assumed to have a `.gps` attribute).</span>
<span class="sd">        - `&#39;rStation_GCRF&#39;`: Position of the station in the GCRF frame (in meters).</span>
<span class="sd">        - `&#39;vStation_GCRF&#39;`: Velocity of the station in the GCRF frame (in meters per second).</span>
<span class="sd">        - `&#39;satID&#39;` (optional): Satellite IDs (used to determine scalar or array-like arc).</span>
<span class="sd">    **kw : dict, optional</span>
<span class="sd">        Additional keyword arguments to pass to the `ssapy.compute.radec` function.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing the following computed values:</span>
<span class="sd">        - `rr` : ndarray</span>
<span class="sd">            Right ascension values (in radians).</span>
<span class="sd">        - `dd` : ndarray</span>
<span class="sd">            Declination values (in radians).</span>
<span class="sd">        - `zz` : ndarray</span>
<span class="sd">            Range values (distance from observer to object, in meters).</span>
<span class="sd">        - `pmrr` : ndarray</span>
<span class="sd">            Proper motion in right ascension (in radians per second).</span>
<span class="sd">        - `pmdd` : ndarray</span>
<span class="sd">            Proper motion in declination (in radians per second).</span>
<span class="sd">        - `dzzdt` : ndarray</span>
<span class="sd">            Range rate (rate of change of range, in meters per second).</span>
<span class="sd">        - `nwrap` : ndarray</span>
<span class="sd">            Mean anomaly wrap values, computed as `meanMotion * (arc[&#39;time&#39;].gps - orbit.t)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">rr</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmrr</span><span class="p">,</span> <span class="n">pmdd</span><span class="p">,</span> <span class="n">dzzdt</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">radec</span><span class="p">(</span>
        <span class="n">orbit</span><span class="p">,</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
        <span class="n">obsPos</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">obsVel</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="s1">&#39;meanMotion&#39;</span><span class="p">):</span>
        <span class="n">nwrap</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">meanMotion</span><span class="o">*</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="o">-</span><span class="n">o</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scalarorbit</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">])</span>
            <span class="n">scalararc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">scalararc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">meanMotion</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">meanMotion</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">t</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scalararc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scalarorbit</span><span class="p">:</span>
            <span class="n">meanMotion</span> <span class="o">=</span> <span class="n">meanMotion</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nwrap</span> <span class="o">=</span> <span class="n">meanMotion</span><span class="o">*</span><span class="p">(</span><span class="n">tt</span><span class="o">-</span><span class="n">to</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rr</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmrr</span><span class="p">,</span> <span class="n">pmdd</span><span class="p">,</span> <span class="n">dzzdt</span><span class="p">,</span> <span class="n">nwrap</span></div>


<div class="viewcode-block" id="param_to_orbit"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.param_to_orbit.html#ssapy.correlate_tracks.param_to_orbit">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">param_to_orbit</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert parameters to Orbits.</span>

<span class="sd">    Note: Orbits are converted so that they are all bound orbits to</span>
<span class="sd">    avoid challenges with hyperbolic orbit propagation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : array_like (n, n_param)</span>
<span class="sd">        parameters for orbits</span>
<span class="sd">    mode : str</span>
<span class="sd">        parameter type, one of &#39;rv&#39;, &#39;angle&#39;, &#39;orbit&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orbitattr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">param</span><span class="p">[:,</span> <span class="n">nparam</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>

    <span class="n">propkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">,</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="n">nparam</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log10&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">val</span>
        <span class="n">propkw</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rv&#39;</span><span class="p">:</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">orbit</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">param</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">param</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span>
                                <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;equinoctial&#39;</span><span class="p">:</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">param</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">orbit</span><span class="o">.</span><span class="n">Orbit</span><span class="o">.</span><span class="n">fromEquinoctialElements</span><span class="p">(</span>
            <span class="n">aa</span><span class="p">,</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">param</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="n">t</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">radecRateObsToRV</span><span class="p">(</span>
            <span class="n">param</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">param</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="n">param</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">param</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">orbit</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">rv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown mode&#39;</span><span class="p">)</span>

    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">vnew</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">vmax</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:])[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mf">0.999</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">vnew</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">orbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">orbit</span></div>


<div class="viewcode-block" id="orbit_to_param"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.orbit_to_param.html#ssapy.correlate_tracks.orbit_to_param">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">orbit_to_param</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">rStation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert Orbits to parameters.</span>

<span class="sd">    Note: Orbits are converted so that they are all bound orbits to</span>
<span class="sd">    avoid challenges with hyperbolic orbit propagation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : array_like (n, n_param)</span>
<span class="sd">        parameters for orbits</span>
<span class="sd">    mode : str</span>
<span class="sd">        parameter type, one of &#39;rv&#39;, &#39;angle&#39;, &#39;orbit&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span>
            <span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
            <span class="n">propkw</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">squeeze</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">EARTH_MU</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vmax</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">vnew</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">vmax</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">vnew</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:])[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mf">0.999</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">vnew</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">)</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">t</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">orbitattr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">orbitparam</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">orbitattr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log10&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">5</span><span class="p">:]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">orbit</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">orbitparam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rv&#39;</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">orbitparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;equinoctial&#39;</span><span class="p">:</span>
        <span class="n">eqel</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="o">.</span><span class="n">equinoctialElements</span><span class="p">]</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">*</span><span class="n">eqel</span><span class="p">]</span> <span class="o">+</span> <span class="n">orbitparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span>
        <span class="n">rdrate</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">compute</span><span class="o">.</span><span class="n">rvObsToRaDecRate</span><span class="p">(</span>
            <span class="n">orbit</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">rStation</span><span class="p">,</span> <span class="n">vStation</span><span class="p">)</span>
        <span class="n">rdrate</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rdrate</span><span class="p">]</span>
        <span class="n">rStation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rStation</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbit</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orbit</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vStation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vStation</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbit</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orbit</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">*</span><span class="n">rdrate</span><span class="p">]</span> <span class="o">+</span> <span class="n">orbitparam</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">+</span>
                          <span class="p">[</span><span class="n">rStation</span><span class="p">,</span> <span class="n">vStation</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown mode&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fitonly</span><span class="p">:</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nparam</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">param</span></div>


<div class="viewcode-block" id="TrackBase"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackBase.html#ssapy.correlate_tracks.TrackBase">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">TrackBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set of observations fit together as an orbital track.</span>

<span class="sd">    This class represents a set of observations that are being modeled</span>
<span class="sd">    as the motion of a single object through space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    satIDs : array_like</span>
<span class="sd">        list of detection IDs considered part of this track</span>
<span class="sd">    data : array_like</span>
<span class="sd">        observations that could be part of this track.  Observations that are</span>
<span class="sd">        actually part of this track are specified in satIDs.</span>
<span class="sd">        data is must contain a number of fields used in fitting, like</span>
<span class="sd">        ra, dec, obsPos, obsVel, and time.</span>
<span class="sd">    volume : float</span>
<span class="sd">        the volume in 6-D orbital element space in which objects could be</span>
<span class="sd">        found, needed to normalize false-positive vs. new satellite odds</span>
<span class="sd">        default to a very rough number only applicable for RV parameterization</span>
<span class="sd">    propagator : ssa Propagator instance</span>
<span class="sd">        the propagator to use when propagating the orbit.  Default to None</span>
<span class="sd">        (Keplerian)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    satIDs : array_like, int</span>
<span class="sd">        the detection IDs that are part of this Track</span>
<span class="sd">    data : array_like</span>
<span class="sd">        observations that could be part of this track; see constructor</span>
<span class="sd">    volume : float</span>
<span class="sd">        the prior volume in 6-D parameter where satellites may be observed</span>
<span class="sd">    times : array_like, float</span>
<span class="sd">        the GPS times at which this object was observed</span>
<span class="sd">    mode : str</span>
<span class="sd">        the type of parameterization to use to fit the track</span>
<span class="sd">        one of &#39;rv&#39;, &#39;angle&#39;, &#39;equinoctial&#39;</span>
<span class="sd">    lnprob : float</span>
<span class="sd">        the log probability of this association of observations to an orbit</span>
<span class="sd">        contains contributions both from priors and likelihood.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># new_track_lnpenalty = -13  # is this valuable?!</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satIDs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span>
                 <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">satIDs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="o">=</span> <span class="p">(</span><span class="n">propagator</span>
                           <span class="k">if</span> <span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                           <span class="k">else</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">KeplerianPropagator</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">priorvolume</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">data_for_satellite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">satIDs</span><span class="p">)[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="o">=</span> <span class="n">orbitattr</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lnprob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lnprob</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>  <span class="c1"># prior term</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">)):</span>
            <span class="n">lnprob</span> <span class="o">+=</span> <span class="mi">0</span>
            <span class="c1"># i.e., we localized to 1 m^3 x 1 (m/s)^3...</span>
            <span class="c1"># for ~70 obs, localization is usually ~(100 m)^3*(0.01 m/s)^3</span>
            <span class="c1"># (at least formally!)</span>
            <span class="c1"># we still need to think more about treating the fact that the</span>
            <span class="c1"># errors should be more like ~40&quot; in position</span>
            <span class="c1"># maybe translating from 3 position measurements to a</span>
            <span class="c1"># position measurement (with 40&quot; uncertainties) and a velocity</span>
            <span class="c1"># measurement (with formal uncertainties only?)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># SVD seems more robust than direct np.linalg.det</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">)</span>
            <span class="n">determinant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">determinant</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">determinant</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Weird determinant!&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span>
                    <span class="c1"># pdb.set_trace()</span>
            <span class="n">lnprob</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">determinant</span><span class="p">)</span>
        <span class="c1"># rarely, the fit screws up, and gets something with a huge covariance</span>
        <span class="c1"># in all cases I&#39;ve encountered, due to hitting the hyperbolic orbit</span>
        <span class="c1"># boundary.  We adjust the covariance volume here to be the same as</span>
        <span class="c1"># the prior volume, and add a huge number to the chi2 in</span>
        <span class="c1"># fit_arc.</span>
        <span class="k">if</span> <span class="n">lnprob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lnprob</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning, huge covariance&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span>
        <span class="c1"># normalizing factor</span>
        <span class="c1"># if len(self.satIDs) == 1:</span>
        <span class="c1">#     self.initial_lnprob = lnprob</span>
        <span class="c1"># lnprob -= self.initial_lnprob</span>
        <span class="c1"># lnprob += TrackBase.new_track_lnpenalty</span>
        <span class="n">lnprob</span> <span class="o">+=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">lnprob</span>

<div class="viewcode-block" id="TrackBase.predict"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackBase.html#ssapy.correlate_tracks.TrackBase.predict">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arc0</span><span class="p">,</span> <span class="n">return_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the location and uncertainty of this object at future times.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arc0 : array_like, structure array</span>
<span class="sd">            must contain fields:</span>
<span class="sd">            time: future times (GPS) (float)</span>
<span class="sd">            rStation_GCRF: GCRF position of observer at future time (3, float)</span>
<span class="sd">            vStation_GCRF: GCRF velocity of observer at future time (3, float)</span>
<span class="sd">        return_sigma : bool</span>
<span class="sd">            if True, also return the sigma points used to compute the</span>
<span class="sd">            future covariance</span>
<span class="sd">        return_nwrap : bool</span>
<span class="sd">            if True, also return the number of orbital wrappings of the</span>
<span class="sd">            sigma points.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mean, covar, fsigma</span>
<span class="sd">        mean : array_like (4, n)</span>
<span class="sd">            ra, dec, dra/dt*cos(dec), ddec/dt at future times (rad, rad/s)</span>
<span class="sd">        covar : array_like (4, 4, n)</span>
<span class="sd">            covariance of mean parameters at future times</span>
<span class="sd">        fsigma : array_like (4, 13, n)</span>
<span class="sd">            13 sigma points used to compute covar</span>
<span class="sd">            fsigma[:, 0, :] is identical to mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nparam</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">fixed_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">nparam</span>
        <span class="n">fsigma</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">sigma_points</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagaterdz</span><span class="p">,</span> <span class="n">arc0</span><span class="o">=</span><span class="n">arc0</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="n">return_nwrap</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">,</span> <span class="n">fixed_dimensions</span><span class="o">=</span><span class="n">fixed_dimensions</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">fsigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="n">dmean</span> <span class="o">=</span> <span class="n">fsigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span><span class="o">-</span><span class="n">mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="n">dmean</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dmean</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">dmean</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">dmean</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dmean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="c1"># next step here would be to do some tangent</span>
        <span class="c1"># plane projections (stereoscopic?) so that we don&#39;t have</span>
        <span class="c1"># issues at the pole or with wraps in ra.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mean</span><span class="p">,</span> <span class="n">covar</span>
        <span class="k">if</span> <span class="n">return_sigma</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="p">(</span><span class="n">fsigma</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="TrackBase.gate"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackBase.html#ssapy.correlate_tracks.TrackBase.gate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arc</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute chi^2 that this track could be associated with arc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arc : array_like, structure array</span>
<span class="sd">            must contain fields:</span>
<span class="sd">            time: future time (GPS) (float)</span>
<span class="sd">            rStation_GCRF: GCRF position of observer at future time (3, float)</span>
<span class="sd">            vStation_GCRF: GCRF velocity of observer at future time (3, float)</span>
<span class="sd">            ra: observed ra (float)</span>
<span class="sd">            pmra: observed proper motion in ra (float)</span>
<span class="sd">            dec: observed dec (float)</span>
<span class="sd">            pmdec: observed proper motion in dec (float)</span>
<span class="sd">            dra: uncertainty in ra (float)</span>
<span class="sd">            ddec: uncertainty in dec (float)</span>
<span class="sd">            dpmra: uncertainty in proper motion in ra (float)</span>
<span class="sd">            dpmdec uncertainty in proper motion in dec (float)</span>

<span class="sd">        return_nwrap : bool</span>
<span class="sd">            if True, also return the standard deviation of the number of</span>
<span class="sd">            orbits the object could have made at the time of observation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chi2, nwrapsig</span>
<span class="sd">        chi2 : float</span>
<span class="sd">            The chi-squared implied by associating this observation with this</span>
<span class="sd">            track.</span>
<span class="sd">        nwrapsig : float</span>
<span class="sd">            if return_nwrap, the standard deviation of the number of orbits the</span>
<span class="sd">            object could have made at the time of observation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arc0</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># just take the first tracklet at the moment...</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">covar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">arc0</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># drop nwrap</span>
        <span class="n">covar</span><span class="p">,</span> <span class="n">nwrapcovar</span> <span class="o">=</span> <span class="n">covar</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">covar</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">covar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">cd</span>
        <span class="n">covar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">cd</span>
        <span class="n">covarobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span> <span class="o">+</span> <span class="n">covarobs</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">covar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">area</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cinv</span> <span class="o">=</span> <span class="mf">1e-30</span>
        <span class="n">measvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="n">dvec</span> <span class="o">=</span> <span class="n">measvec</span> <span class="o">-</span> <span class="n">mean</span>
        <span class="n">dvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">cd</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dvec</span><span class="p">,</span> <span class="n">cinv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dvec</span><span class="p">)</span>
        <span class="c1"># we should choose a space other than ra/dec, where things</span>
        <span class="c1"># are coming closer to following lines, and so are more Gaussian.</span>
        <span class="c1"># note however: satellites are not following great circles,</span>
        <span class="c1"># so even in gnomonic projection about central point, our</span>
        <span class="c1"># points won&#39;t quite follow a straight line.</span>
        <span class="c1"># but it should at least be much better than whatever we&#39;re doing now!</span>
        <span class="c1"># or stereoscopic, with NP centered at the observation?  Great circles</span>
        <span class="c1"># through projection point are lines.</span>
        <span class="c1"># simpler: line up track orbital plane with projection equator.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">chi2</span>
        <span class="k">if</span> <span class="n">return_nwrap</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nwrapcovar</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="TrackBase.propagaterdz"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackBase.html#ssapy.correlate_tracks.TrackBase.propagaterdz">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">propagaterdz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">arc0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propagate param to times and locations specified in arc0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param : array_like</span>
<span class="sd">            parameters corresponding to self.mode for orbit to propagate</span>
<span class="sd">        arc0 : arary_like, must contain observation fields</span>
<span class="sd">            array containing fields specifying times and observer locations</span>
<span class="sd">            to which track fit should be propagated.</span>
<span class="sd">        return_nwrap : bool</span>
<span class="sd">            if True, additionally return nwrap</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array([rr, pmrr, dd, pmdd, nwrap])</span>
<span class="sd">        rr : ra at future times, radians</span>
<span class="sd">        dd : dec at future times, radians</span>
<span class="sd">        pmrr : proper motion in ra at future times, rad / s</span>
<span class="sd">        pmdd : proper motion in dec at future times, rad / s</span>
<span class="sd">        nwrap : number of orbits completed.  Only provided if return_nwrap</span>
<span class="sd">            is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="n">param_to_orbit</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">rr</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">pmrr</span><span class="p">,</span> <span class="n">pmdd</span><span class="p">,</span> <span class="n">dzzdt</span><span class="p">,</span> <span class="n">nwrap</span> <span class="o">=</span> <span class="n">radeczn</span><span class="p">(</span>
            <span class="n">orb</span><span class="p">,</span> <span class="n">arc0</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">pmrr</span><span class="p">,</span> <span class="n">pmdd</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_nwrap</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="p">[</span><span class="n">nwrap</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackBase.update"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackBase.html#ssapy.correlate_tracks.TrackBase.update">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">rStation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shift this track to a new time.</span>

<span class="sd">        Only implemented for numerical propagators where time-shifting can provide a big</span>
<span class="sd">        speed up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">((</span><span class="s1">&#39;Track, chi2: </span><span class="si">%.2e</span><span class="s1">, lnprob: </span><span class="si">%.2e</span><span class="s1">, tracklets:&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span><span class="p">))</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">))</span></div>


<div class="viewcode-block" id="Track"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Track.html#ssapy.correlate_tracks.Track">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Track</span><span class="p">(</span><span class="n">TrackBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set of observations to be fit as an object moving through space.</span>

<span class="sd">    Subclasses TrackBase, which could have other implementations</span>
<span class="sd">    (for example, a subclass that doesn&#39;t fit the whole track simultaneously,</span>
<span class="sd">    but instead approximates past information with a single Gaussian</span>
<span class="sd">    prior on the parameters).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    satIDs : see TrackBase</span>
<span class="sd">    data : see TrackBase</span>
<span class="sd">    guess : array_like, float</span>
<span class="sd">        guess of initial parameters fitting orbit</span>
<span class="sd">    initial_lnprob : float</span>
<span class="sd">        adjust probability of this track by initial_lnprob (default: 0)</span>
<span class="sd">    priors : rvsampler.Prior instance</span>
<span class="sd">        list of priors to use when fitting this track</span>
<span class="sd">    mode : str</span>
<span class="sd">        fitting mode to use.  One of &#39;rv&#39;, &#39;angle&#39;, or &#39;equinoctial&#39;</span>
<span class="sd">        parameters have different meanings in these modes</span>
<span class="sd">    propagator : Propagator instance</span>
<span class="sd">        ssa Propagator instance to use for propagation.  Default None (Keplerian)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satIDs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_lnprob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">satIDs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">,</span>
                         <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_lnprob</span> <span class="o">=</span> <span class="n">initial_lnprob</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chi2</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fit_arc</span><span class="p">(</span>
                <span class="n">data_for_satellite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">),</span> <span class="n">guess</span><span class="p">,</span>
                <span class="n">maxfev</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span>
                <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chi2</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fit_arc_blind</span><span class="p">(</span>
                <span class="n">data_for_satellite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">),</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span>
                <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">chi2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;covar&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="Track.gaussian_approximation"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Track.html#ssapy.correlate_tracks.Track.gaussian_approximation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">gaussian_approximation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Gaussian approximation of this track.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TrackGauss, giving Gaussian approximation of this track.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determinant = np.sqrt(np.linalg.det(2*np.pi*self.covar))</span>
        <span class="c1"># this is supposed to be a volume</span>
        <span class="c1"># when it&#39;s small enough, or when it&#39;s &quot;close enough&quot; to actually being</span>
        <span class="c1"># Gaussian, we want to make a Gaussian approximation.</span>
        <span class="c1"># but we really want, e.g., a fractional uncertainty in a.</span>
        <span class="c1"># I don&#39;t really know how to do this.</span>
        <span class="c1"># let&#39;s just say that we need at least four observations.</span>
        <span class="c1"># can do some tests with real tracks.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">propagator</span> <span class="k">if</span> <span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">:</span>
                <span class="c1"># refitting with a better propagator</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">Track</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                          <span class="n">initial_lnprob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_lnprob</span><span class="p">,</span>
                          <span class="n">priors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                          <span class="n">propagator</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">param</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">covar</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">chi2</span>
            <span class="k">return</span> <span class="n">TrackGauss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span>
                              <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># don&#39;t bother approximating if the track is too short.</span>
            <span class="k">return</span> <span class="bp">self</span></div>
        <span class="c1"># maybe we could just always approximate the track?</span>
        <span class="c1"># since the initial track is &quot;on epoch&quot;, i.e., not propagated,</span>
        <span class="c1"># it&#39;s going to be some ~cone in xyz, vxvyvz.</span>
        <span class="c1"># that&#39;s not _great_ to approximate as a Gaussian, but maybe not</span>
        <span class="c1"># horrible?</span>

<div class="viewcode-block" id="Track.addto"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Track.html#ssapy.correlate_tracks.Track.addto">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">addto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a detection to this track.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        satID : int or list(int)</span>
<span class="sd">            the detection ID of the observation to add to this track</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A new Track, including the additional observation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newsatidlist</span> <span class="o">=</span> <span class="n">satid</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">satid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">satid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Track</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="o">+</span><span class="n">newsatidlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                     <span class="n">initial_lnprob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_lnprob</span><span class="p">,</span>
                     <span class="n">priors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                     <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrackGauss"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackGauss.html#ssapy.correlate_tracks.TrackGauss">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">TrackGauss</span><span class="p">(</span><span class="n">TrackBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set of observations to be fit as an object moving through space.</span>

<span class="sd">    Subclasses TrackBase.  This implementation does not fit the entire</span>
<span class="sd">    track simultaneously, but instead approximates past tracklets with</span>
<span class="sd">    a single Gaussian prior on the parameters.  This information is then</span>
<span class="sd">    updated with each new observation in a Kalman-filter approach.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    satIDs : see TrackBase</span>
<span class="sd">    data : see TrackBase</span>
<span class="sd">    param : array_like, float</span>
<span class="sd">        mean of Gaussian</span>
<span class="sd">    covar : array_like, float</span>
<span class="sd">        covariance of Gaussian</span>
<span class="sd">    chi2 : float</span>
<span class="sd">        chi2 of fit at center of Gaussian</span>
<span class="sd">    mode : str</span>
<span class="sd">        fitting mode to use.  One of &#39;rv&#39;, &#39;angle&#39;, or &#39;equinoctial&#39;</span>
<span class="sd">        parameters have different meanings in these modes</span>
<span class="sd">    propagator : Propagator instance</span>
<span class="sd">        ssa Propagator instance to use for propagation.  Default None</span>
<span class="sd">        (Keplerian)</span>
<span class="sd">    priors : list of Priors instances</span>
<span class="sd">        priors used in initially fitting this orbit.  Their influence</span>
<span class="sd">        should now be completely recorded in param + covar, but they are</span>
<span class="sd">        recorded here for reference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satIDs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span>
                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">satIDs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">,</span>
                         <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">chi2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">covar</span><span class="p">)):</span>
            <span class="n">finitecovar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f4&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">+=</span> <span class="mf">1e9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finitecovar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cinvcholfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">finitecovar</span><span class="p">))</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sigma_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">nparam</span>
            <span class="n">sigma_points</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">sigma_points</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">finitecovar</span><span class="p">,</span>
                                                  <span class="n">fixed_dimensions</span><span class="o">=</span><span class="n">fixed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_points</span> <span class="o">=</span> <span class="n">sigma_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span>

<div class="viewcode-block" id="TrackGauss.gaussian_approximation"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackGauss.html#ssapy.correlate_tracks.TrackGauss.gaussian_approximation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">gaussian_approximation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propagator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Gaussian approximation of this track.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.  No op; this track already is a Gaussian approximation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">propagator</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="TrackGauss.update"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackGauss.html#ssapy.correlate_tracks.TrackGauss.update">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rStation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move this track to a different epoch.</span>

<span class="sd">        Does not bother updating if t is different from the current</span>
<span class="sd">        track time by less than one microsecond.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : astropy.time.Time</span>
<span class="sd">           epoch for new TrackGauss</span>
<span class="sd">        rStation : array_like (3)</span>
<span class="sd">           position of station at new time (m, GCRF); required if</span>
<span class="sd">           mode == &#39;angle&#39;</span>
<span class="sd">        vStation : array_like (3)</span>
<span class="sd">           velocity of station at new time (m, GCRF); required if</span>
<span class="sd">           mode == &#39;angle&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">oldepoch</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">nparam</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">oldepoch</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="c1"># don&#39;t bother propagating to a new time for times less than one</span>
            <span class="c1"># microsecond.</span>
            <span class="k">return</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="n">param_to_orbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_points</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                             <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">neworb</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rStation</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">rStation</span> <span class="o">=</span> <span class="n">rStation</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">vStation</span> <span class="o">=</span> <span class="n">vStation</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">new_sigma</span> <span class="o">=</span> <span class="n">orbit_to_param</span><span class="p">(</span><span class="n">neworb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                                   <span class="n">rStation</span><span class="o">=</span><span class="n">rStation</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="n">vStation</span><span class="p">,</span>
                                   <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">new_param</span> <span class="o">=</span> <span class="n">new_sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">((</span><span class="n">new_sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="n">nparam</span><span class="p">]</span><span class="o">-</span><span class="n">new_param</span><span class="p">[:</span><span class="n">nparam</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                           <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">new_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">new_covar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cinvcholfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_points</span> <span class="o">=</span> <span class="n">new_sigma</span></div>

<div class="viewcode-block" id="TrackGauss.at"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackGauss.html#ssapy.correlate_tracks.TrackGauss.at">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rStation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Gaussian approximation of this track at different epoch.</span>

<span class="sd">        This just copies the track and then updates it to be at the new time.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : astropy.time.Time</span>
<span class="sd">           epoch for new TrackGauss</span>
<span class="sd">        rStation : array_like (3)</span>
<span class="sd">           position of station at new time (m, GCRF); required if</span>
<span class="sd">           mode == &#39;angle&#39;</span>
<span class="sd">        vStation : array_like (3)</span>
<span class="sd">           velocity of station at new time (m, GCRF); required if</span>
<span class="sd">           mode == &#39;angle&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Gaussian-approximated track (TrackGauss) at new time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">newtrack</span> <span class="o">=</span> <span class="n">TrackGauss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">covar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                              <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span>
                              <span class="n">sigma_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_points</span><span class="p">,</span>
                              <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">newtrack</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">rStation</span><span class="o">=</span><span class="n">rStation</span><span class="p">,</span> <span class="n">vStation</span><span class="o">=</span><span class="n">vStation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newtrack</span></div>

<div class="viewcode-block" id="TrackGauss.addto"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.TrackGauss.html#ssapy.correlate_tracks.TrackGauss.addto">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">addto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a detection to this track.</span>

<span class="sd">        This also shifts the track&#39;s epoch to the epoch of the added</span>
<span class="sd">        observation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        satID : int</span>
<span class="sd">            the detection ID of the observation to add to this track</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A new TrackGauss, including the additional observation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newsatidlist</span> <span class="o">=</span> <span class="n">satid</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">satid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">satid</span><span class="p">]</span>
        <span class="n">arc</span> <span class="o">=</span> <span class="n">data_for_satellite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">newsatidlist</span><span class="p">)</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[:</span><span class="n">nparam</span><span class="p">]</span>
        <span class="n">oldepoch</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">nparam</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">newsatidlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lastind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">)]</span>
        <span class="n">newepoch</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">lastind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">newepoch</span><span class="o">.</span><span class="n">gps</span> <span class="o">!=</span> <span class="n">oldepoch</span><span class="o">.</span><span class="n">gps</span><span class="p">:</span>
            <span class="n">newtrack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">newepoch</span><span class="p">,</span>
                               <span class="n">rStation</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="n">lastind</span><span class="p">],</span>
                               <span class="n">vStation</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="n">lastind</span><span class="p">])</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">newtrack</span><span class="o">.</span><span class="n">param</span>
            <span class="n">cinvcholfac</span> <span class="o">=</span> <span class="n">newtrack</span><span class="o">.</span><span class="n">cinvcholfac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span>
            <span class="n">cinvcholfac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cinvcholfac</span>
        <span class="n">chi2new</span><span class="p">,</span> <span class="n">paramnew</span><span class="p">,</span> <span class="n">resnew</span> <span class="o">=</span> <span class="n">fit_arc_with_gaussian_prior</span><span class="p">(</span>
            <span class="n">arc</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">cinvcholfac</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="n">covarnew</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">resnew</span><span class="p">,</span> <span class="s1">&#39;covar&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">covarnew</span><span class="p">)):</span>
            <span class="n">covarnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">TrackGauss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satIDs</span><span class="o">+</span><span class="n">newsatidlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                          <span class="n">paramnew</span><span class="p">,</span> <span class="n">covarnew</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="o">+</span><span class="n">chi2new</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                          <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span>
                          <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="fit_arc_blind_via_track"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.fit_arc_blind_via_track.html#ssapy.correlate_tracks.fit_arc_blind_via_track">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">fit_arc_blind_via_track</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">reset_if_too_uncertain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span>
                            <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                            <span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit a series of detections using the Track interface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : ndarry with many fields</span>
<span class="sd">        The observations to fit.  Must contain many fields (ra, dec, ...)</span>
<span class="sd">    propagator : Propagator instance</span>
<span class="sd">        Propagator to use for orbit propagation.  Default None (Keplerian).</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        print additional information during fitting if True</span>
<span class="sd">    reset_if_too_uncertain : bool</span>
<span class="sd">        if the uncertainty in the number of wraps grows to be greater than</span>
<span class="sd">        pi, start track fitting over, ignoring old tracklets.</span>
<span class="sd">    factor : float</span>
<span class="sd">        factor for geometrically increasing time baseline (default 1)</span>
<span class="sd">    order : str</span>
<span class="sd">        order to process observations; default &#39;forward&#39;.  &#39;backward&#39;</span>
<span class="sd">        processes observations in reverse chronological order.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tracklist</span>
<span class="sd">    A list of Tracks, giving the fits to the track as each observation</span>
<span class="sd">    in added sequentially in time to the fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">factor</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Geometric factor must be greater than or equal to 1&quot;</span>

    <span class="n">satids_ordered</span><span class="p">,</span> <span class="n">times_ordered</span> <span class="o">=</span> <span class="n">time_ordered_satIDs</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">with_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">tracklist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">approximate</span> <span class="k">else</span> <span class="n">propagator</span>
    <span class="n">track0</span> <span class="o">=</span> <span class="n">Track</span><span class="p">([</span><span class="n">satids_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">arc</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                   <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
    <span class="n">tracklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track0</span><span class="p">)</span>

    <span class="n">resetnwrap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span>

    <span class="n">groupind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">times_ordered</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">times_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">times_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newgroupind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
                <span class="n">times_ordered</span> <span class="o">&lt;=</span> <span class="n">times_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newgroupind</span> <span class="o">&lt;=</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">newgroupind</span> <span class="o">=</span> <span class="n">groupind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">groupind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgroupind</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupind</span><span class="p">)):</span>
        <span class="n">arc0</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">],</span> <span class="n">satids_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="n">i</span><span class="p">]])]</span>
        <span class="n">chi2</span><span class="p">,</span> <span class="n">nwrapsig</span> <span class="o">=</span> <span class="n">tracklist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gate</span><span class="p">(</span><span class="n">arc0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="p">((</span><span class="n">reset_if_too_uncertain</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nwrapsig</span> <span class="o">&gt;</span> <span class="n">resetnwrap</span><span class="p">))</span> <span class="ow">or</span>
                 <span class="p">(</span><span class="n">tracklist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">chi2</span> <span class="o">&gt;=</span> <span class="mf">1e9</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">resetstr</span> <span class="o">=</span> <span class="s1">&#39;resetting&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resetstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">times_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">times_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chi2</span><span class="si">:</span><span class="s1">5.1f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nwrapsig</span><span class="si">:</span><span class="s1">8.4f</span><span class="si">}</span><span class="s1"> dt:</span><span class="si">{</span><span class="n">dt</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">24</span><span class="si">:</span><span class="s1">5.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">resetstr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">Track</span><span class="p">(</span><span class="n">arc0</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">],</span> <span class="n">arc</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span>
                          <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">orbitattr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newsatidlist</span> <span class="o">=</span> <span class="n">satids_ordered</span><span class="p">[</span><span class="n">groupind</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">groupind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">tracklist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addto</span><span class="p">(</span><span class="n">newsatidlist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">approximate</span><span class="p">:</span>
                <span class="n">track</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">gaussian_approximation</span><span class="p">(</span><span class="n">propagator</span><span class="p">)</span>
        <span class="n">tracklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tracklist</span></div>


<div class="viewcode-block" id="combinatoric_lnprior"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.combinatoric_lnprior.html#ssapy.correlate_tracks.combinatoric_lnprior">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">combinatoric_lnprior</span><span class="p">(</span><span class="n">nsat</span><span class="p">,</span> <span class="n">ntrack</span><span class="p">,</span> <span class="n">ndet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prior probability of assigning detections to tracks of satellites.</span>

<span class="sd">    This function intends to give the prior probability that ndet detections</span>
<span class="sd">    of nsat total satellites correspond to ntrack satellites.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nsat : int</span>
<span class="sd">        number of satellites that could possibly be observed</span>
<span class="sd">    ntrack : int</span>
<span class="sd">        number of tracks in current solution</span>
<span class="sd">    ndet : int</span>
<span class="sd">        number of detections of these satellites</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># I believe the desired factor is:</span>
    <span class="c1"># 1/N_sat^(N_detections - 1) * (N_sat - 1)! / (N_sat - N_objects)!</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">special</span>
    <span class="n">lnprior</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ndet</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nsat</span><span class="p">)</span>
    <span class="n">lnprior</span> <span class="o">+=</span> <span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">nsat</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">nsat</span><span class="o">-</span><span class="n">ntrack</span><span class="p">)</span>
    <span class="c1"># may have to think about an approximation to N_sat!/(N_sat - N_objects)!</span>
    <span class="c1"># that doesn&#39;t rely on as much cancellation as the above...</span>
    <span class="k">return</span> <span class="n">lnprior</span></div>


<div class="viewcode-block" id="time_ordered_satIDs"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.time_ordered_satIDs.html#ssapy.correlate_tracks.time_ordered_satIDs">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">time_ordered_satIDs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">with_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Give satIDs in data in order of observation.</span>
<span class="sd">    Optionally includes first times for each ID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array_like</span>
<span class="sd">        the data to consider</span>
<span class="sd">    with_time : bool</span>
<span class="sd">        Option to also output list of corresponding gps times</span>
<span class="sd">    order : &#39;forward&#39; or &#39;backward&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of satIDs in data, ordered by observation time</span>

<span class="sd">    list of corresponding gps times of first obs per ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">usedtracklet</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">satid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">usedtracklet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">satid</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">usedtracklet</span><span class="p">[</span><span class="n">satid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">satid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_time</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">satid</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">if</span> <span class="n">with_time</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">times</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Hypothesis"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Hypothesis.html#ssapy.correlate_tracks.Hypothesis">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Hypothesis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assignment of detections to multiple tracks.</span>

<span class="sd">    This class represents an assignment of detections to multiple tracks.  The</span>
<span class="sd">    goal of Multiple Hypothesis Tracking to to find the Hypothesis (track</span>
<span class="sd">    assignment) that has the highest likelihood.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tracks : list of Tracks</span>
<span class="sd">        The tracks in the hypothesis.  Each track must correspond to</span>
<span class="sd">        different observations, and all observations under consideration</span>
<span class="sd">        must be accounted for</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tracks : list</span>
<span class="sd">        the tracks in this hypothesis</span>
<span class="sd">    lnprob : float</span>
<span class="sd">        the log probability of this hypothesis</span>
<span class="sd">    nsat : int</span>
<span class="sd">        the total number of satellites in the sky that could be observed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracks</span><span class="p">,</span> <span class="n">nsat</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">lnprob</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">])</span>
        <span class="n">ndet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntracklet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span> <span class="o">+=</span> <span class="n">combinatoric_lnprior</span><span class="p">(</span><span class="n">nsat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">),</span> <span class="n">ndet</span><span class="p">)</span>
        <span class="c1"># not clear this has value.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsat</span> <span class="o">=</span> <span class="n">nsat</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">()</span>

<div class="viewcode-block" id="Hypothesis.summarize"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Hypothesis.html#ssapy.correlate_tracks.Hypothesis.summarize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarize the Hypothesis as a string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Include information about each track in the hypothesis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A string summarizing the hypothesis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Hypothesis with </span><span class="si">%d</span><span class="s1"> tracks:&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;, lnprob: </span><span class="si">%7.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Hypothesis.difference"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Hypothesis.html#ssapy.correlate_tracks.Hypothesis.difference">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the difference between two hypotheses.</span>

<span class="sd">        Often two hypotheses are very similar.  This makes it easier to</span>
<span class="sd">        inspect only the differences between them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hypothesis : Hypothesis</span>
<span class="sd">            hypothesis to which to compare this hypothesis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matchinother</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="n">matchinsame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">hypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">matchinsame</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">matchinother</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dlnprob: </span><span class="si">%5.3f</span><span class="s1">, </span><span class="si">%d</span><span class="s1"> tracks in common&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnprob</span><span class="o">-</span><span class="n">hypothesis</span><span class="o">.</span><span class="n">lnprob</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">matchinsame</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tracks only in 1:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="o">~</span><span class="n">matchinsame</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tracks only in 2:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hypothesis</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="o">~</span><span class="n">matchinother</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">hypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="Hypothesis.ntracklet"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Hypothesis.html#ssapy.correlate_tracks.Hypothesis.ntracklet">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">ntracklet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of observations in tracks in the hypothesis.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="Hypothesis.addto"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.Hypothesis.html#ssapy.correlate_tracks.Hypothesis.addto">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">addto</span><span class="p">(</span><span class="n">hypothesis</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">oldtrack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new track to a Hypothesis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hypothesis : Hypothesis</span>
<span class="sd">            hypothesis to which to add</span>
<span class="sd">        track : Track</span>
<span class="sd">            track to add to hypothesis</span>
<span class="sd">        oldtrack : Track</span>
<span class="sd">            track to remove from hypothesis, if the new track updates the</span>
<span class="sd">            old track.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new Hypothesis, with track added, replacing oldtrack if oldtrack is</span>
<span class="sd">        not None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newtracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">oldtrack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">oldtrack</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">oldtrackind</span> <span class="o">=</span> <span class="n">hypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">oldtrack</span><span class="p">)</span>
            <span class="n">newtracks</span><span class="p">[</span><span class="n">oldtrackind</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Hypothesis</span><span class="p">(</span><span class="n">newtracks</span><span class="p">,</span> <span class="n">nsat</span><span class="o">=</span><span class="n">hypothesis</span><span class="o">.</span><span class="n">nsat</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MHT"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">MHT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multiple Hypothesis Tracking of many hypotheses explaining data.</span>

<span class="sd">    This class manages the assessment of which hypothesis are most likely</span>
<span class="sd">    to explain data, building a set of tracks observation by observation.</span>

<span class="sd">    Initialize the MHT with the data, do mht.run(), and inspect the most</span>
<span class="sd">    likely hypotheses using [h.lnprob for h in mht.hypotheses].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array_like[N]</span>
<span class="sd">        data to model.  Must contain angles of observations, observer</span>
<span class="sd">        locations and velocities, times, detection IDs, etc.</span>
<span class="sd">    nsat : int</span>
<span class="sd">        total number of satellites in the sky.  Affects the overall</span>
<span class="sd">        prior and the preference for new tracks vs. additional assignments</span>
<span class="sd">        to existing tracks.</span>
<span class="sd">    truth : dict</span>
<span class="sd">        when true assignments are known, this argument can provide debug</span>
<span class="sd">        information about when the tracker has lost the true assignment</span>
<span class="sd">    hypotheses : list of Hypothesis</span>
<span class="sd">        initialize the MHT with this existing list of Hypotheses.</span>
<span class="sd">        Default None.</span>
<span class="sd">    propagator : instance of ssa Propagator</span>
<span class="sd">        propagator to use.  Default to None (Keplerian)</span>
<span class="sd">    fitonly : ndarray[N] bool</span>
<span class="sd">        entries in data to fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nsat</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hypotheses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">propagator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rv&#39;</span><span class="p">,</span> <span class="n">fitonly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fitonly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fitonly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">satids</span> <span class="o">=</span> <span class="n">time_ordered_satIDs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">fitonly</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsat</span> <span class="o">=</span> <span class="n">nsat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="n">truth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span> <span class="o">=</span> <span class="n">orbitattr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="o">=</span> <span class="p">(</span><span class="n">propagator</span>
                           <span class="k">if</span> <span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                           <span class="k">else</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">KeplerianPropagator</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newly_dead_tracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approximate</span> <span class="o">=</span> <span class="n">approximate</span>
        <span class="k">if</span> <span class="n">hypotheses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span> <span class="o">=</span> <span class="p">[</span><span class="n">Hypothesis</span><span class="p">([],</span> <span class="n">nsat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsat</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="n">hypotheses</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hyp</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span> <span class="o">=</span> <span class="n">hypotheses</span>

<div class="viewcode-block" id="MHT.run"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the MHT analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        first : int</span>
<span class="sd">            First tracklet to consider</span>
<span class="sd">        last : int</span>
<span class="sd">            Last tracklet to consider</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            print extra progress information while running</span>
<span class="sd">        **kw : dict</span>
<span class="sd">            extra keyword arguments to pass to MHT.prune.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tsatid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">satids</span>
        <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tsatid</span><span class="p">)</span>
        <span class="n">tsatid</span> <span class="o">=</span> <span class="n">tsatid</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
            <span class="n">tsatid</span> <span class="o">=</span> <span class="n">tsatid</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">satid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tsatid</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">ndead</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Tracklet </span><span class="si">%5d</span><span class="s1"> of </span><span class="si">%5d</span><span class="s1">, </span><span class="si">%5d</span><span class="s1"> live tracks &#39;</span>
                       <span class="s1">&#39;(</span><span class="si">%5d</span><span class="s1"> dead), </span><span class="si">%4d</span><span class="s1"> fit, </span><span class="si">%5d</span><span class="s1"> hypotheses&#39;</span><span class="p">)</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">satids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">)</span><span class="o">-</span><span class="n">ndead</span><span class="p">,</span>
                       <span class="n">ndead</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_tracklet</span><span class="p">(</span><span class="n">satid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">satid</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>

<div class="viewcode-block" id="MHT.add_tracklet"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.add_tracklet">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_tracklet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satid</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an observation from data to the MHT analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        satid : int</span>
<span class="sd">            the ID of the observation to add.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newhypotheses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tracklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">newtrack2hyp</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracklist</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tooshorttogate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newly_dead_tracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">arc</span> <span class="o">=</span> <span class="n">data_for_satellite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">satid</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="p">((</span><span class="s1">&#39;dpmra&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arc</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="ow">or</span>
             <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])))):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Just one observation, skipping tracklet </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">satid</span><span class="p">)</span>
            <span class="c1"># used to match these, but not generate new tracks for these.</span>
            <span class="c1"># this is problematic since then hypotheses aren&#39;t directly</span>
            <span class="c1"># comparable to one another; they don&#39;t explain the same</span>
            <span class="c1"># numbers of tracks</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">track</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">rStation</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">vStation</span><span class="o">=</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">gatechi2</span><span class="p">,</span> <span class="n">nwrapsig</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">gate</span><span class="p">(</span><span class="n">arc</span><span class="p">,</span> <span class="n">return_nwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">outofgatechi2</span> <span class="o">=</span> <span class="mi">8</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">goodtrack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">truth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">truth</span><span class="p">[</span><span class="n">satid</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">track</span><span class="o">.</span><span class="n">satIDs</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">goodtrack</span> <span class="ow">and</span> <span class="n">gatechi2</span> <span class="o">&gt;</span> <span class="n">outofgatechi2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning, excluding real track by gate&#39;</span><span class="p">,</span> <span class="n">gatechi2</span><span class="p">)</span>
                    <span class="c1"># pdb.set_trace()</span>
                <span class="k">elif</span> <span class="n">goodtrack</span><span class="p">:</span>
                    <span class="c1"># print(&#39;real gate chi2: %5.2f&#39; % gatechi2)</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">gatechi2</span> <span class="o">&gt;</span> <span class="n">outofgatechi2</span><span class="p">:</span>
                <span class="c1"># if it&#39;s hard to add this tracklet to this track, don&#39;t</span>
                <span class="c1"># bother.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">nwrapsig</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">:</span>
                <span class="c1"># at this point, there&#39;s real danger of fitting the wrong</span>
                <span class="c1"># number of orbits to this point.  Don&#39;t do that; kill the</span>
                <span class="c1"># track instead, and hope we get better sampling of it later.</span>
                <span class="c1"># we could do better explicitly trying multiple sets of orbits</span>
                <span class="c1"># there&#39;s currently an assumption that a track is uniquely</span>
                <span class="c1"># defined by a set of satID; this would require opening another</span>
                <span class="c1"># dimension, or, better, playing some games with chi2 and covar</span>
                <span class="c1"># in the track, letting those try to track the multimodal</span>
                <span class="c1"># posteriors.</span>
                <span class="n">track</span><span class="o">.</span><span class="n">dead</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_newly_dead_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">gatechi2</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
                <span class="n">tooshorttogate</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># pdb.set_trace()</span>
            <span class="k">if</span> <span class="n">gatechi2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="c1"># pdb.set_trace()</span>
                <span class="k">pass</span>
            <span class="n">newtrack</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">addto</span><span class="p">(</span><span class="n">satid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">newtrack</span><span class="o">.</span><span class="n">chi2</span> <span class="o">-</span> <span class="n">track</span><span class="o">.</span><span class="n">chi2</span> <span class="o">&gt;</span> <span class="n">outofgatechi2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximate</span><span class="p">:</span>
                <span class="n">newtrack</span> <span class="o">=</span> <span class="n">newtrack</span><span class="o">.</span><span class="n">gaussian_approximation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gatechi2</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
                <span class="c1"># print(track.satIDs, &#39;%5.1f %5.1f %5.1f %5.1f %5.1f&#39; % (gatechi2, track.chi2, track.lnprob(),</span>
                <span class="c1">#       newtrack.chi2, newtrack.lnprob()))</span>
                <span class="c1"># if (newtrack.chi2 &gt; 1e9) &amp; (len(track.satIDs) &gt;= 3):</span>
                <span class="c1">#     pdb.set_trace()</span>
                <span class="k">pass</span>
            <span class="n">newtrack2hyp</span><span class="p">[</span><span class="n">newtrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">hypaffected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">hypothesis</span> <span class="ow">in</span> <span class="n">hypaffected</span><span class="p">:</span>
                <span class="n">newhypothesis</span> <span class="o">=</span> <span class="n">Hypothesis</span><span class="o">.</span><span class="n">addto</span><span class="p">(</span><span class="n">hypothesis</span><span class="p">,</span> <span class="n">newtrack</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="n">newhypotheses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newhypothesis</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">newhypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                    <span class="n">newtrack2hyp</span><span class="p">[</span><span class="n">t0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newhypothesis</span><span class="p">)</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximate</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span>
        <span class="n">newtrack</span> <span class="o">=</span> <span class="n">Track</span><span class="p">([</span><span class="n">satid</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                         <span class="n">propagator</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">,</span>
                         <span class="n">priors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">priors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">:</span>
            <span class="n">newhypothesis</span> <span class="o">=</span> <span class="n">Hypothesis</span><span class="o">.</span><span class="n">addto</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">newtrack</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newhypothesis</span><span class="o">.</span><span class="n">ntracklet</span><span class="p">()</span> <span class="o">!=</span> <span class="n">h</span><span class="o">.</span><span class="n">ntracklet</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="n">newhypotheses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newhypothesis</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">newhypothesis</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newtrack2hyp</span><span class="p">:</span>
                    <span class="n">newtrack2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">newtrack2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newhypothesis</span><span class="p">)</span>
        <span class="c1"># if self.flag_inconsistency(newtrack2hyp, newhypotheses):</span>
        <span class="c1">#     pdb.set_trace()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span> <span class="o">=</span> <span class="n">newhypotheses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span> <span class="o">=</span> <span class="n">newtrack2hyp</span></div>

<div class="viewcode-block" id="MHT.prune_tracks"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.prune_tracks">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">prune_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satid</span><span class="p">,</span> <span class="n">nconfirm</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prune tracks that are now nearly identical from the MHT analysis.</span>

<span class="sd">        As the MHT adds observations to tracks, eventually some tracks</span>
<span class="sd">        have a number of confirming observations.  For these long tracks,</span>
<span class="sd">        we really only need to keep different Tracks and Hypotheses for cases</span>
<span class="sd">        where there are recent disagreements with how those tracks continue;</span>
<span class="sd">        if hypotheses agree that the track continues in the same way,</span>
<span class="sd">        we don&#39;t need to continue tracking the past differences.  So</span>
<span class="sd">        we prune out cases of former disagreement.</span>

<span class="sd">        This tries to identify such overlapping tracks and keep only one of</span>
<span class="sd">        them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        satid : int</span>
<span class="sd">            the satID of the most-recently added detection to the MHT</span>
<span class="sd">        nconfirm : int</span>
<span class="sd">            if two tracks are identical in their last nconfirm observations</span>
<span class="sd">            delete the tracks not in the most likely hypothesis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean array indicating hypotheses to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lnprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hyp</span><span class="o">.</span><span class="n">lnprob</span> <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">lnprob</span><span class="p">)</span>  <span class="c1"># best first</span>
        <span class="n">besthyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">lengthenedtrack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">([</span><span class="n">satid</span> <span class="ow">in</span> <span class="n">track</span><span class="o">.</span><span class="n">satIDs</span>
                                          <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">besthyp</span><span class="o">.</span><span class="n">tracks</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengthenedtrack</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="n">lengthenedtrack</span> <span class="o">=</span> <span class="n">besthyp</span><span class="o">.</span><span class="n">tracks</span><span class="p">[</span><span class="n">lengthenedtrack</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">nsatid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengthenedtrack</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span>
        <span class="n">keephyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nsatid</span> <span class="o">&lt;=</span> <span class="n">nconfirm</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># no op; no sufficiently long tracks for this to be meaningful.</span>
            <span class="k">return</span> <span class="n">keephyp</span>
        <span class="n">keeptogether</span> <span class="o">=</span> <span class="n">lengthenedtrack</span><span class="o">.</span><span class="n">satIDs</span><span class="p">[:</span><span class="n">nsatid</span><span class="o">-</span><span class="n">nconfirm</span><span class="p">]</span>
        <span class="c1"># relies on ordering of self.track2hyp being fixed...</span>
        <span class="n">deltrack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ndel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">track</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">):</span>
            <span class="n">ntogether</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">keeptogether</span><span class="p">:</span>
                <span class="n">ntogether</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sid</span> <span class="ow">in</span> <span class="n">track</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ntogether</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ntogether</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keeptogether</span><span class="p">)):</span>
                <span class="n">deltrack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">deltrack</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">]:</span>
                <span class="n">hyp</span><span class="o">.</span><span class="n">deleteme</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ndel</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">keephyp</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hyp</span><span class="p">,</span> <span class="s1">&#39;deleteme&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ndel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> hypotheses pruned with differences more than </span><span class="si">%d</span><span class="s1"> frames ago.&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">ndel</span><span class="p">,</span> <span class="n">nconfirm</span><span class="p">))</span>
            <span class="c1"># import pdb</span>
            <span class="c1"># pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">keephyp</span></div>

<div class="viewcode-block" id="MHT.prune_stale_hypotheses"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.prune_stale_hypotheses">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">prune_stale_hypotheses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newdeadtracks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prune hypotheses that are different from better hypotheses only in</span>
<span class="sd">        dead tracks.</span>

<span class="sd">        Note: implentation relies on identical tracks always having the same</span>
<span class="sd">        id.  The MHT code tries to guarantee this---otherwise it must do</span>
<span class="sd">        extra work matching identical tracks to new detections, etc.  But</span>
<span class="sd">        using id(Track) feels horrible to me.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        newdeadtracks : list of Track</span>
<span class="sd">            list of tracks that died since the last pruning.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean mask indicating hypotheses to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newdeadtracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="n">hyps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">newdeadtracks</span><span class="p">],</span> <span class="p">[])))</span>
        <span class="n">ntrack</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">tracks</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hyps</span><span class="p">]</span>
        <span class="n">maxntrack</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ntrack</span><span class="p">)</span>
        <span class="n">idarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maxntrack</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hyps</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i4&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hyps</span><span class="p">):</span>
            <span class="n">idarr</span><span class="p">[:</span><span class="n">ntrack</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">id</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hyp</span><span class="o">.</span><span class="n">tracks</span><span class="p">]</span>
        <span class="n">idarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">idarr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lnprob</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lnprob</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hyps</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">([</span><span class="n">lnprob</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">idarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idarr</span><span class="p">))])</span>
        <span class="n">todelete</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hyps</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idarr</span><span class="p">[:,</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">idarr</span><span class="p">[:,</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
                <span class="n">hyps</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">deleteme</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">todelete</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">keephyp</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hyp</span><span class="p">,</span> <span class="s1">&#39;deleteme&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">todelete</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> hypotheses pruned, differing only by dead tracks.&#39;</span> <span class="o">%</span>
                  <span class="n">todelete</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keephyp</span></div>


<div class="viewcode-block" id="MHT.prune"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.prune">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">satid</span><span class="p">,</span> <span class="n">nkeepmax</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">pkeep</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span>
              <span class="n">keeponlytrue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nconfirm</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prune unlikely hypotheses from the MHT.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        satid : int</span>
<span class="sd">            the detection ID most recently added to the MHT</span>
<span class="sd">        nkeepmax : int</span>
<span class="sd">            keep no more than nkeepmax hypotheses</span>
<span class="sd">        pkeep : float</span>
<span class="sd">            keep no hypotheses more than pkeep times less likely than the</span>
<span class="sd">            most likely hypothesis</span>
<span class="sd">        keeponlytrue : bool</span>
<span class="sd">            keep only the single hypothesis known to be true for speed</span>
<span class="sd">            comparison purposes.</span>
<span class="sd">        nconfirm : int</span>
<span class="sd">            only keep one variant of tracks that agree in the last nconfirm</span>
<span class="sd">            detections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lnprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hyp</span><span class="o">.</span><span class="n">lnprob</span> <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">lnprob</span><span class="p">)</span>  <span class="c1"># best first</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="n">bestprob</span> <span class="o">=</span> <span class="n">lnprob</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># keep ones with high enough probability relative to best</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">lnprob</span> <span class="o">&gt;</span> <span class="n">bestprob</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pkeep</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># don&#39;t keep more than nkeepmax</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">nkeepmax</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">nconfirm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_tracks</span><span class="p">(</span><span class="n">satid</span><span class="p">,</span>
                                            <span class="n">nconfirm</span><span class="o">=</span><span class="n">nconfirm</span><span class="p">)</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_stale_hypotheses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_newly_dead_tracks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;should not be possible!&#39;</span><span class="p">)</span>

        <span class="c1"># keep at least nkeepmin</span>
        <span class="c1"># keep[s[:nkeepmin]] = 1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tracksat</span> <span class="o">=</span> <span class="p">[[[</span><span class="bp">self</span><span class="o">.</span><span class="n">truth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">satIDs</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">tracks</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">]</span>
            <span class="n">nomixup</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">all</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tracksat</span><span class="p">]</span>
            <span class="n">nomixup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">all</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">nomixup</span><span class="p">])</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">h</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tracksat</span><span class="p">])</span>
            <span class="n">truthind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">~</span><span class="n">split</span> <span class="o">&amp;</span> <span class="n">nomixup</span><span class="p">)</span>
            <span class="n">truthisalive</span> <span class="o">=</span> <span class="n">nomixup</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">split</span> <span class="o">&amp;</span> <span class="n">keep</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nomixup</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">split</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;truth: dlnprob: </span><span class="si">%5.3f</span><span class="s1">, nhyp: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">bestprob</span><span class="o">-</span><span class="n">lnprob</span><span class="p">[</span><span class="n">truthind</span><span class="p">],</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lnprob</span> <span class="o">&gt;</span> <span class="n">lnprob</span><span class="p">[</span><span class="n">truthind</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">truthisalive</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning: true solution is no longer included.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keeponlytrue</span><span class="p">:</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">&amp;</span> <span class="n">nomixup</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">split</span>

        <span class="c1"># print(len(self.hypotheses), np.sum(keep))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">keep</span><span class="p">)]</span>
        <span class="n">live</span> <span class="o">=</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">hyp0</span> <span class="k">for</span> <span class="n">hyp0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">]</span>
                 <span class="k">if</span> <span class="n">live</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hyp0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">track</span><span class="p">]</span></div>
        <span class="c1"># if self.flag_inconsistency(self.track2hyp, self.hypotheses):</span>
        <span class="c1">#     pdb.set_trace()</span>

<div class="viewcode-block" id="MHT.flag_inconsistency"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.MHT.html#ssapy.correlate_tracks.MHT.flag_inconsistency">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flag_inconsistency</span><span class="p">(</span><span class="n">track2hyp</span><span class="p">,</span> <span class="n">hyp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug method checking to see if there are any inconsistencies</span>
<span class="sd">        between the tracks tracked by the MHT and the hypotheses tracked</span>
<span class="sd">        by the MHT.  Should only be needed for debugging.</span>

<span class="sd">        Every hypothesis in track2hyp[track] should include the Track track.</span>
<span class="sd">        Every hypothesis in hyp should be in the list of track2hyp[track] for</span>
<span class="sd">        each of its tracks.</span>
<span class="sd">        Every track should be in a hypothesis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        track2hyp : dict[Track -&gt; list(Hypothesis)]</span>
<span class="sd">        hyp: list(Hypothesis)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True if everything is consistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">consistent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">track2hyp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                    <span class="n">consistent</span> <span class="o">|=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">consistent</span> <span class="o">|=</span> <span class="mi">8</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hyp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">tracks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">track2hyp</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                    <span class="n">consistent</span> <span class="o">|=</span> <span class="mi">2</span>
        <span class="n">ntracklet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">tracks</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hyp</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ntracklet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ntracklet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ntracklet</span><span class="p">):</span>
            <span class="n">consistent</span> <span class="o">|=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">consistent</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">consistent</span></div></div>


<div class="viewcode-block" id="summarize_tracklets"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.summarize_tracklets.html#ssapy.correlate_tracks.summarize_tracklets">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">summarize_tracklets</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">posuncfloor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pmuncfloor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add fields to default data set to accommodate MHT fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array_like</span>
<span class="sd">        data to add fields to</span>
<span class="sd">    posuncfloor : float or None</span>
<span class="sd">        add a positional uncertainty floor to the ra/dec uncertainties (deg)</span>
<span class="sd">    pmuncfloor : float or None</span>
<span class="sd">        add a proper motion uncertainty floor to the ra/dec proper motion</span>
<span class="sd">        uncertainties (deg/s)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array parallel to data with additional fields dra, ddec,</span>
<span class="sd">    pmra, pmdec, dpmra, dpmdec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datao</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">]])</span>
    <span class="n">usat</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">],</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">first</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]])</span>
    <span class="n">newfields</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;dra&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;ddec&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;pmra&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;pmdec&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;dpmra&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;t_baseline&#39;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">newfields</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f8&#39;</span> <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;object&#39;</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">*</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">*</span><span class="n">unit</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="n">meanpos</span><span class="p">,</span> <span class="n">dmeanpos</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span> <span class="n">dpm</span> <span class="o">=</span> <span class="n">summarize_tracklet</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]])</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dr0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
        <span class="n">dt0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr0</span> <span class="o">/</span> <span class="n">dt0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]])):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v0</span>
            <span class="c1"># this isn&#39;t quite the same as taking the mean velocity over</span>
            <span class="c1"># the observations.  But on Aero-B it makes a maximum difference</span>
            <span class="c1"># of less than one part in a million, which seems negligible</span>
            <span class="c1"># for _velocity_ measurements.  Note that for _positions_ this</span>
            <span class="c1"># would be significant!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vStation_GCRF&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span><span class="o">.</span><span class="n">gps</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">meanpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">meanpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dmeanpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dmeanpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pmra&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pmdec&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dpm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dpm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;t_baseline&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="n">f</span><span class="p">:]]</span><span class="o">=</span> <span class="n">dt0</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">posuncfloor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">posuncfloor</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dra&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">posuncfloor</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ddec&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pmuncfloor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pmuncfloor</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmra&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pmuncfloor</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dpmdec&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">first</span><span class="p">]]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span></div>


<div class="viewcode-block" id="summarize_tracklet"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.summarize_tracklet.html#ssapy.correlate_tracks.summarize_tracklet">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">summarize_tracklet</span><span class="p">(</span><span class="n">arc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute mean ra/dec, uncertainty in mean, proper motion, uncertainty</span>
<span class="sd">    for a short arc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arc : the short arc of detections</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [(ra, dec), (dra, ddec), (pmra, pmdec), (dpmra, dpmdec)]</span>
<span class="sd">    ra, dec: the mean position in right ascension and declination</span>
<span class="sd">    dra, ddec: the uncertainty in the mean RA and declination</span>
<span class="sd">    pmra, pmdec: the proper motion in right ascension and declination</span>
<span class="sd">    dpmra, dpmdec: the uncertainty in the proper motion in RA and declination</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">lb_to_unit</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">meanunit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># defines tangent plane</span>
    <span class="n">pole</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">raunit</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pole</span><span class="p">,</span> <span class="n">meanunit</span><span class="p">))</span>
    <span class="n">decunit</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">meanunit</span><span class="p">,</span> <span class="n">raunit</span><span class="p">))</span>
    <span class="n">ratp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">raunit</span><span class="p">)</span>
    <span class="n">dectp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">decunit</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="n">meantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gps</span><span class="o">-</span><span class="n">meantime</span>
    <span class="n">dpos</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rap</span><span class="p">,</span> <span class="n">racovar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">ratp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">dpos</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="s1">&#39;unscaled&#39;</span><span class="p">)</span>
    <span class="n">rasig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">racovar</span><span class="p">))</span>
    <span class="n">decp</span><span class="p">,</span> <span class="n">deccovar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">dectp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">dpos</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="s1">&#39;unscaled&#39;</span><span class="p">)</span>
    <span class="n">decsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">deccovar</span><span class="p">))</span>
    <span class="n">meanra</span><span class="p">,</span> <span class="n">meandec</span> <span class="o">=</span> <span class="n">ssapy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unit_to_lb</span><span class="p">(</span><span class="n">meanunit</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">rap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">meanra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">decp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">meandec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[(</span><span class="n">rap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">decp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span>
           <span class="p">(</span><span class="n">rasig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">decsig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">),</span>
           <span class="p">(</span><span class="n">rap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">decp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>
           <span class="p">(</span><span class="n">rasig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">decsig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># need to write code that ~iterates MHT to try to bring in detections that weren&#39;t</span>
<span class="c1"># matched.</span>

<div class="viewcode-block" id="iterate_mht"><a class="viewcode-back" href="../../api/ssapy.correlate_tracks.iterate_mht.html#ssapy.correlate_tracks.iterate_mht">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">iterate_mht</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">oldmht</span><span class="p">,</span> <span class="n">nminlength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">trimends</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterates and refines the Multiple Hypothesis Tracking (MHT) process by updating tracks and generating new hypotheses.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    data : dict</span>
<span class="sd">        A dictionary containing satellite data. Must include a key `&#39;satID&#39;` with satellite IDs.</span>
<span class="sd">    oldmht : MHT</span>
<span class="sd">        The previous MHT object containing hypotheses and tracking information.</span>
<span class="sd">    nminlength : int, optional</span>
<span class="sd">        Minimum length of satellite tracks to be included in the new hypotheses. Tracks shorter than this length are excluded. Default is 20.</span>
<span class="sd">    trimends : int, optional</span>
<span class="sd">        Number of observations to trim from both ends of each track. This helps refine the tracks by removing edge data. Default is 2.</span>
<span class="sd">    **kw : dict</span>
<span class="sd">        Additional keyword arguments passed to the `MHT.run()` method.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    newmht : MHT</span>
<span class="sd">        A new MHT object with updated hypotheses and refined tracks.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - The function identifies the best hypothesis from the `oldmht` object based on the highest log probability (`lnprob`).</span>
<span class="sd">    - Tracks are filtered based on their length (`nminlength`) and whether they are marked as &quot;dead.&quot;</span>
<span class="sd">    - If `trimends` is greater than 0, the ends of each track are trimmed, and new track objects are created.</span>
<span class="sd">    - The function creates an initial hypothesis using the refined tracks and generates a new MHT object.</span>
<span class="sd">    - Satellite IDs used in the updated tracks are excluded from the fitting process for the new MHT object.</span>
<span class="sd">    - The `newmht.run()` method is executed with the provided keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bestind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">lnprob</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">oldmht</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">])</span>
    <span class="n">besthyp</span> <span class="o">=</span> <span class="n">oldmht</span><span class="o">.</span><span class="n">hypotheses</span><span class="p">[</span><span class="n">bestind</span><span class="p">]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">besthyp</span><span class="o">.</span><span class="n">tracks</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">satIDs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nminlength</span><span class="p">)]</span>
    <span class="c1"># want to cut off the ends of the tracks</span>
    <span class="k">if</span> <span class="n">trimends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">newtracks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tracks</span><span class="p">):</span>
            <span class="n">newt</span> <span class="o">=</span> <span class="n">Track</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">satIDs</span><span class="p">[</span><span class="n">trimends</span><span class="p">:</span><span class="o">-</span><span class="n">trimends</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">guess</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                         <span class="n">propagator</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span> <span class="n">orbitattr</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">),</span> <span class="n">newt</span><span class="o">.</span><span class="n">chi2</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">newt</span><span class="o">.</span><span class="n">satIDs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">oldmht</span><span class="o">.</span><span class="n">approximate</span><span class="p">:</span>
                <span class="n">newt</span> <span class="o">=</span> <span class="n">newt</span><span class="o">.</span><span class="n">gaussian_approximation</span><span class="p">()</span>
            <span class="n">newtracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newt</span><span class="p">)</span>
        <span class="n">tracks</span> <span class="o">=</span> <span class="n">newtracks</span>
    <span class="n">initialhyp</span> <span class="o">=</span> <span class="n">Hypothesis</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">nsat</span><span class="o">=</span><span class="n">besthyp</span><span class="o">.</span><span class="n">nsat</span><span class="p">)</span>
    <span class="n">usedsatid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">satIDs</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">],</span> <span class="p">[]))</span>
    <span class="n">keepdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usedsatid</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;satID&#39;</span><span class="p">]])</span>
    <span class="n">newmht</span> <span class="o">=</span> <span class="n">MHT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hypotheses</span><span class="o">=</span><span class="p">[</span><span class="n">initialhyp</span><span class="p">],</span> <span class="n">nsat</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">nsat</span><span class="p">,</span>
                 <span class="n">propagator</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">propagator</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                 <span class="n">fitonly</span><span class="o">=</span><span class="n">keepdata</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">approximate</span><span class="p">,</span>
                 <span class="n">priors</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">truth</span><span class="p">,</span>
                 <span class="n">orbitattr</span><span class="o">=</span><span class="n">oldmht</span><span class="o">.</span><span class="n">orbitattr</span><span class="p">)</span>
    <span class="n">newmht</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newmht</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Lawrence Livermore National Security, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>