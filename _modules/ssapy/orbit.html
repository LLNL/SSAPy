

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ssapy.orbit &mdash; SSAPy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
    <link rel="shortcut icon" href="../../_static/ssapy_logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/ssapy_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">SSAPy by Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks.html">SSAPy Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">SSAPy Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API DOCS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SSAPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ssapy.orbit</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ssapy.orbit</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to handle Earth satellite state vector manipulation and propagation.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">Although much of the Orbit class here is agnostic with respect to the</span>
<span class="sd">coordinate reference frame, we strongly recommend that positions and</span>
<span class="sd">velocities be specified in the GCRF frame.  Some classes in this module *do*</span>
<span class="sd">insist on this frame, (e.g., EarthObserver).  We will try to indicate where</span>
<span class="sd">the GCRF frame is required, but make no guarantees that we don&#39;t miss any</span>
<span class="sd">such instances.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">normSq</span><span class="p">,</span> <span class="n">normed</span><span class="p">,</span> <span class="n">lazy_property</span> <span class="k">as</span> <span class="n">_lazy_property</span><span class="p">,</span> <span class="n">unitAngle3</span><span class="p">,</span> <span class="n">sunPos</span><span class="p">,</span>
    <span class="n">_gpsToTT</span><span class="p">,</span> <span class="n">_wrapToPi</span><span class="p">,</span> <span class="n">teme_to_gcrf</span><span class="p">,</span> <span class="n">gcrf_to_teme</span><span class="p">,</span> <span class="n">iers_interp</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EARTH_MU</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.propagator</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeplerianPropagator</span> <span class="k">as</span> <span class="n">_KeplerianPropagator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">erfa</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Let this raise</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">astropy._erfa</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">erfa</span>


<span class="c1"># Conversion routines for anomalies</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalEccentricToTrueAnomaly</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute true anomaly from eccentric anomaly for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    E : array_like</span>
<span class="sd">        Eccentric anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        True anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">E</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eccentric anomaly from true anomaly for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : array_like</span>
<span class="sd">        True anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Eccentric anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalTrueToEccentricAnomalyMany</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">beta</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicEccentricToTrueAnomaly</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic true anomaly from hyperbolic eccentric anomaly for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    H : array_like</span>
<span class="sd">        Hyperbolic eccentric anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic true anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">H</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicEccentricToTrueAnomalyMany</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">H</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic eccentric anomaly from hyperbolic true anomaly for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : array_like</span>
<span class="sd">        Hyperbolic true anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic eccentric anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicTrueToEccentricAnomalyMany</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalEccentricToMeanAnomaly</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute mean anomaly from eccentric anomaly for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        E : array_like</span>
<span class="sd">            Eccentric anomaly in radians.</span>
<span class="sd">        e : float</span>
<span class="sd">            Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Mean anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">E</span> <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>


<span class="nd">@np</span><span class="o">.</span><span class="n">vectorize</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalMeanToEccentricAnomaly</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eccentric anomaly from mean anomaly for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : array_like</span>
<span class="sd">        Mean anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Eccentric anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">k3</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">/</span> <span class="n">k1</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">k3</span> <span class="o">*</span> <span class="n">k3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">k1</span><span class="p">)</span>

    <span class="n">MM</span> <span class="o">=</span> <span class="n">_wrapToPi</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>  <span class="c1"># map to [-Pi, Pi]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">MM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">MM</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">MM</span><span class="p">)</span> <span class="o">-</span> <span class="n">MM</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">MM</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">MM</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">MM</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">MM</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">MM</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">MM</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">MM</span><span class="p">)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">e</span>
    <span class="n">noCancellationRisk</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span> <span class="o">+</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.1</span>
    <span class="c1"># three iterations.  each with one Halley and one Newton-Raphson step</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">fdd</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="n">fddd</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noCancellationRisk</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span> <span class="o">-</span> <span class="n">fdd</span><span class="p">)</span> <span class="o">-</span> <span class="n">MM</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fddd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">_eMeSinE</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">MM</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span>
        <span class="n">dee</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">fd</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="n">fdd</span> <span class="o">-</span> <span class="n">fd</span> <span class="o">*</span> <span class="n">fd</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dee</span> <span class="o">*</span> <span class="p">(</span><span class="n">fdd</span> <span class="o">+</span> <span class="n">dee</span> <span class="o">*</span> <span class="n">fddd</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fd</span> <span class="o">+=</span> <span class="n">dee</span> <span class="o">*</span> <span class="p">(</span><span class="n">fdd</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dee</span> <span class="o">*</span> <span class="n">fddd</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">-=</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">dee</span> <span class="o">*</span> <span class="p">(</span><span class="n">fd</span> <span class="o">-</span> <span class="n">w</span><span class="p">))</span> <span class="o">/</span> <span class="n">fd</span>
    <span class="n">E</span> <span class="o">+=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">MM</span>
    <span class="k">return</span> <span class="n">E</span>


<span class="nd">@np</span><span class="o">.</span><span class="n">vectorize</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_eMeSinE</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Accurate computation of E - e sin(E).</span>
<span class="sd">    Use when E is close to 0 and e close to 1,</span>
<span class="sd">    i.e., near periapsis of almost parabolic orbits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    E : array_like</span>
<span class="sd">        Eccentric anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        E - e sin(E)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="n">mE2</span> <span class="o">=</span> <span class="o">-</span><span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">E</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">x0</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="n">term</span> <span class="o">*=</span> <span class="n">mE2</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">term</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicEccentricToMeanAnomaly</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic mean anomaly from hyperbolic eccentric anomaly for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    H : array_like</span>
<span class="sd">        Hyperbolic eccentric anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic mean anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">-</span> <span class="n">H</span>


<span class="nd">@np</span><span class="o">.</span><span class="n">vectorize</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicMeanToEccentricAnomaly</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic eccentric anomaly from hyperbolic mean anomaly for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : array_like</span>
<span class="sd">        Hyperbolic mean anomaly in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Eccentricity</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic eccentric anomaly in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mf">1.6</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">&lt;</span> <span class="n">M</span> <span class="ow">and</span> <span class="n">M</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mf">3.6</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">f3</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">f2</span> <span class="o">-</span> <span class="n">H</span> <span class="o">-</span> <span class="n">M</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">/</span> <span class="n">f12</span>
        <span class="n">fdf</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">f2</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">/</span> <span class="n">fdf</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">/</span> <span class="p">(</span><span class="n">fdf</span> <span class="o">+</span> <span class="n">ds</span> <span class="o">*</span> <span class="n">ds</span> <span class="o">*</span> <span class="n">f3</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">-=</span> <span class="n">shift</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">H</span>
        <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">&quot;Unable to compute hyperbolic eccentric anomaly for M=</span><span class="si">{}</span><span class="s2">, e=</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">)</span>


<span class="c1"># Conversion routines for longitudes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalEccentricToTrueLongitude</span><span class="p">(</span><span class="n">lE</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute true longitude from eccentric longitude for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lE : array_like</span>
<span class="sd">        Eccentric longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        True longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">cosLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="n">sinLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">sinLE</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">cosLE</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">cosLE</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">sinLE</span>
    <span class="k">return</span> <span class="n">lE</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalTrueToEccentricLongitude</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eccentric longitude from true longitude for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lv : array_like</span>
<span class="sd">        True longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Eccentric longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">cosLv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>
    <span class="n">sinLv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">cosLv</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">sinLv</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">cosLv</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">sinLv</span>
    <span class="k">return</span> <span class="n">lv</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalTrueToEccentricLongitudeMany</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
    <span class="c1"># lv (n, m)</span>
    <span class="c1"># ex, ey (n,)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">cosLv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>
    <span class="n">sinLv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cosLv</span> <span class="o">-</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sinLv</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">epsilon</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cosLv</span> <span class="o">+</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sinLv</span>
    <span class="k">return</span> <span class="n">lv</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicEccentricToTrueLongitude</span><span class="p">(</span><span class="n">lH</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic true longitude from hyperbolic eccentric longitude for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lH : array_like</span>
<span class="sd">        Hyperbolic eccentric longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic true longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># is there a way to do this directly w/o computing e, w?</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">lH</span> <span class="o">-</span> <span class="n">w</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">_hyperbolicEccentricToTrueAnomaly</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">+</span> <span class="n">w</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicTrueToEccentricLongitude</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic eccentric longitude from hyperbolic true longitude for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lv : array_like</span>
<span class="sd">        Hyperbolic true longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic eccentric longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">lv</span> <span class="o">-</span> <span class="n">w</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span> <span class="o">+</span> <span class="n">w</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicTrueToEccentricLongitudeMany</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">lv</span> <span class="o">-</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">H</span> <span class="o">+</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalEccentricToMeanLongitude</span><span class="p">(</span><span class="n">lE</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute mean longitude from eccentric longitude for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lE : array_like</span>
<span class="sd">        Eccentric longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Mean longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lE</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalMeanToEccentricLongitude</span><span class="p">(</span><span class="n">lM</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eccentric longitude from mean longitude for elliptical orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lM : array_like</span>
<span class="sd">        Mean longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Eccentric longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lEmlM</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">lE</span> <span class="o">=</span> <span class="n">lM</span>
    <span class="n">cosLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="n">sinLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="c1"># previous version iterated until a given convergence criterion was met.</span>
    <span class="c1"># This version always iterates exactly 6 times.  I found this is ~50% faster</span>
    <span class="c1"># in typical use (as part of RVSampler) since the operations are all</span>
    <span class="c1"># vectorized.</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">sinLE</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">cosLE</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">cosLE</span> <span class="o">-</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">sinLE</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">lEmlM</span> <span class="o">-</span> <span class="n">f2</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f1</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">f12</span> <span class="o">/</span> <span class="p">(</span><span class="n">f1</span> <span class="o">*</span> <span class="n">f12</span> <span class="o">-</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">f2</span><span class="p">)</span>
        <span class="n">lEmlM</span> <span class="o">-=</span> <span class="n">shift</span>
        <span class="n">lE</span> <span class="o">=</span> <span class="n">lM</span> <span class="o">+</span> <span class="n">lEmlM</span>
        <span class="n">cosLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
        <span class="n">sinLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lE</span>


<span class="c1"># Specialization for parallelizing over orbits and times simultaneously</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_ellipticalMeanToEccentricLongitudeMany</span><span class="p">(</span><span class="n">lM</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lEmlM</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">lE</span> <span class="o">=</span> <span class="n">lM</span>
    <span class="n">cosLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="n">sinLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="c1"># Always iterate exactly 6 times.  See above.</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sinLE</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cosLE</span><span class="p">)</span>

        <span class="n">f2</span> <span class="o">*=</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">cosLE</span> <span class="o">*=</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">f2</span> <span class="o">-=</span> <span class="n">cosLE</span>

        <span class="n">f1</span> <span class="o">*=</span> <span class="o">-</span><span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">sinLE</span> <span class="o">*=</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">f1</span> <span class="o">-=</span> <span class="n">sinLE</span>
        <span class="n">f1</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># above is equivalent to commented lines below, but rewritten to avoid</span>
        <span class="c1"># temporary array allocation as much as reasonable:</span>
        <span class="c1"># f2 = ex[:,None]*sinLE - ey[:,None]*cosLE</span>
        <span class="c1"># f1 = 1 - ex[:,None]*cosLE - ey[:,None]*sinLE</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">lEmlM</span> <span class="o">-</span> <span class="n">f2</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">*=</span> <span class="n">f1</span>
        <span class="n">shift</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">f1</span> <span class="o">*=</span> <span class="n">f1</span>
        <span class="n">f1</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">f0</span> <span class="o">*=</span> <span class="n">f2</span>
        <span class="n">f1</span> <span class="o">-=</span> <span class="n">f0</span>
        <span class="n">shift</span> <span class="o">/=</span> <span class="n">f1</span>
        <span class="c1"># above block is equivalent to below</span>
        <span class="c1"># shift = f0*f12/(f1*f12 - f0*f2)</span>

        <span class="n">lEmlM</span> <span class="o">-=</span> <span class="n">shift</span>
        <span class="n">lE</span> <span class="o">=</span> <span class="n">lM</span> <span class="o">+</span> <span class="n">lEmlM</span>
        <span class="n">cosLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
        <span class="n">sinLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lE</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicEccentricToMeanLongitude</span><span class="p">(</span><span class="n">lH</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic mean longitude from hyperbolic eccentric longitude for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lH : array_like</span>
<span class="sd">        Hyperbolic eccentric longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic mean longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">lH</span> <span class="o">-</span> <span class="n">w</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">_hyperbolicEccentricToMeanAnomaly</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span> <span class="o">+</span> <span class="n">w</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicMeanToEccentricLongitude</span><span class="p">(</span><span class="n">lM</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hyperbolic eccentric longitude from hyperbolic mean longitude for</span>
<span class="sd">    hyperbolic orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lM : array_like</span>
<span class="sd">        Hyperbolic mean longitude in radians.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Eccentricity vector components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Hyperbolic eccentric longitude in radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">lM</span> <span class="o">-</span> <span class="n">w</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">_hyperbolicMeanToEccentricAnomaly</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span> <span class="o">+</span> <span class="n">w</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_hyperbolicMeanToEccentricLongitudeMany</span><span class="p">(</span><span class="n">lM</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">lM</span> <span class="o">-</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">_hyperbolicMeanToEccentricAnomaly</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">H</span> <span class="o">+</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>


<div class="viewcode-block" id="Orbit"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Orbit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orbital state of one or more objects.</span>

<span class="sd">    This class represents one or more instantaneous (osculating) states of</span>
<span class="sd">    orbiting bodies.  Representations in Cartesian, Keplerian, and equinoctial</span>
<span class="sd">    elements are available.  The default initializer requires Cartesian</span>
<span class="sd">    elements, though class methods are also available to initialize with</span>
<span class="sd">    Keplerian or equinoctial elements.</span>

<span class="sd">    Note that generally this class can represent either a single scalar orbit,</span>
<span class="sd">    in which case attributes will generally be scalar floats, or a vector of</span>
<span class="sd">    orbits, in which case attributes will be ndarrays of floats.  For attributes</span>
<span class="sd">    that are intrinsically vectors even for a single orbit (position, velocity,</span>
<span class="sd">    ...), a 2d array will be used for a &quot;vector of orbits&quot;, with the first</span>
<span class="sd">    dimension representing the different orbits.</span>

<span class="sd">    For simplicity, we will only indicate the &quot;single scalar Orbit&quot; dimensions</span>
<span class="sd">    in docstrings.  For a vector-Orbit, most scalar input arguments can be</span>
<span class="sd">    supplied as broadcastable arrays, and scalar attributes become array</span>
<span class="sd">    attributes.  When a multi-dimensional array is required, the first dimension</span>
<span class="sd">    is the one over different orbits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r : (3,) array_like</span>
<span class="sd">        Position of orbiting object in meters.</span>
<span class="sd">    v : (3,) array_like</span>
<span class="sd">        Velocity of orbiting objects in meters per second.</span>
<span class="sd">    t : float or astropy.time.Time</span>
<span class="sd">        If float or array of float, then should correspond to GPS seconds; i.e.,</span>
<span class="sd">        seconds since 1980-01-06 00:00:00 UTC</span>
<span class="sd">    mu : float, optional</span>
<span class="sd">        Gravitational constant of central body in m^3/s^2.  (Default: Earth&#39;s</span>
<span class="sd">        gravitational constant in WGS84).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    r : (3,) array_like</span>
<span class="sd">        Position of orbiting object in meters.</span>
<span class="sd">    v : (3,) array_like</span>
<span class="sd">        Velocity of orbiting object in meters per second.</span>
<span class="sd">    t : float</span>
<span class="sd">        GPS seconds; i.e., seconds since 1980-01-06 00:00:00 UTC</span>
<span class="sd">    mu : float</span>
<span class="sd">        Gravitational constant of central body in m^3/s^2</span>
<span class="sd">    a : float</span>
<span class="sd">        Semimajor axis in meters.</span>
<span class="sd">    hx, hy : float</span>
<span class="sd">        Components of the equinoctial inclination vector.</span>
<span class="sd">    ex, ey : float</span>
<span class="sd">        Components of the equinoctial eccentricity vector.</span>
<span class="sd">    lv : float</span>
<span class="sd">        True longitude in radians.</span>
<span class="sd">    lE : float</span>
<span class="sd">        Eccentric longitude in radians.</span>
<span class="sd">    lM : float</span>
<span class="sd">        Mean longitude in radians.</span>
<span class="sd">    e : float</span>
<span class="sd">        Keplerian eccentricity.</span>
<span class="sd">    i : float</span>
<span class="sd">        Keplerian inclination in radians.</span>
<span class="sd">    pa : float</span>
<span class="sd">        Keplerian periapsis argument in radians.</span>
<span class="sd">    raan : float</span>
<span class="sd">        Keplerian right ascension of the ascending node in radians.</span>
<span class="sd">    trueAnomaly : float</span>
<span class="sd">        Keplerian true anomaly in radians.</span>
<span class="sd">    eccentricAnomaly : float</span>
<span class="sd">        Keplerian eccentric anomaly in radians.</span>
<span class="sd">    meanAnomaly : float</span>
<span class="sd">        Keplerian mean anomaly in radians.</span>
<span class="sd">    period : float</span>
<span class="sd">        Orbital period in seconds.</span>
<span class="sd">    meanMotion : float</span>
<span class="sd">        Keplerian mean motion in radians per second.</span>
<span class="sd">    p : float</span>
<span class="sd">        Semi-latus rectum in meters.</span>
<span class="sd">    angularMomentum : (3,) array_like</span>
<span class="sd">        (Specific) angular momentum in m^2/s.</span>
<span class="sd">    energy: float</span>
<span class="sd">        (Specific) orbital energy in m^2/s^2.</span>
<span class="sd">    LRL : (3,) array_like</span>
<span class="sd">        Laplace-Runge-Lenz vector in m^3/s^2.</span>
<span class="sd">    periapsis : (3,) array_like</span>
<span class="sd">        Periapsis coordinate of orbit in meters.</span>
<span class="sd">    apoapsis : (3,) array_like</span>
<span class="sd">        Apoapsis coordinate of orbit in meters.</span>
<span class="sd">    equinoctialElements</span>
<span class="sd">    keplerianElements</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    fromKeplerianElements(a, e, i, pa, raan, trueAnomaly, t, mu)</span>
<span class="sd">        Construct an `Orbit` from Keplerian elements.</span>
<span class="sd">    fromEquinoctialElements(a, hx, hy, ex, ey, lv, t, mu)</span>
<span class="sd">        Construct an `Orbit` from Equinoctial elements.</span>
<span class="sd">    at(t, propagator)</span>
<span class="sd">        Propagate orbit to time t and return new Orbit.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Although much of the Orbit class here is agnostic with respect to the</span>
<span class="sd">    coordinate reference frame, we strongly recommend that positions and</span>
<span class="sd">    velocities be specified in the GCRF frame.  Some other classes in this</span>
<span class="sd">    module *do* insist on this frame, (e.g., EarthObserver).  We will try to</span>
<span class="sd">    indicate where the GCRF frame is required, but make no guarantees that we</span>
<span class="sd">    don&#39;t miss any such instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Internally use equinoctial elements, calculating cartesian and keplerian</span>
    <span class="c1"># on demand.  Main ctor uses cartesian though</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">EARTH_MU</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">gps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">propkw</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># propagate kozai directly if possible</span>
            <span class="k">if</span> <span class="s1">&#39;kozaiMeanKeplerianElements&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">kMKE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;kozaiMeanKeplerianElements&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kMKE</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">],</span>
                <span class="n">propkw</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">kMKE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">kozaiMeanKeplerianElements</span> <span class="o">=</span> <span class="n">kMKE</span>
            <span class="c1"># TODO: iterate through already-instantiated lazy_properties and</span>
            <span class="c1"># copy them over too.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;kozaiMeanKeplerianElements&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">kMKE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;kozaiMeanKeplerianElements&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kMKE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="n">propkw</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">if</span> <span class="n">kMKE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">kozaiMeanKeplerianElements</span> <span class="o">=</span> <span class="n">kMKE</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_hash&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="p">]))</span>

<div class="viewcode-block" id="Orbit.fromEquinoctialElements"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.fromEquinoctialElements">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromEquinoctialElements</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">EARTH_MU</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an Orbit from equinoctial elements.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : float</span>
<span class="sd">            Semimajor axis in meters.</span>
<span class="sd">        hx, hy : float</span>
<span class="sd">            Components of the equinoctial inclination vector.</span>
<span class="sd">        ex, ey : float</span>
<span class="sd">            Components of the equinoctial eccentricity vector.</span>
<span class="sd">        lv : float</span>
<span class="sd">            True longitude in radians.</span>
<span class="sd">        t : float or astropy.time.Time</span>
<span class="sd">            If float, then should correspond to GPS seconds; i.e., seconds since</span>
<span class="sd">            1980-01-06 00:00:00 UTC</span>
<span class="sd">        mu : float, optional</span>
<span class="sd">            Gravitational constant of central body in m^3/s^2.  (Default:</span>
<span class="sd">            Earth&#39;s gravitational constant in WGS84).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">            The Orbit with given parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">gps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">t</span>
            <span class="p">)</span>
            <span class="n">scalar</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scalar</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">hx</span> <span class="o">=</span> <span class="n">hx</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">hy</span> <span class="o">=</span> <span class="n">hy</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">ey</span> <span class="o">=</span> <span class="n">ey</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">lv</span> <span class="o">=</span> <span class="n">lv</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>

        <span class="c1"># set reference axes of orbital plane</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_setPQEquinoctial</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># set position and velocity</span>
        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rvFromEquinoctial</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">lv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">lv</span><span class="p">))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="n">propkw</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rvFromEquinoctial</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">lv</span><span class="o">=</span><span class="n">lv</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="n">propkw</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Orbit.fromKeplerianElements"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.fromKeplerianElements">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromKeplerianElements</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">EARTH_MU</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an Orbit from Keplerian elements.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : float</span>
<span class="sd">            Semimajor axis in meters.</span>
<span class="sd">        e : float</span>
<span class="sd">            Keplerian eccentricity.</span>
<span class="sd">        i : float</span>
<span class="sd">            Keplerian inclination in radians.</span>
<span class="sd">        pa : float</span>
<span class="sd">            Keplerian periapsis argument in radians.</span>
<span class="sd">        raan : float</span>
<span class="sd">            Keplerian right ascension of the ascending node in radians.</span>
<span class="sd">        trueAnomaly : float</span>
<span class="sd">            Keplerian true anomaly in radians.</span>
<span class="sd">        t : float or astropy.time.Time</span>
<span class="sd">            If float, then should correspond to GPS seconds; i.e., seconds since</span>
<span class="sd">            1980-01-06 00:00:00 UTC</span>
<span class="sd">        mu : float, optional</span>
<span class="sd">            Gravitational constant of central body in m^3/s^2.  (Default:</span>
<span class="sd">            Earth&#39;s gravitational constant in WGS84).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">            The Orbit with given parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">gps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span>
            <span class="p">)</span>
            <span class="n">scalar</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scalar</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">raan</span> <span class="o">=</span> <span class="n">raan</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">trueAnomaly</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>

        <span class="c1"># set reference axes of orbital plane</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_setPQKeplerian</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># set position and velocity</span>
        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rvFromKeplerian</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">trueAnomaly</span><span class="p">))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="n">propkw</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rvFromKeplerian</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="n">propkw</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Orbit.fromKozaiMeanKeplerianElements"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.fromKozaiMeanKeplerianElements">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromKozaiMeanKeplerianElements</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">EARTH_MU</span><span class="p">,</span>
        <span class="n">_useTEME</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an Orbit from Kozai mean Keplerian elements.  By default,</span>
<span class="sd">        this method also converts from the TEME reference frame to the GCRF</span>
<span class="sd">        frame.  This is mainly to support TLEs and SGP4, so the default</span>
<span class="sd">        gravitational parameter is WGS84.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : float</span>
<span class="sd">            Semimajor axis in meters.</span>
<span class="sd">        e : float</span>
<span class="sd">            Keplerian eccentricity.</span>
<span class="sd">        i : float</span>
<span class="sd">            Keplerian inclination in radians.</span>
<span class="sd">        pa : float</span>
<span class="sd">            Keplerian periapsis argument in radians.</span>
<span class="sd">        raan : float</span>
<span class="sd">            Keplerian right ascension of the ascending node in radians.</span>
<span class="sd">        trueAnomaly : float</span>
<span class="sd">            Keplerian true anomaly in radians.</span>
<span class="sd">        t : float or astropy.time.Time</span>
<span class="sd">            If float, then should correspond to GPS seconds; i.e., seconds since</span>
<span class="sd">            1980-01-06 00:00:00 UTC</span>
<span class="sd">        mu : float, optional</span>
<span class="sd">            Gravitational constant of central body in m^3/s^2.  (Default:</span>
<span class="sd">            Earth&#39;s gravitational constant in WGS84).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">            The Orbit with given parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># _useTEME hidden bool kwarg indicates to keep SGP4 result in TEME</span>
        <span class="c1"># frame, instead of transforming to GCRF.  The default of False is</span>
        <span class="c1"># almost always appropriate.  The exception is when fitting for kozai</span>
        <span class="c1"># elements where it&#39;s faster to just work in the TEME frame.</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sgp4.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">Satrec</span><span class="p">,</span> <span class="n">WGS84</span>

        <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">meanAnomaly</span> <span class="o">=</span> <span class="n">_ellipticalEccentricToMeanAnomaly</span><span class="p">(</span>
                <span class="n">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="n">trueAnomaly</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">e</span>
                <span class="p">),</span>
                <span class="n">e</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meanAnomaly</span> <span class="o">=</span> <span class="n">_hyperbolicEccentricToMeanAnomaly</span><span class="p">(</span>
                <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="n">trueAnomaly</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">e</span>
                <span class="p">),</span>
                <span class="n">e</span>
            <span class="p">)</span>
        <span class="n">meanMotion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">60.0</span>  <span class="c1"># rad/min</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
        <span class="n">mjd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mjd</span>
        <span class="c1"># epoch = mjd - astropy.time.Time(&quot;1949-12-31T00:00:00&quot;).mjd</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">mjd</span> <span class="o">-</span> <span class="mf">33281.0</span>

        <span class="n">sat</span> <span class="o">=</span> <span class="n">Satrec</span><span class="p">()</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">sgp4init</span><span class="p">(</span>
            <span class="n">WGS84</span><span class="p">,</span>           <span class="c1"># gravity model</span>
            <span class="s1">&#39;i&#39;</span><span class="p">,</span>             <span class="c1"># &#39;a&#39; = old AFSPC mode, &#39;i&#39; = improved mode</span>
            <span class="mi">0</span><span class="p">,</span>               <span class="c1"># satnum: Satellite number</span>
            <span class="n">epoch</span><span class="p">,</span>           <span class="c1"># epoch: days since 1949 December 31 00:00 UT</span>
            <span class="mf">0.0</span><span class="p">,</span>             <span class="c1"># bstar: drag coefficient (kg/m2er)</span>
            <span class="mf">0.0</span><span class="p">,</span>             <span class="c1"># ndot: ballistic coefficient (revs/day)</span>
            <span class="mf">0.0</span><span class="p">,</span>             <span class="c1"># nddot: second derivative of mean motion (revs/day^3)</span>
            <span class="n">e</span><span class="p">,</span>               <span class="c1"># ecco: eccentricity</span>
            <span class="n">pa</span><span class="p">,</span>              <span class="c1"># argpo: argument of perigee (radians)</span>
            <span class="n">i</span><span class="p">,</span>               <span class="c1"># inclo: inclination (radians)</span>
            <span class="n">meanAnomaly</span><span class="p">,</span>     <span class="c1"># mo: mean anomaly (radians)</span>
            <span class="n">meanMotion</span><span class="p">,</span>      <span class="c1"># no_kozai: mean motion (radians/minute)</span>
            <span class="n">raan</span><span class="p">,</span>            <span class="c1"># nodeo: right ascension of ascending node (radians)</span>
        <span class="p">)</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">sat</span><span class="o">.</span><span class="n">sgp4_tsince</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_useTEME</span><span class="p">:</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">teme_to_gcrf</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">r</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">v</span>
        <span class="n">r</span> <span class="o">*=</span> <span class="mf">1e3</span>  <span class="c1"># km -&gt; m</span>
        <span class="n">v</span> <span class="o">*=</span> <span class="mf">1e3</span>  <span class="c1"># km/s -&gt; m/s</span>
        <span class="k">return</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span></div>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kozaiMeanKeplerianElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kozai mean Keplerian elements in TEME frame</span>
<span class="sd">        (a, e, i, pa, raan, trueAnomaly)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">least_squares</span>
        <span class="c1"># I don&#39;t know of a good closed form expression for Kozai elements, so</span>
        <span class="c1"># instead, just solve for them using SGP4 and a desired output state</span>
        <span class="c1"># vector.  The osculating elements are a good initial guess.</span>

        <span class="n">rot</span> <span class="o">=</span> <span class="n">gcrf_to_teme</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">rTEME</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
        <span class="n">vTEME</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">resid</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">orb</span> <span class="o">=</span> <span class="n">Orbit</span><span class="o">.</span><span class="n">fromKozaiMeanKeplerianElements</span><span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">_useTEME</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># stay in TEME frame</span>
            <span class="p">)</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([(</span><span class="n">orb</span><span class="o">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">rTEME</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e4</span><span class="p">,</span> <span class="n">orb</span><span class="o">.</span><span class="n">v</span> <span class="o">-</span> <span class="n">vTEME</span><span class="p">])</span>
            <span class="c1"># print(f&quot;{a:8.4f} {e:8.4f} {i:8.4f} {pa:8.4f} {raan:8.4f} {trueAnomaly:8.4f}&quot;, end=&#39;&#39;)</span>
            <span class="c1"># print(f&quot;  {resid[0]:12.4f} {resid[1]:12.4f} {resid[2]:12.4f} {resid[3]:12.4f} {resid[4]:12.4f} {resid[5]:12.4f}&quot;)</span>
            <span class="k">return</span> <span class="n">resid</span>
        <span class="n">lbounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">ubounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
            <span class="n">resid</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keplerianElements</span><span class="p">),</span>
            <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="n">lbounds</span><span class="p">,</span> <span class="n">ubounds</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Sometimes we seem to get stuck in a local minimum, particularly when</span>
        <span class="c1"># the eccentricity is close to zero.  So check if we&#39;ve reached adequate</span>
        <span class="c1"># convergence, and try a (not-random) restart if not.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">):</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
                <span class="n">resid</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="n">lbounds</span><span class="p">,</span> <span class="n">ubounds</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># One final attempt</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">):</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
                    <span class="n">resid</span><span class="p">,</span>
                    <span class="n">opt</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="n">lbounds</span><span class="p">,</span> <span class="n">ubounds</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span><span class="o">.</span><span class="n">x</span>

<div class="viewcode-block" id="Orbit.fromTLE"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.fromTLE">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromTLE</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sat_name</span><span class="p">,</span> <span class="n">tle_filename</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an Orbit from a TLE file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sat_name : str</span>
<span class="sd">            NORAD name of the satellite</span>
<span class="sd">        tle_filename : str</span>
<span class="sd">            Path and name of file where TLE is</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_tle</span>
        <span class="n">tle</span> <span class="o">=</span> <span class="n">read_tle</span><span class="p">(</span><span class="n">sat_name</span><span class="p">,</span> <span class="n">tle_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromTLETuple</span><span class="p">(</span><span class="n">tle</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="n">propkw</span><span class="p">)</span></div>

<div class="viewcode-block" id="Orbit.fromTLETuple"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.fromTLETuple">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromTLETuple</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tle</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an Orbit from a TLE tuple</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tle : 2-tuple of str</span>
<span class="sd">            Line1 and Line2 of TLE as strings</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">_rvt_from_tle_tuple</span><span class="p">,</span> <span class="n">parse_tle</span>
        <span class="c1"># Should set Kozai elements here directly from TLE.</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">parse_tle</span><span class="p">(</span><span class="n">tle</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">_rvt_from_tle_tuple</span><span class="p">(</span><span class="n">tle</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>  <span class="c1"># 10 microsec</span>
        <span class="c1"># Transform TEME -&gt; GCRF</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">teme_to_gcrf</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">r</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">v</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">EARTH_MU</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">kozaiMeanKeplerianElements</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">raan</span><span class="p">,</span> <span class="n">trueAnomaly</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">propkw</span> <span class="o">=</span> <span class="n">propkw</span> <span class="k">if</span> <span class="n">propkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Orbit.at"><a class="viewcode-back" href="../../api/ssapy.orbit.Orbit.html#ssapy.orbit.Orbit.at">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">_KeplerianPropagator</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propagate this orbit to time t.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float or astropy.time.Time</span>
<span class="sd">            If float, then should correspond to GPS seconds; i.e., seconds since</span>
<span class="sd">            1980-01-06 00:00:00 UTC</span>
<span class="sd">        propagator : Propagator, optional</span>
<span class="sd">            The propagator instance to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Orbit</span>
<span class="sd">            Propagated Orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.compute</span><span class="w"> </span><span class="kn">import</span> <span class="n">rv</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">rv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">propagator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Orbit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">propkw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propkw</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;Orbit(r=</span><span class="si">{!r}</span><span class="s2">, v=</span><span class="si">{!r}</span><span class="s2">, t=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">!=</span> <span class="n">EARTH_MU</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;, mu=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rvFromEquinoctial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lE</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># self is (n,) or scalar</span>
        <span class="c1"># assume lv/lE is always explicitly (n, m)</span>
        <span class="c1"># always return (n, m, 3)</span>
        <span class="c1"># calling code will squeeze</span>
        <span class="c1"># No checks done, but exactly one of lv, lE should be set.</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">lv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">lE</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">wBound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ex2</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span>
            <span class="n">ey2</span> <span class="o">=</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">ex2</span> <span class="o">+</span> <span class="n">ey2</span>
            <span class="n">exey</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ey</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">eta</span>

            <span class="k">if</span> <span class="n">lE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lEb</span> <span class="o">=</span> <span class="n">_ellipticalTrueToEccentricLongitudeMany</span><span class="p">(</span>
                    <span class="n">lv</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lEb</span> <span class="o">=</span> <span class="n">lE</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>

            <span class="n">cLe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lEb</span><span class="p">)</span>
            <span class="n">sLe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lEb</span><span class="p">)</span>
            <span class="n">exCeyS</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span> <span class="o">+</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span>

            <span class="c1"># avoid temporary arrays as much as possible.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">ey2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">exey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span>
            <span class="n">x</span> <span class="o">-=</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">*=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">ex2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">exey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span>
            <span class="n">y</span> <span class="o">-=</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

            <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="n">a</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">exCeyS</span><span class="p">)</span>
            <span class="n">xDot</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">sLe</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exCeyS</span><span class="p">)</span>
            <span class="n">yDot</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">cLe</span> <span class="o">-</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">ex</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exCeyS</span><span class="p">)</span>

            <span class="n">rb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">rb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span>
                <span class="n">xDot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span>
                <span class="n">yDot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># checking if can avoid the array insert below.  The check is almost</span>
            <span class="c1"># free (speedwise), so usually a good idea.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">rb</span><span class="p">,</span> <span class="n">vb</span>
            <span class="n">r</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">rb</span>
            <span class="n">v</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">vb</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
            <span class="c1"># Copy Keplerian formula for the moment; optimize some other day...</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
            <span class="n">lonPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lvub</span> <span class="o">=</span> <span class="n">_hyperbolicTrueToEccentricLongitudeMany</span><span class="p">(</span>
                    <span class="n">lE</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lvub</span> <span class="o">=</span> <span class="n">lv</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lvub</span> <span class="o">-</span> <span class="n">lonPa</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># (n,m)</span>

            <span class="n">sinV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trueAnomaly</span><span class="p">)</span>  <span class="c1"># (n,m)</span>
            <span class="n">cosV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trueAnomaly</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span>  <span class="c1"># (n,)</span>
            <span class="n">posFactor</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cosV</span><span class="p">)</span>  <span class="c1"># (n,m)</span>
            <span class="n">velFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="n">f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># (n,m)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">posFactor</span> <span class="o">*</span> <span class="n">cosV</span>  <span class="c1"># (n,m)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">posFactor</span> <span class="o">*</span> <span class="n">sinV</span>
            <span class="n">xDot</span> <span class="o">=</span> <span class="o">-</span><span class="n">velFactor</span> <span class="o">*</span> <span class="n">sinV</span>
            <span class="n">yDot</span> <span class="o">=</span> <span class="n">velFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosV</span><span class="p">)</span>

            <span class="c1"># r = x*self._pK + y*self._qK</span>
            <span class="c1"># v = xDot*self._pK + yDot*self._qK</span>

            <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lonPa</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lonPa</span><span class="p">)</span>  <span class="c1"># (n,)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>  <span class="c1"># (2, 2, n)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>  <span class="c1"># (2, n, m)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;abc,bcd-&gt;acd&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span>
            <span class="n">rpDot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xDot</span><span class="p">,</span> <span class="n">yDot</span><span class="p">])</span>  <span class="c1"># (2, n, m)</span>
            <span class="n">rpDot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;abc,bcd-&gt;acd&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">rpDot</span><span class="p">)</span>  <span class="c1"># (2, n, m)</span>

            <span class="n">rub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,nt-&gt;nmt&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span><span class="p">))</span>
            <span class="n">rub</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,nt-&gt;nmt&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span><span class="p">))</span>
            <span class="n">vub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,nt-&gt;nmt&quot;</span><span class="p">,</span> <span class="n">rpDot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span><span class="p">))</span>
            <span class="n">vub</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nm,nt-&gt;nmt&quot;</span><span class="p">,</span> <span class="n">rpDot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">rub</span><span class="p">,</span> <span class="n">vub</span>
            <span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">rub</span>
            <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">vub</span>

        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span>

    <span class="c1"># Specialization for parallelizing over orbits</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_rvFromEquinoctialMany</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">pEq</span><span class="p">,</span> <span class="n">qEq</span><span class="p">,</span> <span class="n">lE</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Parallelization over hyperbolic orbits not implemented&quot;</span>
            <span class="p">)</span>
        <span class="n">exey</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ey</span>
        <span class="n">ex2</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">*</span> <span class="n">ex</span>
        <span class="n">ey2</span> <span class="o">=</span> <span class="n">ey</span> <span class="o">*</span> <span class="n">ey</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">ex2</span> <span class="o">+</span> <span class="n">ey2</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e2</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">eta</span>

        <span class="n">cLe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
        <span class="n">sLe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lE</span><span class="p">)</span>
        <span class="n">exCeyS</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span> <span class="o">+</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">ey2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">exey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span> <span class="o">-</span> <span class="n">ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">ex2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sLe</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">exey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cLe</span> <span class="o">-</span> <span class="n">ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span> <span class="o">/</span> <span class="n">a</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">exCeyS</span><span class="p">)</span>
        <span class="n">xDot</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">sLe</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">ey</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exCeyS</span><span class="p">)</span>
        <span class="n">yDot</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">cLe</span> <span class="o">-</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">ex</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exCeyS</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pEq</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">qEq</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">xDot</span><span class="p">,</span> <span class="n">pEq</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">yDot</span><span class="p">,</span> <span class="n">qEq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rvFromKeplerian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trueAnomaly</span><span class="p">):</span>
        <span class="c1"># self is (n,) or scalar</span>
        <span class="c1"># trueAnomaly is (n, m)</span>
        <span class="c1"># always return (n, m, 3); calling code will squeeze</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">trueAnomaly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">wBound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">uME2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">s1Me2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">uME2</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">_ellipticalTrueToEccentricAnomalyMany</span><span class="p">(</span>
                <span class="n">trueAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span>
                <span class="n">e</span>
            <span class="p">)</span>
            <span class="n">cosE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
            <span class="n">sinE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

            <span class="c1"># coordinates of position and velocity in the orbital plane</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cosE</span> <span class="o">-</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sinE</span> <span class="o">*</span> <span class="n">s1Me2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="n">a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cosE</span><span class="p">)</span>
            <span class="n">xDot</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinE</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">yDot</span> <span class="o">=</span> <span class="n">cosE</span> <span class="o">*</span> <span class="n">s1Me2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">rb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pK</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">rb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qK</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">vb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">xDot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pK</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">vb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">yDot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qK</span><span class="p">)[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">r</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">rb</span>
            <span class="n">v</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">vb</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
            <span class="n">sinV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]))</span>
            <span class="n">cosV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">posFactor</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cosV</span><span class="p">)</span>
            <span class="n">velFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="n">f</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">posFactor</span> <span class="o">*</span> <span class="n">cosV</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">posFactor</span> <span class="o">*</span> <span class="n">sinV</span>
            <span class="n">xDot</span> <span class="o">=</span> <span class="o">-</span><span class="n">velFactor</span> <span class="o">*</span> <span class="n">sinV</span>
            <span class="n">yDot</span> <span class="o">=</span> <span class="n">velFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosV</span><span class="p">)</span>

            <span class="n">rub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pK</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">rub</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qK</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">vub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">xDot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pK</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">vub</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ac-&gt;abc&quot;</span><span class="p">,</span> <span class="n">yDot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qK</span><span class="p">)[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">rub</span>
            <span class="n">v</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">vub</span>

        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setEquinoctial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set equinoctial elements from state vectors</span>
        <span class="c1"># Compute semimajor axis</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">normSq</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">rnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">normSq</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">rv2OverMu</span> <span class="o">=</span> <span class="n">rnorm</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>

        <span class="c1"># negative for hyperbolic</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">rnorm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">rv2OverMu</span><span class="p">)</span>
        <span class="n">muA</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>

        <span class="c1"># Compute inclination vector</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">wnormed</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">wnormed</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span> <span class="o">*</span> <span class="n">wnormed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">hy</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">wnormed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute true longitude argument</span>
        <span class="n">cLv</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">r</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">wnormed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">rnorm</span>
        <span class="n">sLv</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span> <span class="o">*</span> <span class="n">r</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">wnormed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">rnorm</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sLv</span><span class="p">,</span> <span class="n">cLv</span><span class="p">)</span>

        <span class="c1"># Compute eccentricity vector</span>
        <span class="c1"># Separate maths for bound/unbound orbits</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">lonPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">wBound</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># bound orbits first</span>
        <span class="n">eS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ab,ab-&gt;a&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">muA</span><span class="p">))</span>
        <span class="n">eC</span> <span class="o">=</span> <span class="n">rv2OverMu</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
            <span class="n">eSE</span> <span class="o">=</span> <span class="n">eS</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">eCE</span> <span class="o">=</span> <span class="n">eC</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">eCE</span> <span class="o">*</span> <span class="n">eCE</span> <span class="o">+</span> <span class="n">eSE</span> <span class="o">*</span> <span class="n">eSE</span>
            <span class="n">e</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">eCE</span> <span class="o">-</span> <span class="n">e2</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="n">eSE</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">cLv</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">sLv</span><span class="p">[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">ex</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">/=</span> <span class="n">rnorm</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">ey</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">sLv</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span> <span class="o">*</span> <span class="n">cLv</span><span class="p">[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">ey</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">/=</span> <span class="n">rnorm</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">lonPa</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ey</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="n">ex</span><span class="p">[</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">trueAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrapToPi</span><span class="p">(</span><span class="n">lv</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">-</span> <span class="n">lonPa</span><span class="p">[</span><span class="n">wBound</span><span class="p">])</span>

        <span class="c1"># now unbound orbits</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
            <span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">normSq</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span> <span class="o">/</span> <span class="n">muA</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">eSH</span> <span class="o">=</span> <span class="n">eS</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">eCH</span> <span class="o">=</span> <span class="n">eC</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
            <span class="n">H</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">eCH</span> <span class="o">+</span> <span class="n">eSH</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">eCH</span> <span class="o">-</span> <span class="n">eSH</span><span class="p">))</span>
            <span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrapToPi</span><span class="p">(</span>
                <span class="n">_hyperbolicEccentricToTrueAnomalyMany</span><span class="p">(</span>
                    <span class="n">H</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">lonPa</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrapToPi</span><span class="p">(</span><span class="n">lv</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">-</span> <span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">ex</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lonPa</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>
            <span class="n">ey</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lonPa</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">])</span>

        <span class="c1"># now populate properties and squeeze as necessary.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hx</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hy</span> <span class="o">=</span> <span class="n">hy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ey</span> <span class="o">=</span> <span class="n">ey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lv</span> <span class="o">=</span> <span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">trueAnomaly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lonPa</span> <span class="o">=</span> <span class="n">lonPa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hx</span> <span class="o">=</span> <span class="n">hx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hy</span> <span class="o">=</span> <span class="n">hy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ey</span> <span class="o">=</span> <span class="n">ey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lv</span> <span class="o">=</span> <span class="n">lv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span> <span class="o">=</span> <span class="n">trueAnomaly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lonPa</span> <span class="o">=</span> <span class="n">lonPa</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setKeplerian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set keplerian elements from state vectors</span>
        <span class="c1"># Let _setEquinoctial take care of setting a, e, trueAnomaly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">normed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">unitAngle3</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]))</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]),</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">raan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">wr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">wr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">_wrapToPi</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lonPa</span><span class="p">)</span> <span class="o">-</span> <span class="n">raan</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">raan</span> <span class="o">=</span> <span class="n">raan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raan</span> <span class="o">=</span> <span class="n">raan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setPQEquinoctial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hx2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span>
        <span class="n">hy2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span>
        <span class="n">hxhy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span>
        <span class="n">factH</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">hx2</span> <span class="o">+</span> <span class="n">hy2</span><span class="p">)</span>

        <span class="c1"># Reference axes defining orbital plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">+</span> <span class="n">hx2</span> <span class="o">-</span> <span class="n">hy2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hxhy</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span><span class="p">])</span> <span class="o">*</span> <span class="n">factH</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hxhy</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hx2</span> <span class="o">+</span> <span class="n">hy2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span><span class="p">])</span> <span class="o">*</span> <span class="n">factH</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setPQKeplerian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cosRaan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raan</span><span class="p">)</span>
        <span class="n">sinRaan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raan</span><span class="p">)</span>
        <span class="n">cosPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">)</span>
        <span class="n">sinPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">)</span>
        <span class="n">cosI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">sinI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">crcp</span> <span class="o">=</span> <span class="n">cosRaan</span> <span class="o">*</span> <span class="n">cosPa</span>
        <span class="n">crsp</span> <span class="o">=</span> <span class="n">cosRaan</span> <span class="o">*</span> <span class="n">sinPa</span>
        <span class="n">srcp</span> <span class="o">=</span> <span class="n">sinRaan</span> <span class="o">*</span> <span class="n">cosPa</span>
        <span class="n">srsp</span> <span class="o">=</span> <span class="n">sinRaan</span> <span class="o">*</span> <span class="n">sinPa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">crcp</span> <span class="o">-</span> <span class="n">cosI</span> <span class="o">*</span> <span class="n">srsp</span><span class="p">,</span> <span class="n">srcp</span> <span class="o">+</span> <span class="n">cosI</span> <span class="o">*</span> <span class="n">crsp</span><span class="p">,</span> <span class="n">sinI</span> <span class="o">*</span> <span class="n">sinPa</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="o">-</span><span class="n">crsp</span> <span class="o">-</span> <span class="n">cosI</span> <span class="o">*</span> <span class="n">srcp</span><span class="p">,</span> <span class="o">-</span><span class="n">srsp</span> <span class="o">+</span> <span class="n">cosI</span> <span class="o">*</span> <span class="n">crcp</span><span class="p">,</span> <span class="n">sinI</span> <span class="o">*</span> <span class="n">cosPa</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_pEq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setPQEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pEq</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_qEq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setPQEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qEq</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_pK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setPQKeplerian</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pK</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_qK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setPQKeplerian</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qK</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Semimajor axis in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;First component of equinoctial inclination vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Second component of equinoctial inclination vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;First component of equinoctial eccentricity vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Second component of equinoctial eccentricity vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True longitude in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lv</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eccentric longitude in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_ellipticalTrueToEccentricLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_hyperbolicTrueToEccentricLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">lE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">lE</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ellipticalTrueToEccentricLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">lE</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hyperbolicTrueToEccentricLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">lE</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean longitude in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_ellipticalEccentricToMeanLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_hyperbolicEccentricToMeanLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">lM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">lM</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ellipticalEccentricToMeanLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lE</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">lM</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hyperbolicEccentricToMeanLongitude</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lE</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">lM</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eccentricity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">)</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">i</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inclination in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setKeplerian</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Periapsis argument in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setKeplerian</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lonPa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Longitude of periapsis argument in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonPa</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">raan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Right ascension of the ascending node in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setKeplerian</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raan</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trueAnomaly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True anomaly in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setEquinoctial</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">eccentricAnomaly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eccentric anomaly in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">eccentricAnomaly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">eccentricAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">eccentricAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">eccentricAnomaly</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">meanAnomaly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean anomaly in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_ellipticalEccentricToMeanAnomaly</span><span class="p">(</span>
                    <span class="n">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_hyperbolicEccentricToMeanAnomaly</span><span class="p">(</span>
                    <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">meanAnomaly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">meanAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ellipticalEccentricToMeanAnomaly</span><span class="p">(</span>
                    <span class="n">_ellipticalTrueToEccentricAnomaly</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">meanAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hyperbolicEccentricToMeanAnomaly</span><span class="p">(</span>
                    <span class="n">_hyperbolicTrueToEccentricAnomaly</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">meanAnomaly</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Orbital period in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanMotion</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">period</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanMotion</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">period</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">return</span> <span class="n">period</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">meanMotion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean motion in radians per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">equinoctialElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Equinoctial elements (a, hx, hy, ex, ey, lv).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lv</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">keplerianElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keplerian elements (a, e, i, pa, raan, trueAnomaly).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trueAnomaly</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Semi-latus rectum in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">angularMomentum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Specific) angular momentum vector in m^2/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(Specific) orbital energy in m^2/s^2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">LRL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Laplace-Runge-Lenz vector in m^3/s^2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">*</span> <span class="n">normed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angularMomentum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">periapsis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Periapsis coordinate of orbit in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="n">pdist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">normed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LRL</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">normed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LRL</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdist</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apoapsis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apoapsis coordinate of orbit in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">adist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">normed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LRL</span><span class="p">)</span> <span class="o">*</span> <span class="n">adist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wBound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">apoapsis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">adist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">[</span><span class="n">wBound</span><span class="p">])</span>
                <span class="n">apoapsis</span><span class="p">[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">normed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LRL</span><span class="p">)[</span><span class="n">wBound</span><span class="p">]</span> <span class="o">*</span> <span class="n">adist</span><span class="p">[</span><span class="n">wBound</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">wBound</span><span class="p">):</span>
                <span class="n">apoapsis</span><span class="p">[</span><span class="o">~</span><span class="n">wBound</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">apoapsis</span>

    <span class="nd">@_lazy_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Two line element for this Orbit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_tle</span>
        <span class="k">return</span> <span class="n">make_tle</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kozaiMeanKeplerianElements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="EarthObserver"><a class="viewcode-back" href="../../api/ssapy.orbit.EarthObserver.html#ssapy.orbit.EarthObserver">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">EarthObserver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An earth-bound observer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon : float</span>
<span class="sd">        Geodetic longitude in degrees (increasing to the East).</span>
<span class="sd">    lat : float</span>
<span class="sd">        Geodetic latitude in degrees.</span>
<span class="sd">    elevation : float, optional</span>
<span class="sd">        Elevation in meters.</span>
<span class="sd">    fast : bool, optional</span>
<span class="sd">        Use fast lookup tables for Earth Orientation parameters.  ~ meter and</span>
<span class="sd">        ~10 micron/sec accurate for dates between approximately 1973 and the</span>
<span class="sd">        present.  Less accurate outside this range.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lon</span>
<span class="sd">    lat</span>
<span class="sd">    elevation</span>
<span class="sd">    itrs : array_like (3,)</span>
<span class="sd">        ITRS coordinates in meters.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    getRV(time)</span>
<span class="sd">        Get position and velocity at specified time(s) in the GCRF frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarthLocation</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="n">elevation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_location</span><span class="o">.</span><span class="n">itrs</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;EarthObserver(lon=</span><span class="si">{!r}</span><span class="s2">, lat=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;, elevation=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elevation</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">_dGHAdt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.002737909350795</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">86400</span>
    <span class="p">)</span>

<div class="viewcode-block" id="EarthObserver.getRV"><a class="viewcode-back" href="../../api/ssapy.orbit.EarthObserver.html#ssapy.orbit.EarthObserver.getRV">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">getRV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get position and velocity at specified time(s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : array_like or astropy.time.Time (n,)</span>
<span class="sd">            If float (array), then should correspond to GPS seconds;</span>
<span class="sd">            i.e., seconds since 1980-01-06 00:00:00 UTC</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : array_like (n, 3)</span>
<span class="sd">            Position in meters.</span>
<span class="sd">        v : array_like (n, 3)</span>
<span class="sd">            Velocity in meters per second.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The returned position and velocity are in the GCRF frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gps</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mjd_tt</span> <span class="o">=</span> <span class="n">_gpsToTT</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">d_ut1_tt_mjd</span><span class="p">,</span> <span class="n">pmx</span><span class="p">,</span> <span class="n">pmy</span> <span class="o">=</span> <span class="n">iers_interp</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">pn</span> <span class="o">=</span> <span class="n">erfa</span><span class="o">.</span><span class="n">pnm80</span><span class="p">(</span><span class="mf">2400000.5</span><span class="p">,</span> <span class="n">mjd_tt</span><span class="p">)</span>
            <span class="n">gst</span> <span class="o">=</span> <span class="n">erfa</span><span class="o">.</span><span class="n">gst94</span><span class="p">(</span><span class="mf">2400000.5</span><span class="p">,</span> <span class="n">mjd_tt</span> <span class="o">+</span> <span class="n">d_ut1_tt_mjd</span><span class="p">)</span>
            <span class="n">cg</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gst</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gst</span><span class="p">)</span>
            <span class="n">gstMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">gstMat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg</span>
            <span class="n">gstMat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg</span>
            <span class="n">gstMat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sg</span>
            <span class="n">gstMat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg</span>
            <span class="n">gstMat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">polar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">polar</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">polar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmx</span>
            <span class="n">polar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pmy</span>
            <span class="n">polar</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pmx</span>
            <span class="n">polar</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmy</span>

            <span class="n">U</span> <span class="o">=</span> <span class="n">gstMat</span> <span class="o">@</span> <span class="n">pn</span>
            <span class="n">outR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">polar</span> <span class="o">@</span> <span class="n">U</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">itrs</span>
            <span class="n">outV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">polar</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dGHAdt</span> <span class="o">@</span> <span class="n">U</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">itrs</span>

            <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">outR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">outR</span><span class="p">,</span> <span class="n">outV</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gps&#39;</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_location</span><span class="o">.</span><span class="n">get_gcrs_posvel</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="EarthObserver.sunAlt"><a class="viewcode-back" href="../../api/ssapy.orbit.EarthObserver.html#ssapy.orbit.EarthObserver.sunAlt">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sunAlt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Sun altitude for observer at `time`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : array_like or astropy.time.Time (n,)</span>
<span class="sd">            If float (array), then should correspond to GPS seconds;</span>
<span class="sd">            i.e., seconds since 1980-01-06 00:00:00 UTC</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        alt : array_like(n,)</span>
<span class="sd">            Altitude of sun in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gps</span>
        <span class="n">ro</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRV</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">r_sun</span> <span class="o">=</span> <span class="n">sunPos</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">r_sun</span> <span class="o">-</span> <span class="n">ro</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">unitAngle3</span><span class="p">(</span><span class="n">normed</span><span class="p">(</span><span class="n">ro</span><span class="p">),</span> <span class="n">normed</span><span class="p">(</span><span class="n">dr</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="OrbitalObserver"><a class="viewcode-back" href="../../api/ssapy.orbit.OrbitalObserver.html#ssapy.orbit.OrbitalObserver">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">OrbitalObserver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An observer in orbit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orbit : Orbit</span>
<span class="sd">        The orbit of the observer.</span>
<span class="sd">    propagator : Propagator, optional</span>
<span class="sd">        The propagator instance to use.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    orbit</span>
<span class="sd">    propagator</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    getRV(time)</span>
<span class="sd">        Get position and velocity at specified time(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbit</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="n">_KeplerianPropagator</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbit</span> <span class="o">=</span> <span class="n">orbit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="o">=</span> <span class="n">propagator</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;OrbitalObserver(</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="o">!=</span> <span class="n">_KeplerianPropagator</span><span class="p">():</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;, propagator=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="OrbitalObserver.getRV"><a class="viewcode-back" href="../../api/ssapy.orbit.OrbitalObserver.html#ssapy.orbit.OrbitalObserver.getRV">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">getRV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get position and velocity at specified time(s).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : array_like or astropy.time.Time (n,)</span>
<span class="sd">            If float (array), then should correspond to GPS seconds;</span>
<span class="sd">            i.e., seconds since 1980-01-06 00:00:00 UTC</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : array_like (n, 3)</span>
<span class="sd">            Position in meters.</span>
<span class="sd">        v : array_like (n, 3)</span>
<span class="sd">            Velocity in meters per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.compute</span><span class="w"> </span><span class="kn">import</span> <span class="n">rv</span>
        <span class="k">return</span> <span class="n">rv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbit</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Lawrence Livermore National Security, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>